# GPG Keys for Repository Metadata Signing

[Packagecloud](https://packagecloud.io), the application that powers packages.gitlab.com, supports two different types of GPG signatures: **packages** and **repository metadata**.

This document is concerned with **repository metadata signing** keys. For package signing, see [manage package signing keys](../packaging/manage-package-signing-keys.md).

## Repository Metadata

Packagecloud signs repository metadata using a private key that is either generated by Packagecloud or generated
externally and configured in the app. This is a security feature that gives our users certainty that the repository
metadata was generated by us.

We manage the key externally so we provide the private key to Packagecloud using a Kubernetes secret. This secret is
synced from Vault, which is ultimately where the key lives and where any changes need to take place.
Read on to find out how to make changes to the key (e.g., due to expiry extension or key rotation).

## Location of the Key

The private key lives in [Vault](https://vault.gitlab.net) under the path `k8s/ops-gitlab-gke/packagecloud/gpg`.

## Generating or extending the expiry on an existing key

Irrespective of whether you're generating or extending the key, don't forget to [cleanup after yourself](../packaging/manage-package-signing-keys.md#purging-local-copies)!

### Generating the GPG Keys Pair

If you need to generate a GPG key pair, see [this section](../packaging/manage-package-signing-keys.md#generating-the-gpg-keys-pair).

### Extending Key Expiration

If, instead of generating a GPG key pair, you need to extend the expiry on an existing key, see [this section](../packaging/manage-package-signing-keys.md#extending-key-expiration).

## Updating Packagecloud with the new/updated key

Once you've exported your new private key (or extended the expiry on an existing one), you need to tell Packagecloud to
use it. There is no need to tell Packagecloud about the _public_ key as it's part of the container bootstrap to do a GPG
public key export, which is placed in the right directory so it's downloadable via
<https://packages.gitlab.com/gpg.key>.

### Update Vault

As a member of the distribution team:

1. Open <https://vault.gitlab.net> and sign-in using Okta
1. Head to the path: `k8s/ops-gitlab-gke/packagecloud/gpg`
1. Click on _Create new version_
1. Update the value of `private_key` with the contents of your exported private key
1. Click _Save_
1. Take note of the `version` of the secret (next to _Create new version_). You'll need this next!

### Update gitlab-helmfiles

Now we need to tell the Packagecloud deployments to use this new updated secret, so you'll need to make the following changes:

1. Update version to the new version number from the previous
   step:
   [here](https://gitlab.com/gitlab-com/gl-infra/k8s-workloads/gitlab-helmfiles/-/blob/0b89319cf24f82bdeb978b9d6f101f7c7d73483c/releases/packagecloud/values-secrets/ops.yaml.gotmpl#L75)
   and [here](https://gitlab.com/gitlab-com/gl-infra/k8s-workloads/gitlab-helmfiles/-/blob/0b89319cf24f82bdeb978b9d6f101f7c7d73483c/releases/packagecloud/values-secrets/ops.yaml.gotmpl#L86)
1. Update `secretName` to match: [here](https://gitlab.com/gitlab-com/gl-infra/k8s-workloads/gitlab-helmfiles/-/blob/0b89319cf24f82bdeb978b9d6f101f7c7d73483c/releases/packagecloud/ops.yaml.gotmpl#L64)

File an MR with the above changes and have someone in `#infrastructure-lounge` review/approve/merge it for you.

### Validation

Once the `gitlab-helmfiles` CI pipeline has finished, you're ready to do a quick test:

```sh
$ curl -s https://packages.gitlab.com/gpg.key | gpg --show-key
pub   rsa4096 2020-03-02 [SC] [expires: 2024-03-01]
      F6403F6544A38863DAA0B6E03F01618A51312F3F
uid                      GitLab B.V. (package repository signing key) <packages@gitlab.com>
sub   rsa4096 2020-03-02 [E] [expires: 2024-03-01]
```

Check that the fingerprint & expiry matches your new/extended key.
