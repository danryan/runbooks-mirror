# component_saturation_slo_out_of_bounds:pgbouncer_single_core

**Table of Contents**

[TOC]

## Overview

The `pgbouncer_single_core` metric measures the total CPU usage by PGBouncer process. PGBouncer is a single threaded application, so if the process fully consumes CPU, a resource may become saturated. This may cause slowness or timeouts on the DB requests. As a result additional pgbouncer nodes may need to be provisioned.

This alert can cause a high Severity incident and needs to be investigated.

## Services

- [Service Overview](https://gitlab.com/gitlab-com/runbooks/-/tree/master/docs/pgbouncer)
- Team that owns the service: [Core Platform:Database Group](https://handbook.gitlab.com/handbook/engineering/infrastructure/core-platform/data_stores/database/)
- **Label:** gitlab-com/gl-infra/production~"Service::Pgbouncer"

## Metrics

- The [alert temlpate expression](https://gitlab.com/gitlab-com/runbooks/-/blob/master/libsonnet/saturation-monitoring/pgbouncer_single_core.libsonnet#L19) measures the total CPU usage by PGBouncer process. This template is used to auto-generate alert templates for different environments and Service type (Patroni or Pgbouncer)
- Generated alert measures the CPU usage rate of pgbouncer processes, then sums this usage across CPUs and modes and clamps the result between 0 and 1 (0-100% CPU usage). Examples of generated alerts [for Patroni](https://gitlab.com/gitlab-com/runbooks/-/blob/master/mimir-rules/gitlab-gprd/patroni/autogenerated-gitlab-gprd-patroni-saturation-alerts.yml#L1538) and [for Pgbouncer](https://gitlab.com/gitlab-com/runbooks/-/blob/master/mimir-rules/gitlab-gprd/pgbouncer/autogenerated-gitlab-gprd-pgbouncer-saturation-alerts.yml#L654)
- The alert has [soft and hard SLO defined](https://gitlab.com/gitlab-com/runbooks/-/blob/master/libsonnet/saturation-monitoring/pgbouncer_single_core.libsonnet?ref_type=heads#L26)

## Alert Behavior

- This alert [should be rare](https://nonprod-log.gitlab.net/app/r/s/LA632), but if it's triggered, needs to be investigated immediately

## Severities

- This alert might create S2 incidents
- There might be many gitlab.com users affected as the requrest to backend DB may be delayed
- Review [Incident Severity Handbook](https://handbook.gitlab.com/handbook/engineering/infrastructure/incident-management/#incident-severity) page to identify the required Severity Level

## Verification

Under normal conditions the saturation is expected to be as small as possible. The closer the saturation to 1, the higher the load and new additional nodes are required to be provisioned.

- [Grafana Mimir Explore query for "patroni" service type in "gprd" environment](https://dashboards.gitlab.net/explore?schemaVersion=1&panes=%7B%221lg%22:%7B%22datasource%22:%22e58c2f51-20f8-4f4b-ad48-2968782ca7d6%22,%22queries%22:%5B%7B%22refId%22:%22A%22,%22expr%22:%22max%20by%28environment,%20tier,%20type,%20stage,%20shard,%20fqdn,%20groupname%29%20%28%5Cn%20%20%20%20%20%20%20%20%20%20clamp_min%28%5Cn%20%20%20%20%20%20%20%20%20%20%20%20clamp_max%28%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20sum%20without%28cpu,%20mode%29%20%28%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20rate%28%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20namedprocess_namegroup_cpu_seconds_total%7Bgroupname%3D~%5C%22pgbouncer.%2A%5C%22,%20environment%3D%5C%22gprd%5C%22,type%3D%5C%22patroni%5C%22%7D%5B5m%5D%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%29%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%29%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20,%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%201%29%5Cn%20%20%20%20%20%20%20%20%20%20,%5Cn%20%20%20%20%20%20%20%20%20%200%29%5Cn%20%20%20%20%20%20%20%20%29%5Cn%22,%22range%22:true,%22instant%22:true,%22datasource%22:%7B%22type%22:%22prometheus%22,%22uid%22:%22e58c2f51-20f8-4f4b-ad48-2968782ca7d6%22%7D,%22editorMode%22:%22code%22,%22legendFormat%22:%22__auto%22%7D%5D,%22range%22:%7B%22from%22:%22now-1h%22,%22to%22:%22now%22%7D%7D%7D&orgId=1)
- [Grafana Mimir Explore query for "pgbouncer" service type in "gprd" environment](https://dashboards.gitlab.net/explore?schemaVersion=1&panes=%7B%221lg%22:%7B%22datasource%22:%22e58c2f51-20f8-4f4b-ad48-2968782ca7d6%22,%22queries%22:%5B%7B%22refId%22:%22A%22,%22expr%22:%22max%20by%28environment,%20tier,%20type,%20stage,%20shard,%20fqdn,%20groupname%29%20%28%5Cn%20%20%20%20%20%20%20%20%20%20clamp_min%28%5Cn%20%20%20%20%20%20%20%20%20%20%20%20clamp_max%28%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20sum%20without%28cpu,%20mode%29%20%28%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20rate%28%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20namedprocess_namegroup_cpu_seconds_total%7Bgroupname%3D~%5C%22pgbouncer.%2A%5C%22,%20environment%3D%5C%22gprd%5C%22,type%3D%5C%22pgbouncer%5C%22%7D%5B5m%5D%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%29%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%29%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20,%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%201%29%5Cn%20%20%20%20%20%20%20%20%20%20,%5Cn%20%20%20%20%20%20%20%20%20%200%29%5Cn%20%20%20%20%20%20%20%20%29%5Cn%22,%22range%22:true,%22instant%22:true,%22datasource%22:%7B%22type%22:%22prometheus%22,%22uid%22:%22e58c2f51-20f8-4f4b-ad48-2968782ca7d6%22%7D,%22editorMode%22:%22code%22,%22legendFormat%22:%22__auto%22%7D%5D,%22range%22:%7B%22from%22:%22now-1h%22,%22to%22:%22now%22%7D%7D%7D&orgId=1)

## Recent changes

- [Closed production issues for Pgbouncer Service](https://gitlab.com/gitlab-com/gl-infra/production/-/issues/?sort=created_date&state=all&label_name%5B%5D=Service%3A%3APgbouncer&first_page_size=20)

## Troubleshooting

- [Pgbouncer Service Overview Dashboard](https://dashboards.gitlab.net/d/pgbouncer-main/pgbouncer3a-overview?orgId=1)
- [Pgbouncer Runbook docs](https://gitlab.com/gitlab-com/runbooks/-/blob/master/docs/pgbouncer)
- [Adding a new Pgbouncer instance](https://gitlab.com/gitlab-com/runbooks/-/blob/master/docs/pgbouncer/pgbouncer-add-instance.md)
- [Pgbouncer connection management and troubleshooting](https://gitlab.com/gitlab-com/runbooks/-/blob/master/docs/pgbouncer/pgbouncer-connections.md?ref_type=heads)

## Possible Resolutions

- [Previous component_saturation_slo_out_of_bounds:pgbouncer_single_core incidents](hhttps://gitlab.com/gitlab-com/gl-infra/production/-/issues/?sort=created_date&state=closed&label_name%5B%5D=Service%3A%3APgbouncer&first_page_size=20)

## Dependencies

- There are no external or internal dependencies for this alert

# Escalation

For escalation contact the following channels:

- [#database](https://gitlab.enterprise.slack.com/archives/C3NBYFJ6N)
- [Database Team escalation Handbook](https://handbook.gitlab.com/handbook/engineering/infrastructure/core-platform/data_stores/help/#for-ongoing-gitlabcom-or-dedicated-incidents)

Alternative slack channels:

- [#production_engineering](https://gitlab.enterprise.slack.com/archives/C03QC5KNW5N)
- [#infrastructure-lounge](https://gitlab.enterprise.slack.com/archives/CB3LSMEJV)

# Definitions

- [Alert definition template](https://gitlab.com/gitlab-com/runbooks/-/blob/master/libsonnet/saturation-monitoring/pgbouncer_single_core.libsonnet)
- [Edit this playbook](https://gitlab.com/gitlab-com/runbooks/-/blob/master/docs/pgbouncer/alerts/pgbouncer_single_core.md)
- [Update the template used to format this playbook](https://gitlab.com/gitlab-com/runbooks/-/edit/master/docs/template-alert-playbook.md?ref_type=heads)

# Related Links

- [Related alerts](https://gitlab.com/gitlab-com/runbooks/-/tree/master/docs/pgbouncer/alerts)
- [Pgbouncer Runbook docs](https://gitlab.com/gitlab-com/runbooks/-/blob/master/docs/pgbouncer)
- [Alert definition template](https://gitlab.com/gitlab-com/runbooks/-/blob/master/libsonnet/saturation-monitoring/pgbouncer_single_core.libsonnet?ref_type=heads)
- [Update the template used to format this playbook](https://gitlab.com/gitlab-com/runbooks/-/edit/master/docs/template-alert-playbook.md?ref_type=heads)
