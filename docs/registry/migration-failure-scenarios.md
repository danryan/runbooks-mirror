## Deployment/Migration Failure Scenarios

This document lists and describes all the identified possible failure scenarios when [deploying and migrating to the new version of the container registry for GitLab.com](https://gitlab.com/groups/gitlab-org/-/epics/5523).

Please see the [architecture blueprint](https://docs.gitlab.com/ee/architecture/blueprints/container_registry_metadata_database/) and the [gradual migration plan](https://gitlab.com/gitlab-org/container-registry/-/issues/374) for additional context.

| Scenario | Point of Failure               | Failure                         | Impact                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | Expected App Behavior on Failure                                                                                                                                                                                                                                                                              | Observability                                                                                                                           | Recovery Definition                                                            | Expected App Behavior on Recovery                                                                              | Mitigation                                                                                                                | Possible Corrective Actions                                                                             |
|----------|--------------------------------|---------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------|
| 1        | Database Cluster               | Primary server failure          | - API unable to serve all `POST`/`PUT`/`PATCH`/`DELETE` requests ([4%]() of all traffic). **Note:** During [Phase 1](https://gitlab.com/gitlab-org/container-registry/-/issues/374#phase-1-the-metadata-db-serves-new-repositories), only requests that target *new* repositories can be affected;<br />- API unable to serve all `GET`/`HEAD` requests ([96%]() of all traffic). The impact will change once we deliver *active* database load-balancing (routing reads to a secondary server). **Note:** During [Phase 1](https://gitlab.com/gitlab-org/container-registry/-/issues/374#phase-1-the-metadata-db-serves-new-repositories), only requests that target *new* repositories can be affected;<br />- GC unable to process tasks. | API and GC handle refused or timed out database connections gracefully. <br />Connections are retried once (at the database driver level). In case of failure, connections are discarded and requests halted with a `503 Service Unavailable` response.<br />A new request leads to a new connection attempt. | Errors show up in Sentry and logs. <br />Grafana dashboards reflect the impact scale.                                                   | Primary server is back online. Either the same instance or a promoted replica. | API and GC resume operations normally, without external intervention.                                          | Re-establish normal operation of database cluster/network.                                                                | - Database cluster deployment adjustments;<br />- Escalation to development in case of odd use pattern. |
| 2        | Database Cluster               | Single secondary server failure | NA<br />Need to be revisited once we deliver active database load-balancing.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | NA                                                                                                                                                                                                                                                                                                            | NA                                                                                                                                      | NA                                                                             | NA                                                                                                             | NA                                                                                                                        | NA                                                                                                      |
| 3        | Database Cluster               | Secondary servers failure       | NA<br />Need to be revisited once we deliver active database load-balancing.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | NA                                                                                                                                                                                                                                                                                                            | NA                                                                                                                                      | NA                                                                             | NA                                                                                                             | NA                                                                                                                        | NA                                                                                                      |
| 4        | Database Cluster / Application | Connection pool saturation      | - API unable to serve requests;<br />- GC unable to process tasks.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | API and/or GC fails to pull a connection from a pool at any given time.<br />API requests will timeout with a `500 Internal Server Error` response.                                                                                                                                                            | Errors show up in Sentry and logs. <br />Grafana dashboards reflect the magnitude of the impact on the API and pool saturation metrics. | Connection pool is no longer saturated.                                        | API and GC resume operations normally. External intervention may be required.                                  | Increase connection pool limits on application/PGBouncer if it is due to a legitimate traffic increase.<br />What if not? | Adjust connection pool limits on application/PGBouncer.                                                 |
| 5        | Database Cluster / Application | Excessive Latency               | - Drop on API request and GC run rates;<br />- A portion of API requests and GC runs may timeout.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | API requests and GC runs may timeout with a `500 Internal Server Error` response.                                                                                                                                                                                                                             | Errors show up in Sentry and logs. <br />Grafana dashboards reflect the impact scale.                                                   | Latency is back to normal levels.                                              | API and GC resume operations normally, without external intervention.                                          | Re-establish normal operation of database cluster/network.                                                                | Escalation to development in case of odd use pattern.                                                   |
| 6        | Application                    | Any fatal error during a GC run | - Tasks fail to be processed;<br />- GC queues size may increase if it's not a transient error.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | GC attempts to postpone the review of the task to a future date. If failed, the original review date remains unchanged (no impact).<br />The GC workers should backoff exponentially for every failed run, up to the maximum configured duration (24h by default).                                                    | Errors show up in Sentry and logs. <br />Grafana dashboards reflect the magnitude of the impact on the Online GC dashboard.             | Normal operation re-established. Root cause mitigated.                         | GC workers resume normal operation. The next run will happen automatically after the last exponential backoff. |                                                                                                                           | Escalation to development in case of error unrelated to database/storage connection failures.        |



