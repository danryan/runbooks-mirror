# AiGatewayServiceRunwayIngressTrafficCessationRegional

**Table of Contents**

[TOC]

## Overview

- This alert is designed to detect an abnormal cessation of traffic to the runway_ingress component of the ai-gateway service in any US region. The conditions ensure that the service was receiving a non-zero amount of traffic one hour ago and has since dropped to zero traffic over the last 30 minutes.

- This could be caused by a change to the metrics used in the SLI, or by the service not receiving traffic.

## Services

- [AI-Gateway service overview](https://gitlab.com/gitlab-com/runbooks/-/tree/master/docs/ai-gateway?ref_type=heads)
- Team that owns the service: [AI Framework](https://handbook.gitlab.com/handbook/engineering/development/data-science/ai-powered/ai-framework/)

## Metrics

- In the alert AiGatewayServiceRunwayIngressTrafficCessationRegional, the metric used is gitlab_regional_sli_ops:rate_30m. This metric measures the rate of HTTP requests to the runway_ingress component of the ai-gateway service. It is measured in average number of HTTP requests per second over the last 5 minutes, averaged over 30 minutes.
[Link to metric catalogue](https://gitlab.com/gitlab-com/runbooks/-/blob/master/mimir-rules/runway/ai-gateway/autogenerated-runway-ai-gateway-service-level-alerts.yml#L937)

## Alert Behavior

- To silence the alert , please visit [Alert Manger Dashboard](https://alerts.gitlab.net/#/alerts?silenced=false&inhibited=false&active=true&filter=%7Balertname%3D%22AiGatewayServiceRunwayIngressTrafficCessationRegional%22%7D)
- Till only recently this was a high volume alert in particular because non-us regions having zero traffic is not unlikely but now that we only track us regions this alert is expected to be rare
- Historical trends of the alert firing [here]("https://nonprod-log.gitlab.net/app/discover#/?_g=(filters:!(('$state':(store:globalState),meta:(alias:!n,disabled:!f,field:alert_labels.alertname.keyword,index:b35d9ca0-6c67-11eb-968b-c18082d502f4,key:alert_labels.alertname.keyword,negate:!f,params:(query:AiGatewayServiceRunwayIngressTrafficCessationRegional),type:phrase),query:(match_phrase:(alert_labels.alertname.keyword:AiGatewayServiceRunwayIngressTrafficCessationRegional)))),refreshInterval:(pause:!t,value:0),time:(from:now-1y%2Fd,to:now))&_a=(columns:!(message,stage,type,source,username,alert_labels.alertname),filters:!(),index:b35d9ca0-6c67-11eb-968b-c18082d502f4,interval:auto,query:(language:kuery,query:'alert_labels.alertname.keyword%20:%20%22AiGatewayServiceRunwayIngressTrafficCessationRegional%22'),sort:!(!(time,asc)))")

## Severities

- This alert might create S3 incidents.
- There might be some gitlab.com users impact
- Review [Incident Severity Handbook](https://handbook.gitlab.com/handbook/engineering/infrastructure/incident-management/#incident-severity) page to identify the required Severity Level

## Verification

- [Prometheus link to query that triggered the alert](https://dashboards.gitlab.net/explore?schemaVersion=1&panes=%7B%22pum%22:%7B%22datasource%22:%22mimir-runway%22,%22queries%22:%5B%7B%22refId%22:%22A%22,%22expr%22:%22gitlab_regional_sli_ops:rate_30m%7Bcomponent%3D%5C%22runway_ingress%5C%22,location%3D%5C%22%5C%22,monitor%3D%5C%22global%5C%22,region%3D~%5C%22us-.%2A%5C%22,stage%3D%5C%22main%5C%22,type%3D%5C%22ai-gateway%5C%22%7D%20%3D%3D%200%5Cnand%5Cngitlab_regional_sli_ops:rate_30m%7Bcomponent%3D%5C%22runway_ingress%5C%22,location%3D%5C%22%5C%22,monitor%3D%5C%22global%5C%22,region%3D~%5C%22us-.%2A%5C%22,stage%3D%5C%22main%5C%22,type%3D%5C%22ai-gateway%5C%22%7D%20offset%201h%20%3E%3D%200.16666666666666666%22,%22range%22:true,%22instant%22:true,%22datasource%22:%7B%22type%22:%22prometheus%22,%22uid%22:%22mimir-runway%22%7D,%22editorMode%22:%22code%22,%22legendFormat%22:%22__auto%22%7D%5D,%22range%22:%7B%22from%22:%22now-1h%22,%22to%22:%22now%22%7D%7D%7D&orgId=1)
- [AI Gateway Service Overview Dashboard](https://dashboards.gitlab.net/d/ai-gateway-main/ai-gateway3a-overview?orgId=1)
- [MLOps logging](https://log.gprd.gitlab.net/app/r/s/FoKJ8)

## Recent changes

- [Recent AI-gateway Production Change/Incident Issues](https://gitlab.com/gitlab-com/gl-infra/production/-/issues/?sort=created_date&state=all&label_name%5B%5D=Service%3A%3AAiGateway&first_page_size=100)
- [Recent chef-repo Changes](https://gitlab.com/gitlab-com/gl-infra/chef-repo/-/merge_requests?scope=all&state=merged)
- [Recent k8s-workloads Changes](https://gitlab.com/gitlab-com/gl-infra/k8s-workloads/gitlab-com/-/merge_requests?scope=all&state=merged)

## Troubleshooting

- First step should be to verify if it is a false alarm , if not the cessation could be caused by Service not receiving traffic due to saturation of
  - [Memory Utilization](https://dashboards.gitlab.net/d/ai-gateway-main/ai-gateway3a-overview?orgId=1&from=now-1h&to=now&viewPanel=377718254)
  - [CPU Utilization](https://dashboards.gitlab.net/d/ai-gateway-main/ai-gateway3a-overview?orgId=1&from=now-1h&to=now&viewPanel=1050857443)
  - [Instance Utilization](https://dashboards.gitlab.net/d/ai-gateway-main/ai-gateway3a-overview?orgId=1&from=now-1h&to=now&viewPanel=1738137433)
  - [Concurency Utilization](https://dashboards.gitlab.net/d/ai-gateway-main/ai-gateway3a-overview?orgId=1&from=now-1h&to=now&viewPanel=4285373877)
  - [Vertex AI API Quota Limit](https://dashboards.gitlab.net/d/ai-gateway-main/ai-gateway3a-overview?orgId=1&from=now-1h&to=now&viewPanel=1515902021)

It might also be helpful to look out for recent changes made to the service or recent ongoing issues, a quick look at the [dashboard](https://dashboards.gitlab.net/d/ai-gateway-main/ai-gateway3a-overview?orgId=1) to check if a recent deployed caused it.

If a recent deployment/change caused this issue consider rolling back , we can revert the MR, or re-run the previous deployment job

- AI Gateway uses [capacity planning](https://about.gitlab.com/handbook/engineering/infrastructure/capacity-planning/) provided by Runway for long-term forecasting of saturation resources. To view forecasts, refer to [Tamland page](https://gitlab-com.gitlab.io/gl-infra/capacity-planning-trackers/gitlab-com/service_groups/ai-gateway/).

## Possible Resolutions

- Consider rolling back to a previous working version of the AI Gateway

## Dependencies

- [Anthropic API](https://status.anthropic.com/)
- [GCP Vertex](https://status.cloud.google.com/)

# Escalation

- If the outage is due to a Google Cloud issue, you will need to open a support ticket via the [web console](https://console.cloud.google.com/)
- If the outage is due to an Anthropic issue, reach to `#ext-anthropic` on Slack
- For investigation and resolution assistance, reach to `#g_ai_framework` on Slack

# Definitions

- [Review the alert here](https://gitlab.com/gitlab-com/runbooks/-/blob/3bb66ac18ff818913386805b9b4b1fd9e6de2393/mimir-rules/runway/ai-gateway/autogenerated-runway-ai-gateway-service-level-alerts.yml#L937)
- [Tune the alert here](https://gitlab.com/gitlab-com/runbooks/-/blob/master/mimir-rules-jsonnet/service-component-alerts.jsonnet)
- [Update the template used to format this playbook](https://gitlab.com/gitlab-com/runbooks/-/edit/master/docs/template-alert-playbook.md?ref_type=heads)

# Related Links

- [Related alerts](https://gitlab.com/gitlab-com/runbooks/-/blob/master/docs/ai-gateway/alerts/)
- [AI Gateway Runbook docs](https://gitlab.com/gitlab-com/runbooks/-/blob/master/docs/ai-gateway)
- [Update the template used to format this playbook](https://gitlab.com/gitlab-com/runbooks/-/edit/master/docs/template-alert-playbook.md?ref_type=heads)
