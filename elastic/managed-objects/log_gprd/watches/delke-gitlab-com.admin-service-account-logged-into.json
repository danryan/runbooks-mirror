{
    "trigger": {
        "schedule": {
            "interval": "5m"
        }
    },
    "input": {
        "search": {
            "request": {
                "search_type": "query_then_fetch",
                "indices": [
                    "pubsub-rails-inf-gprd-*"
                ],
                "types": [],
                "body": {
                    "query": {
                        "bool": {
                            "minimum_should_match": 1,
                            "must": [
                                {
                                    "match_phrase": {
                                        "json.path.keyword": "/users/sign_in"
                                    }
                                },
                                {
                                    "match_phrase": {
                                        "json.controller.keyword": "SessionsController"
                                    }
                                },
                                {
                                    "match_phrase": {
                                        "json.method.keyword": "POST"
                                    }
                                },
                                {
                                    "term": {
                                        "json.status": 302
                                    }
                                },
                                {
                                    "range": {
                                        "@timestamp": {
                                            "from": "now-5m",
                                            "to": "now"
                                        }
                                    }
                                }
                            ],
                            "should": [
                                {
                                    "match_phrase": {
                                        "json.username.keyword": "cogbot"
                                    }
                                },
                                {
                                    "match_phrase": {
                                        "json.username.keyword": "gitlab-securitybot"
                                    }
                                },
                                {
                                    "match_phrase": {
                                        "json.username.keyword": "gitlab-it-opsbot"
                                    }
                                },
                                {
                                    "match_phrase": {
                                        "json.username.keyword": "gitlab-it-ops-bot-shared"
                                    }
                                },
                                {
                                    "match_phrase": {
                                        "json.username.keyword": "gl-support-bot-admin"
                                    }
                                },
                                {
                                    "match_phrase": {
                                        "json.username.keyword": "gitlab-bot"
                                    }
                                },
                                {
                                    "match_phrase": {
                                        "json.username.keyword": "employment-bot"
                                    }
                                },
                                {
                                    "match_phrase": {
                                        "json.username.keyword": "gitlab-service"
                                    }
                                }
                            ]
                        }
                    }
                }
            }
        }
    },
    "condition": {
        "compare": {
            "ctx.payload.hits.total": {
                "gt": 0
            }
        }
    },
    "actions": {
        "process-alert": {
            "webhook": {
                "scheme": "https",
                "host": "us-central1-delke-prd.cloudfunctions.net",
                "port": 443,
                "method": "post",
                "path": "/delke-prd-slack-notification",
                "params": {
                    "action": "alert"
                },
                "headers": {
                    "content-type": "application/json",
                    "accept": "application/json,*/*"
                },
                "body": "{{#toJson}}ctx{{/toJson}}"
            }
        }
    },
    "metadata": {
        "output": {
            "instance": "InfraELK",
            "ip": "{{json.remote_ip}}",
            "botUsername": "{{json.username}}"
        },
        "info": {
            "name": "gitlab-com.admin-service-account-logged-into.json",
            "description": "A high-privileged gitLab.com bot has been logged into",
            "definition": "https://gitlab.com/gitlab-com/gl-security/secops/detection/delke/blob/master/alerts/gitlab-com/gitlab-com.admin-service-account-logged-into.json",
            "istest": false
        }
    }
}









