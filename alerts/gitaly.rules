gitaly:grpc_server_handled_total:error_max_rate1m = max(gitaly:grpc_server_handled_total:error_rate1m)
gitaly:grpc_server_handled_total:instance_error_max_rate1m = max(gitaly:grpc_server_handled_total:instance_error_rate1m)

## Gitaly error rate per method
ALERT gitaly_error_rate_too_high
  IF gitaly:grpc_server_handled_total:error_max_rate1m > 2
  FOR 5m
  LABELS {severity="critical", channel="gitaly"}
  ANNOTATIONS {
    title="Gitaly error rate is too high: {{$value | printf \"%.2f\" }}",
    description="Gitaly error rate for the last 5 minutes is over 2 for {{$labels.grpc_method}}. Check Gitaly logs and consider disabling that method.",
    runbook="troubleshooting/gitaly-error-rate.md"
  }

## Gitaly error rate per instance
ALERT gitaly_error_rate_too_high
  IF gitaly:grpc_server_handled_total:instance_error_max_rate1m > 2
  FOR 5m
  LABELS {severity="critical", channel="gitaly"}
  ANNOTATIONS {
    title="Gitaly error rate is too high: {{$value | printf \"%.2f\" }}",
    description="Gitaly error rate for the last 5 minutes is over 2 on {{$labels.instance}}. Check Gitaly logs and consider disabling it on that host.",
    runbook="troubleshooting/gitaly-error-rate.md"
  }


## Gitaly Down
ALERT GitalyFileServerDown
  IF up{job="gitaly-production", tier="stor", type="gitaly"} == 0
  FOR 1m
  LABELS {severity="critical", channel="gitaly"}
  ANNOTATIONS {
    title="Gitaly is down on {{ $labels.fqdn }}",
    description="Gitaly has been marked as down for the past minute on {{$labels.instance}}. Check Gitaly logs and restart the process if necessary",
    runbook="troubleshooting/gitaly-down.md"
  }

## Gitaly File Server CPU Usage
ALERT GitalyFileServerCPUUsage
  IF avg(process_cpu_seconds_total:rate1m{job="gitaly-production", tier="stor", type="gitaly"}) by (fqdn) / avg(instance:node_cpus:count{tier="stor", type="gitaly"}) by (fqdn) > 0.5
  FOR 1m
  LABELS {severity="critical", channel="gitaly"}
  ANNOTATIONS {
    title="Gitaly: High CPU usage on {{ $labels.fqdn }}",
    description="Gitaly has been using more than 50% of total available CPU on {{$labels.fqdn}} for the past minute. This may affect the stability of the NFS server. Visit this dashboard: https://performance.gitlab.net/dashboard/db/gitaly-nfs-metrics-per-host?refresh=30s&orgId=1&var-fqdn={{$labels.fqdn}}&from=now-1h&to=now",
    runbook="troubleshooting/gitaly-high-cpu.md"
  }

## Gitaly Method Error Rate compared with 12 hour average
ALERT GitalyMethodErrorRateOutlier
  IF
    gitaly:grpc_server_handled_total:error_rate1m{environment="prd", job="gitaly-production"}
    > on (job, grpc_method, environment) group_left()
      (
      gitaly:grpc_server_handled_total:error_avg_rate12h{environment="prd", job="gitaly-production"}
      + 2 * gitaly:grpc_server_handled_total:error_stddev_rate12h{environment="prd", job="gitaly-production"}
      )
  FOR 5m
  LABELS {severity="warn", channel="gitaly"}
  ANNOTATIONS {
    title="Gitaly: Error rate on {{ $labels.grpc_method }} is unusually high compared with a 12 hour average",
    description="The error rate on the {{ $labels.grpc_method }} is outside normal values over a 12 hour period (95% confidence). Check https://performance.gitlab.net/dashboard/db/gitaly-feature-status?from=now-1h&to=now&orgId=1&var-method={{ $labels.grpc_method }}&var-job=gitaly-production&refresh=5m",
    runbook="troubleshooting/gitaly-error-rate.md"
  }

ALERT GitalyMethodUnderSLA
  IF
    (1 - gitaly:grpc_server_handled_total:error_rate1m{environment="prd"} / gitaly:grpc_server_handled_total:rate1m) < 0.999
  FOR 5m
  LABELS {severity="warn", channel="gitaly"}
  ANNOTATIONS {
    title="Gitaly: Endpoint {{ $labels.grpc_method }} is under SLA rate of 99.9%",
    description="The error rate on the {{ $labels.grpc_method }} endpoint exceeds SLA maximum rate. Check https://performance.gitlab.net/dashboard/db/gitaly-feature-status?from=now-1h&to=now&orgId=1&var-method={{ $labels.grpc_method }}&var-job=gitaly-production&refresh=5m",
    runbook="troubleshooting/gitaly-error-rate.md"
  }
