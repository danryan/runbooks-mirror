gitaly:grpc_server_handled_total:error_max_rate1m = max(gitaly:grpc_server_handled_total:error_rate1m)
gitaly:grpc_server_handled_total:instance_error_max_rate1m = max(gitaly:grpc_server_handled_total:instance_error_rate1m)

## Gitaly error rate per method
ALERT gitaly_error_rate_too_high
  IF gitaly:grpc_server_handled_total:error_max_rate1m > 2
  FOR 5m
  LABELS {severity="critical", channel="gitaly"}
  ANNOTATIONS {
    title="Gitaly error rate is too high: {{$value | printf \"%.2f\" }}",
    description="Gitaly error rate for the last 5 minutes is over 2 for {{$labels.grpc_method}}. Check Gitaly logs and consider disabling that method.",
    runbook="troubleshooting/gitaly-error-rate.md"
  }

## Gitaly error rate per instance
ALERT gitaly_error_rate_too_high
  IF gitaly:grpc_server_handled_total:instance_error_max_rate1m > 2
  FOR 5m
  LABELS {severity="critical", channel="gitaly"}
  ANNOTATIONS {
    title="Gitaly error rate is too high: {{$value | printf \"%.2f\" }}",
    description="Gitaly error rate for the last 5 minutes is over 2 on {{$labels.instance}}. Check Gitaly logs and consider disabling it on that host.",
    runbook="troubleshooting/gitaly-error-rate.md"
  }


## Gitaly Down
ALERT GitalyFileServerDown
  IF up{job="gitaly-production", tier="stor"} == 0
  FOR 1m
  LABELS {severity="critical", channel="gitaly"}
  ANNOTATIONS {
    title="Gitaly is down on {{ $labels.fqdn }}",
    description="Gitaly has been marked as down for the past minute on {{$labels.instance}}. Check Gitaly logs and restart the process if neccessary",
    runbook="troubleshooting/gitaly-down.md"
  }

## Gitaly File Server CPU Usage
ALERT GitalyFileServerCPUUsage
  IF process_cpu_seconds_total:rate1m{job="gitaly-production", tier="stor"} >= 0.5
  FOR 5m
  LABELS {severity="critical", channel="gitaly"}
  ANNOTATIONS {
    title="Gitaly: High CPU usage on {{ $labels.fqdn }}",
    description="Gitaly has been using more than 50% CPU on {{$labels.fqdn}} for the past 5 minutes. This may affect the stability of the NFS server. Visit this dashboard: https://performance.gitlab.net/dashboard/db/gitaly-nfs-metrics-per-host?refresh=30s&orgId=1&var-fqdn={{$labels.fqdn}}&from=now-1h&to=now",
    runbook="troubleshooting/gitaly-high-cpu.md"
  }
