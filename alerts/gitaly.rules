gitaly:grpc_server_handled_total:error_max_rate1m = max(gitaly:grpc_server_handled_total:error_rate1m)
gitaly:grpc_server_handled_total:instance_error_max_rate1m = max(gitaly:grpc_server_handled_total:instance_error_rate1m)

## Gitaly error rate per method
ALERT gitaly_error_rate_too_high
  IF gitaly:grpc_server_handled_total:error_max_rate1m > 2
  FOR 5m
  LABELS {severity="critical", channel="gitaly"}
  ANNOTATIONS {
    title="Gitaly error rate is too high: {{$value | printf \"%.2f\" }}",
    description="Gitaly error rate for the last 5 minutes is over 2 for {{$labels.grpc_method}}. Check Gitaly logs and consider disabling that method.",
    runbook="troubleshooting/gitaly-error-rate.md"
  }

## Gitaly error rate per instance
ALERT gitaly_error_rate_too_high
  IF gitaly:grpc_server_handled_total:instance_error_max_rate1m > 2
  FOR 5m
  LABELS {severity="critical", channel="gitaly"}
  ANNOTATIONS {
    title="Gitaly error rate is too high: {{$value | printf \"%.2f\" }}",
    description="Gitaly error rate for the last 5 minutes is over 2 on {{$labels.instance}}. Check Gitaly logs and consider disabling it on that host.",
    runbook="troubleshooting/gitaly-error-rate.md"
  }


## Gitaly Down
ALERT GitalyFileServerDown
  IF up{job="gitaly-production", tier="stor", type="gitaly"} == 0
  FOR 1m
  LABELS {severity="critical", channel="gitaly"}
  ANNOTATIONS {
    title="Gitaly is down on {{ $labels.fqdn }}",
    description="Gitaly has been marked as down for the past minute on {{$labels.instance}}. Check Gitaly logs and restart the process if necessary",
    runbook="troubleshooting/gitaly-down.md"
  }

## Gitaly File Server CPU Usage
ALERT GitalyFileServerCPUUsage
  IF avg(process_cpu_seconds_total:rate1m{job="gitaly-production", tier="stor", type="gitaly"}) by (fqdn) / avg(instance:node_cpus:count{tier="stor", type="gitaly"}) by (fqdn) > 0.5
  FOR 1m
  LABELS {severity="critical", channel="gitaly"}
  ANNOTATIONS {
    title="Gitaly: High CPU usage on {{ $labels.fqdn }}",
    description="Gitaly has been using more than 50% of total available CPU on {{$labels.fqdn}} for the past minute. This may affect the stability of the NFS server. Visit this dashboard: https://performance.gitlab.net/dashboard/db/gitaly-nfs-metrics-per-host?refresh=30s&orgId=1&var-fqdn={{$labels.fqdn}}&from=now-1h&to=now",
    runbook="troubleshooting/gitaly-high-cpu.md"
  }


## Alert if the number of distinct versions of Gitaly in production is two for more than 30 minutes
## 30 minutes being the maximum time for the Gitaly deployment
ALERT GitalyVersionMismatch
  IF count(sum(gitlab_build_info{job="gitaly-production"}) by (version) > 0) == 2
  FOR 30m
  LABELS {severity="critical", channel="gitaly"}
  ANNOTATIONS {
    title="Gitaly: two versions of Gitaly have been running alongside one another in production for more than 30 minutes",
    description="During a deployment, two distinct versions of Gitaly may be running alongside one another, but this should not be the case for more than 30m. Visit https://performance.gitlab.net/dashboard/db/gitaly-version-tracker?orgId=1&var-job=gitaly-production for details of versions deployed across the fleet.",
    runbook="troubleshooting/gitaly-version-mismatch.md"
  }

## Alert if the number of distinct versions of Gitaly in production exceeds 2 for more than a minute
## If this is the case, something is seriously wrong and operators should know immediately
ALERT GitalyVersionMismatchSevere
  IF count(sum(gitlab_build_info{job="gitaly-production"}) by (version) > 0) > 2
  FOR 1m
  LABELS {severity="critical", channel="gitaly"}
  ANNOTATIONS {
    title="Gitaly: multiple versions of Gitaly are currently running in production",
    description="Three of more versions of Gitaly are currently running alongside one another in production. This should never occur and indicates serious deployment failures. Visit https://performance.gitlab.net/dashboard/db/gitaly-version-tracker?orgId=1&var-job=gitaly-production for details of versions deployed across the fleet.",
    runbook="troubleshooting/gitaly-version-mismatch.md"
  }

## Gitaly Method Error Rate compared with 12 hour average
ALERT GitalyMethodErrorRateOutlier
  IF
    gitaly:grpc_server_handled_total:error_rate1m{environment="prd", job="gitaly-production"}
    > on (job, grpc_method, environment) group_left()
      (
      gitaly:grpc_server_handled_total:error_avg_rate12h{environment="prd", job="gitaly-production"}
      + 2 * gitaly:grpc_server_handled_total:error_rate1m_stddev_over_time12h{environment="prd", job="gitaly-production"}
      )
  FOR 5m
  LABELS {severity="warn", channel="gitaly"}
  ANNOTATIONS {
    title="Gitaly: Error rate on {{ $labels.grpc_method }} is unusually high compared with a 12 hour average",
    description="The error rate on the {{ $labels.grpc_method }} is outside normal values over a 12 hour period (95% confidence). Check https://performance.gitlab.net/dashboard/db/gitaly-feature-status?from=now-1h&to=now&orgId=1&var-method={{ $labels.grpc_method }}&var-job=gitaly-production&refresh=5m",
    runbook="troubleshooting/gitaly-error-rate.md"
  }

## Gitaly method average latency outlier detection
## If an endpoint suddenly becomes much slower than it's historical average, raise an alert
ALERT GitalyLatencyOutlier
  IF
    avg(gitaly:grpc_server_handling_seconds:avg5m{environment="prd", job="gitaly-production"}) by (grpc_method)
    > on (grpc_method) group_left()
      (
      avg(gitaly:grpc_server_handling_seconds:avg24h{environment="prd", job="gitaly-production"}) by (grpc_method)
      + 2 * avg(gitaly:grpc_server_handling_seconds:avg5m_stddev_over_time24h) by (grpc_method)
      )
  FOR 5m
  LABELS {severity="warn", channel="gitaly"}
  ANNOTATIONS {
    title="Gitaly: Latency on the Gitaly {{ $labels.grpc_method }} is unusually high compared with a 24 hour average",
    description="The error rate on the {{ $labels.grpc_method }} endpoint is outside normal values over a 12 hour period (95% confidence). Check https://performance.gitlab.net/dashboard/db/gitaly-feature-status?from=now-1h&to=now&orgId=1&var-method={{ $labels.grpc_method }}&var-job=gitaly-production&refresh=5m",
    runbook="troubleshooting/gitaly-error-rate.md"
  }
