groups:
- name: redundancy.rules
  rules:

  - alert: LossOfRedundancy
    expr: ((sum by (type)(up{environment=~"g?prd",tier="lb",job="node"}))/(count by (type) (up{environment=~"g?prd",tier="lb",job="node"})) * 100) < 100
    for: 5m
    labels:
      pager: pagerduty
      severity: warning
    annotations:
      description: |
        {{ $labels.type }} has lost redundancy. Only {{ $value }}% of servers are online.
      runbook: troubleshooting/gitlab-com-is-down.md
      title: Loss of Redundancy

  - alert: NoFrontends
    expr: (sum by (type)(up{environment=~"g?prd",tier="lb",job="node"})) == 0
      > 0
    labels:
      pager: pagerduty
      severity: critical
    annotations:
      description: |
        {{ $labels.type }} have no instances online to serve traffic.
      runbook: troubleshooting/gitlab-com-is-down.md
      title: No Frontend Available
