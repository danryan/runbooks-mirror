groups:
- name: gitaly.rules
  rules:
  - alert: gitaly_error_rate_too_high
    expr: gitaly:grpc_server_handled_total:error_rate1m{environment="prd"} > 2
    for: 5m
    labels:
      channel: gitaly
      severity: critical
    annotations:
      description: Gitaly error rate for the last 5 minutes is over 2 for {{$labels.grpc_method}}.
        Check Gitaly logs and consider disabling that method.
      runbook: troubleshooting/gitaly-error-rate.md
      title: 'Gitaly error rate is too high: {{$value | printf "%.2f" }}'
  - alert: gitaly_error_rate_too_high
    expr: gitaly:grpc_server_handled_total:instance_error_rate1m{environment="prd"}
      > 4
    for: 5m
    labels:
      channel: gitaly
      severity: critical
    annotations:
      description: Gitaly error rate for the last 5 minutes is over 4 on {{$labels.instance}}.
        Check Gitaly logs and consider disabling it on that host.
      runbook: troubleshooting/gitaly-error-rate.md
      title: 'Gitaly error rate is too high: {{$value | printf "%.2f" }}'
  - alert: GitalyFileServerDown
    expr: up{environment="prd",job="gitaly",tier="stor",type="gitaly"} == 0
    for: 1m
    labels:
      channel: gitaly
      severity: critical
    annotations:
      description: Gitaly has been marked as down for the past minute on {{$labels.instance}}.
        Check Gitaly logs and restart the process if necessary
      runbook: troubleshooting/gitaly-down.md
      title: Gitaly is down on {{ $labels.fqdn }}
  - alert: GitalyFileServerCPUUsage
    expr: avg(process_cpu_seconds_total:rate1m{environment="prd",job="gitaly",tier="stor",type="gitaly"})
      BY (fqdn) / avg(instance:node_cpus:count{tier="stor",type="gitaly"}) BY (fqdn)
      > 0.5
    for: 1m
    labels:
      channel: gitaly
      severity: critical
    annotations:
      description: 'Gitaly has been using more than 50% of total available CPU on
        {{$labels.fqdn}} for the past minute. This may affect the stability of the
        NFS server. Visit this dashboard: https://performance.gitlab.net/dashboard/db/gitaly-nfs-metrics-per-host?refresh=30s&orgId=1&var-fqdn={{$labels.fqdn}}&from=now-1h&to=now'
      runbook: troubleshooting/gitaly-high-cpu.md
      title: 'Gitaly: High CPU usage on {{ $labels.fqdn }}'
  - alert: GitalyVersionMismatch
    expr: count(sum(gitlab_build_info{environment="prd",tier="stor",type="gitaly"})
      BY (version) > 0) == 2
    for: 30m
    labels:
      channel: gitaly
      severity: critical
    annotations:
      description: During a deployment, two distinct versions of Gitaly may be running
        alongside one another, but this should not be the case for more than 30m.
        Visit https://performance.gitlab.net/dashboard/db/gitaly-version-tracker?orgId=1&var-environment=prd
        for details of versions deployed across the fleet.
      runbook: troubleshooting/gitaly-version-mismatch.md
      title: 'Gitaly: two versions of Gitaly have been running alongside one another
        in production for more than 30 minutes'
  - alert: GitalyVersionMismatchSevere
    expr: count(sum(gitlab_build_info{environment="prd",tier="stor",type="gitaly"})
      BY (version) > 0) > 2
    for: 1m
    labels:
      channel: gitaly
      severity: critical
    annotations:
      description: Three of more versions of Gitaly are currently running alongside
        one another in production. This should never occur and indicates serious deployment
        failures. Visit https://performance.gitlab.net/dashboard/db/gitaly-version-tracker?orgId=1&var-environment=prd
        for details of versions deployed across the fleet.
      runbook: troubleshooting/gitaly-version-mismatch.md
      title: 'Gitaly: multiple versions of Gitaly are currently running in production'
  - alert: GitalyMethodErrorRateOutlier
    expr: gitaly:grpc_server_handled_total:error_rate1m{environment="prd",job="gitaly",tier="stor",type="gitaly"}
      > ON(job, grpc_method, environment) GROUP_LEFT() (gitaly:grpc_server_handled_total:error_avg_rate12h{environment="prd",tier="stor",type="gitaly"}
      + 2 * gitaly:grpc_server_handled_total:error_rate1m_stddev_over_time12h{environment="prd",job="gitaly",tier="stor",type="gitaly"})
    for: 5m
    labels:
      channel: gitaly
      severity: warn
    annotations:
      description: The error rate on the {{ $labels.grpc_method }} is outside normal
        values over a 12 hour period (95% confidence). Check https://performance.gitlab.net/dashboard/db/gitaly-feature-status?from=now-1h&to=now&orgId=1&var-method={{
        $labels.grpc_method }}&var-tier=stor&var-type=gitaly&var-environment=prd&refresh=5m
      runbook: troubleshooting/gitaly-error-rate.md
      title: 'Gitaly: Error rate on {{ $labels.grpc_method }} is unusually high compared
        with a 12 hour average'
  - alert: GitalyLatencyOutlier
    expr: avg(gitaly:grpc_server_handling_seconds:avg5m{environment="prd",job="gitaly",tier="stor",type="gitaly"})
      BY (grpc_method) > ON(grpc_method) GROUP_LEFT() (avg(gitaly:grpc_server_handling_seconds:avg24h{environment="prd",job="gitaly",tier="stor",type="gitaly"})
      BY (grpc_method) + 2 * avg(gitaly:grpc_server_handling_seconds:avg5m_stddev_over_time24h)
      BY (grpc_method))
    for: 5m
    labels:
      channel: gitaly
      severity: warn
    annotations:
      description: The error rate on the {{ $labels.grpc_method }} endpoint is outside
        normal values over a 12 hour period (95% confidence). Check https://performance.gitlab.net/dashboard/db/gitaly-feature-status?from=now-1h&to=now&orgId=1&var-method={{
        $labels.grpc_method }}&var-tier=stor&var-type=gitaly&var-environment=prd&refresh=5m
      runbook: troubleshooting/gitaly-error-rate.md
      title: 'Gitaly: Latency on the Gitaly {{ $labels.grpc_method }} is unusually
        high compared with a 24 hour average'
