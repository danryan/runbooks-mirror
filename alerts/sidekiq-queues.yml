groups:
- name: sidekiq-queues.rules
  rules:
  - alert: SidekiqQueuesTooLong
    expr: topk(1, sidekiq_queue_size{name!~"process_commit|pipeline_background:archive_trace"}) > 20000
    for: 20m
    labels:
      severity: critical
    annotations:
      description: Sidekiq jobs are piling up for the last minute, this may be under
        control, but I'm just letting you know that this is going on, check http://dashboards.gitlab.net/dashboard/db/sidekiq-stats.
        Note that ProcessCommitWorker is excluded from job count.
      runbook: troubleshooting/large-sidekiq-queue.md
      title: 'Large amount of Sidekiq Queued jobs: {{$value}}'
  - alert: SidekiqNewNotesQueueTooLarge
    expr: topk(1, sidekiq_queue_size{name="new_note"}) > 5000
    for: 20m
    labels:
      severity: critical
    annotations:
      description: The new_note sidekiq queue is piling up. This likely means that users are not receiving email notifications
        for comments on issues.
      runbook: troubleshooting/large-sidekiq-queue.md
      title: 'Large amount of new_note sidekiq queued jobs: {{$value}}'
  - alert: SidekiqQueuesTooLargeHourly
    expr: topk(1, sidekiq_queue_size{name!~"process_commit|pipeline_background:archive_trace"}) > 20000
    for: 1h
    labels:
      severity: critical
    annotations:
      description: There have been over queued 2000 Sidekiq jobs for the last hour.
        Check http://dashboards.gitlab.net/dashboard/db/sidekiq-stats. Note that
        ProcessCommitWorker is excluded from job count.
      runbook: troubleshooting/large-sidekiq-queue.md
      title: 'Large amount of Sidekiq Queued jobs: {{$value}}'
