## RUNNERS CACHE
ALERT runners_registry_cache_nginx_status
  IF
label_replace(
  drop_common_labels(
    probe_http_status_code{instance=~"runners-cache-.*:5000/v2"}==bool 200
  ),
  "grouping",
  "$1",
  "instance",
  "(.*):5000/v2"
)*100
+ ignoring(instance)
label_replace(
  drop_common_labels(
    probe_http_status_code{instance=~"runners-cache-.*:9000/minio/login"}==bool 200
  ),
  "grouping",
  "$1",
  "instance",
  "(.*):9000/minio/login"
)*10
+ ignoring(instance)
label_replace(
  drop_common_labels(
    node_systemd_unit_state{instance=~"runners-cache.*",name=~"nginx.service",state="active"}
  ),
  "grouping",
  "$1.gitlab.com",
  "instance",
  "(.*)"
)
!= 111
  FOR 1m
  LABELS {severity="critical", channel="ci", pager="pagerduty"}
  ANNOTATIONS {
    title='Runners cache on {{ reReplaceAll "/minio/login" "" (reReplaceAll "https://" "" .Labels.instance) }} is down',
    runbook="troubleshooting/runners_cache_is_down.md",
    description="This impacts CI execution builds, consider tweeting: !tweet 'CI executions are being delayed due to our runners cache being down at GitLab.com, we are investigating the root cause'"
  }

ALERT runners_cache_nginx_is_down
  IF probe_http_status_code{job="runners-cache-registry",instance=~"https://runners-cache.*minio.*"} != 200 and 
  FOR 1m
  LABELS {severity="critical", channel="ci", pager="pagerduty"}
  ANNOTATIONS {
    title='Runners cache on {{ reReplaceAll "/minio/login" "" (reReplaceAll "https://" "" .Labels.instance) }} is down',
    runbook="troubleshooting/runners_cache_is_down.md",
    description="This impacts CI execution builds, consider tweeting: !tweet 'CI executions are being delayed due to our runners cache being down at GitLab.com, we are investigating the root cause'"
  }
