ALERT LowDiskSpace
  IF
      node_filesystem_avail{job="node", fstype=~"(ext.|xfs)"}
    /
      node_filesystem_size{job="node", fstype=~"(ext.|xfs)"}
    * 100 <= 10
  FOR 15m
  LABELS { severity = "critical" }
  ANNOTATIONS {
    title = "Really low disk space left on {{ $labels.mountpoint }} on {{ if $labels.fqdn }}{{ $labels.fqdn }}{{ else }}{{ $labels.instance }}{{ end }}: {{ $value | humanize }}%",
    description = "Consider sshing into the instance and removing old logs or clean temp files following the linked runbook. For status check http://performance.gitlab.net/dashboard/db/fleet-overview",
    runbook="troubleshooting/filesystem_alerts.md"
  }

ALERT NoDiskSpace
  IF
      node_filesystem_avail{job="node", fstype=~"(ext.|xfs)"}
    /
      node_filesystem_size{job="node", fstype=~"(ext.|xfs)"}
    * 100 <= 1
  FOR 15m
  LABELS { severity = "critical", pager="pagerduty" }
  ANNOTATIONS {
    title = "No disk space left on {{ $labels.mountpoint }} on {{ if $labels.fqdn }}{{ $labels.fqdn }}{{ else }}{{ $labels.instance }}{{ end }}: {{ $value | humanize }}%",
    description = "There's only 1% disk space left on host {{ if $labels.fqdn }}{{ $labels.fqdn }}{{ else }}{{ $labels.instance }}{{ end }}",
    runbook="troubleshooting/filesystem_alerts.md"
  }

ALERT HighInodeUsage
  IF
      node_filesystem_files_free{job="node", fstype=~"(ext.|xfs)"}
    /
      node_filesystem_files{job="node", fstype=~"(ext.|xfs)"}
    * 100 <= 20
  FOR 15m
  LABELS { severity = "critical" }
  ANNOTATIONS {
    title = "Free inodes on {{ if $labels.fqdn }}{{ $labels.fqdn }}{{ else }}{{ $labels.instance }}{{ end }} on mountpoint {{ $labels.mountpoint }} is at {{ $value | printf \"%.2f\" }}%",
    description = "Consider ssh'ing into the instance and removing files or clean temp files following the linked runbook. For status check http://performance.gitlab.net/dashboard/db/fleet-overview",
    runbook="troubleshooting/filesystem_alerts_inodes.md"
  }

ALERT ExtremelyHighCPU
  IF max(instance_cpu:node_cpu_not_idle:rate5m{environment=~"prd|cny"}) > .95
  FOR 120m
  LABELS { severity = "critical", pager="pagerduty" }
  ANNOTATIONS {
  title="CPU use percent is extremely high on {{ if $labels.fqdn }}{{ $labels.fqdn }}{{ else }}{{ $labels.instance }}{{ end }} for the past 2 hours.",
  description="CPU use percent is extremely high on {{ if $labels.fqdn }}{{ $labels.fqdn }}{{ else }}{{ $labels.instance }}{{ end }} for the past 2 hours.",
  runbook="troubleshooting"
  }

ALERT HighCPU
  IF max(instance_cpu:node_cpu_not_idle:rate5m{environment=~"prd|cny"}) > .80
  FOR 120m
  LABELS { severity = "critical" }
  ANNOTATIONS {
  title="CPU use percent is high on {{ if $labels.fqdn }}{{ $labels.fqdn }}{{ else }}{{ $labels.instance }}{{ end }} for the past 2 hours.",
  description="CPU use percent is extremely high on {{ if $labels.fqdn }}{{ $labels.fqdn }}{{ else }}{{ $labels.instance }}{{ end }} for the past 2 hours.",
  runbook="troubleshooting"
  }

ALERT CPUOutlierDetectionOnPrd
  IF instance:node_cpu_in_use:percent5m{environment=~"prd|cny"} 
    >= on (job, fqdn, environment) group_left()
    (
      clamp_max(instance:node_cpu_in_use:percent1h + 2 * instance:node_cpu_in_use:percent_stddev_over_time1h, 1)
    )
  FOR 10m
  LABELS {severity="warn"}
  ANNOTATIONS {
  title="CPU use percent is unusually high compared with the rate of the last hour",
  description="The CPU usage on {{ if $labels.fqdn }}{{ $labels.fqdn }}{{ else }}{{ $labels.instance }}{{ end }} is outside normal values over a 1h period",
  runbook="troubleshooting"
  }

ALERT FleetSizeChanged
  IF changes(instance:up:count{environment="prd"}[5m]) >= 1
  FOR 15m
  LABELS { severity = "warn", channel="production" }
  ANNOTATIONS {
  title="The fleet size has changed in the last 5 minutes",
  description="The {{ $labels.type }} fleet has changed, this can be due to having more or less, if it's the latter it can be because nodes went down silently",
  runbook="troubleshooting"
  }

