ALERT ChefClientErrorInPrd
  IF chef_client_error{environment="prd"} == 1
  FOR 5h
  LABELS {severity="warn"}
  ANNOTATIONS {
    title="Chef client failed for more than 5hs",
    description="Check failed chef executions on host {{ $labels.fqdn }} in https://prometheus.gitlab.com/graph?g0.range_input=8w&g0.expr=chef_client_error+%3D%3D+1&g0.tab=1",
    runbook="troubleshooting/chef.md",
  }


ALERT ChefClientStale
  IF (time()/60/60 - ceil(chef_client_last_run_timestamp_seconds{environment="prd"}/60/60)) > 5
  LABELS {severity="warn"}
  ANNOTATIONS {
    title="Chef client hasn't run for longer than expected",
    description="Last Chef run for {{ $labels.fqdn }} was over {{ $value | humanizeDuration }} ago",
    runbook="troubleshooting/chef.md",
  }
