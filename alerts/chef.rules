ALERT ChefClientErrorInPrd
  IF chef_client_error{environment="prd"} == 1
  FOR 5h
  LABELS {severity="warn"}
  ANNOTATIONS {
    title="Chef client failed for more than 5hs",
    description="Check failed chef executions on host {{ $labels.fqdn }} in https://prometheus.gitlab.com/graph?g0.range_input=8w&g0.expr=chef_client_error+%3D%3D+1&g0.tab=1",
    runbook="troubleshooting/chef.md",
  }

# The '+time()%3600' is to try to arrange for these alerts to get
# grouped together. This way they'll only trigger once an hour on the
# hour.

ALERT ChefClientStale
  IF time() - chef_client_last_run_timestamp_seconds > 5*3600 + time()%3600
  LABELS {severity="warn"}
  ANNOTATIONS {
    title="Chef client hasn't run for longer than expected",
    description="Last Chef run for {{ $labels.fqdn }} was over {{ $value | humanizeDuration }} ago",
    runbook="troubleshooting/chef.md",
  }
