groups:
  - name: patroni.yml
    rules:
      - alert: PatroniErrors
        expr: rate(patroni_errors_total[1m]) > 1
        for: 5m
        labels:
          pager: pagerduty
          severity: s1
          alert_type: cause
        annotations:
          description: Patroni on {{$labels.fqdn}} is logging errors, this can mean it can't start PostgreSQL.
          title: Patroni is logging errors
          runbook: docs/patroni/patroni-management.md
      - alert: PatroniIsDown
        expr: namedprocess_namegroup_num_procs{groupname="patroni"} == 0
        for: 5m
        labels:
          pager: pagerduty
          severity: s1
          alert_type: cause
        annotations:
          description: Patroni on {{$labels.fqdn}} seems to be down, which means that PostgreSQL is probably down there as well.
          title: Patroni is down
          runbook: docs/patroni/patroni-management.md
      - alert: PatroniXminAgeTooLarge
        expr: pg_txid_xmin_age > 500000
        for: 45m
        labels:
          severity: s3
          alert_type: cause
          incident_project: gitlab.com/gitlab-com/gl-infra/production
        annotations:
          description: The xmin horizon is too old on {{$labels.fqdn}}.
          title: Long-running transactions detected on Patroni
          runbook: docs/patroni/pg_xid_xmin_age_alert.md
