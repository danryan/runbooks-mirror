groups:
- name: redis-cache-replica-connection.rules
  rules:
  - alert: RedisCacheReplicasFlapping
    expr: changes(redis_connected_slaves{fqdn=~"redis-cache-0.*"}[5m]) > 1
    for: 1m
    labels:
      pager: pagerduty
      severity: critical
    annotations:
      description: Changes have been detected in Redis-Cache replica connection. 
        This can occur when replica nodes loose connection to the master and 
        reconnect (a.k.a flapping)
      runbook: troubleshooting/redis_replication.md
      title: Connection of Redis-Cache replicas to the master is flapping! 
        Master is {{ range query "gitlab:redis_master{fqdn=~"redis-cache-0.*"}" }}{{ .Labels.fqdn }}{{ end }}.
