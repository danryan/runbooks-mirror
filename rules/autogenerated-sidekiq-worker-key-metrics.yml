# WARNING. DO NOT EDIT THIS FILE BY HAND. USE ./rules-jsonnet/sidekiq-worker-key-metrics.jsonnet TO GENERATE IT
# YOUR CHANGES WILL BE OVERRIDDEN
groups:
- name: Sidekiq Per Worker Alerting
  interval: 1m
  rules:
  - alert: sidekiq_background_job_error_ratio_burn_rate_slo_out_of_bounds
    for: 2m
    annotations:
      title: The `{{ $labels.worker }}` worker, `{{ $labels.stage }}` stage, has an
        error rate outside of SLO
      description: Currently the error rate is {{ $value | humanizePercentage }}.
      grafana_dashboard_id: sidekiq-worker-detail/sidekiq-worker-detail
      grafana_dashboard_link: https://dashboards.gitlab.net/d/sidekiq-worker-detail/sidekiq-worker-detail?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}&var-worker={{ $labels.worker
        }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "2383655193"
      grafana_variables: environment,stage,worker
      promql_template_1: gitlab_background_jobs:execution:error:ratio_1h{environment="$environment",
        type="$type", stage="$stage", component="$component"}
      runbook: docs/sidekiq/README.md
    labels:
      alert_type: symptom
      rules_domain: general
      severity: s4
      slo_alert: "yes"
    expr: |
      (
        (
          gitlab_background_jobs:execution:error:ratio_1h{monitor!="global"}
          > (14.4 * 0.010000)
        )
        and
        (
          gitlab_background_jobs:execution:error:ratio_5m{monitor!="global"}
          > (14.4 * 0.010000)
        )
        or
        (
          gitlab_background_jobs:execution:error:ratio_6h{monitor!="global"}
          > (6 * 0.010000)
        )
        and
        (
          gitlab_background_jobs:execution:error:ratio_30m{monitor!="global"}
          > (6 * 0.010000)
        )
      )
      and on(environment,tier,type,stage,shard,queue,feature_category,urgency,worker)
      (
        sum by(environment,tier,type,stage,shard,queue,feature_category,urgency,worker) (gitlab_background_jobs:execution:ops:rate_6h{monitor!="global"}) >= 0.1
      )
  - alert: sidekiq_background_job_execution_apdex_ratio_burn_rate_slo_out_of_bounds
    for: 2m
    annotations:
      title: The `{{ $labels.worker }}` worker, `{{ $labels.stage }}` stage, has a
        execution latency outside of SLO
      description: Currently the apdex score is {{ $value | humanizePercentage }}.
      grafana_dashboard_id: sidekiq-worker-detail/sidekiq-worker-detail
      grafana_dashboard_link: https://dashboards.gitlab.net/d/sidekiq-worker-detail/sidekiq-worker-detail?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}&var-worker={{ $labels.worker
        }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "2504679775"
      grafana_variables: environment,stage,worker
      promql_template_1: gitlab_background_jobs:execution:apdex:ratio_1h{environment="$environment",
        type="$type", stage="$stage", component="$component"}
      runbook: docs/sidekiq/README.md
    labels:
      alert_type: symptom
      rules_domain: general
      severity: s4
      slo_alert: "yes"
    expr: |
      (
        (
          gitlab_background_jobs:execution:apdex:ratio_1h{monitor!="global"}
          < (1 - 14.4 * 0.010000)
        )
        and
        (
          gitlab_background_jobs:execution:apdex:ratio_5m{monitor!="global"}
          < (1 - 14.4 * 0.010000)
        )
        or
        (
          gitlab_background_jobs:execution:apdex:ratio_6h{monitor!="global"}
          < (1 - 6 * 0.010000)
        )
        and
        (
          gitlab_background_jobs:execution:apdex:ratio_30m{monitor!="global"}
          < (1 - 6 * 0.010000)
        )
      )
      and on(environment,tier,type,stage,shard,queue,feature_category,urgency,worker)
      (
        sum by(environment,tier,type,stage,shard,queue,feature_category,urgency,worker) (gitlab_background_jobs:execution:ops:rate_1h{monitor!="global"}) >= 0.1
      )
  - alert: sidekiq_background_job_queue_apdex_ratio_burn_rate_slo_out_of_bounds
    for: 2m
    annotations:
      title: The `{{ $labels.worker }}` worker, `{{ $labels.stage }}` stage, has a
        queue latency outside of SLO
      description: Currently the apdex score is {{ $value | humanizePercentage }}.
      grafana_dashboard_id: sidekiq-worker-detail/sidekiq-worker-detail
      grafana_dashboard_link: https://dashboards.gitlab.net/d/sidekiq-worker-detail/sidekiq-worker-detail?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}&var-worker={{ $labels.worker
        }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "750569445"
      grafana_variables: environment,stage,worker
      promql_template_1: gitlab_background_jobs:queue:apdex:ratio_1h{environment="$environment",
        type="$type", stage="$stage", component="$component"}
      runbook: docs/sidekiq/README.md
    labels:
      alert_type: symptom
      rules_domain: general
      severity: s4
      slo_alert: "yes"
    expr: |
      (
        (
          gitlab_background_jobs:queue:apdex:ratio_1h{monitor!="global"}
          < (1 - 14.4 * 0.010000)
        )
        and
        (
          gitlab_background_jobs:queue:apdex:ratio_5m{monitor!="global"}
          < (1 - 14.4 * 0.010000)
        )
        or
        (
          gitlab_background_jobs:queue:apdex:ratio_6h{monitor!="global"}
          < (1 - 6 * 0.010000)
        )
        and
        (
          gitlab_background_jobs:queue:apdex:ratio_30m{monitor!="global"}
          < (1 - 6 * 0.010000)
        )
      )
      and on(environment,tier,type,stage,shard,queue,feature_category,urgency,worker)
      (
        sum by(environment,tier,type,stage,shard,queue,feature_category,urgency,worker) (gitlab_background_jobs:queue:ops:rate_6h{monitor!="global"}) >= 0.1
      )
