# WARNING. DO NOT EDIT THIS FILE BY HAND. USE ./rules-jsonnet/service-key-metrics.jsonnet TO GENERATE IT
# YOUR CHANGES WILL BE OVERRIDDEN
groups:
- name: 'Component-Level SLIs: ops-gitlab-net - 1m burn-rate'
  interval: 1m
  rules:
  - record: sli_aggregations:sidekiq_jobs_completion_seconds_bucket_rate1m
    expr: |
      sum by (environment,feature_category,job,le,queue,shard,stage,tier,type,urgency,worker) (
        rate(sidekiq_jobs_completion_seconds_bucket[1m])
      )
  - record: sli_aggregations:sidekiq_jobs_queue_duration_seconds_bucket_rate1m
    expr: |
      sum by (environment,feature_category,job,le,queue,shard,stage,tier,type,urgency,worker) (
        rate(sidekiq_jobs_queue_duration_seconds_bucket[1m])
      )
  - record: sli_aggregations:sidekiq_jobs_failed_total_rate1m
    expr: |
      sum by (environment,feature_category,job,queue,shard,stage,tier,type,urgency,worker) (
        rate(sidekiq_jobs_failed_total[1m])
      )
  - record: gitlab_component_ops:rate
    labels:
      component: email_receiver
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        rate(sidekiq_jobs_completion_seconds_count{job="sidekiq",type="ops-gitlab-net",worker=~"EmailReceiverWorker|ServiceDeskEmailReceiverWorker"}[1m])
      )
  - record: gitlab_component_errors:rate
    labels:
      component: email_receiver
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          rate(gitlab_transaction_event_email_receiver_error_total{error!="Gitlab::Email::AutoGeneratedEmailError",job="sidekiq",type="ops-gitlab-net"}[1m])
        )
      )
      or
      (
        0 * group by(environment) (
          gitlab_component_ops:rate{component="email_receiver",stage="main",tier="sv",type="ops-gitlab-net"}
        )
      )
  - record: gitlab_component_apdex:success:rate
    labels:
      component: gitlab_sshd
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          rate(gitlab_shell_sshd_session_established_duration_seconds_bucket{job="gitlab-shell",le="1",type="ops-gitlab-net"}[1m])
        )
        +
        sum by (environment) (
          rate(gitlab_shell_sshd_session_established_duration_seconds_bucket{job="gitlab-shell",le="5",type="ops-gitlab-net"}[1m])
        )
      )
      /
      2
  - record: gitlab_component_apdex:weight:score
    labels:
      component: gitlab_sshd
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        rate(gitlab_shell_sshd_session_established_duration_seconds_bucket{job="gitlab-shell",le="+Inf",type="ops-gitlab-net"}[1m])
      )
  - record: gitlab_component_ops:rate
    labels:
      component: gitlab_sshd
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        rate(gitlab_sli:shell_sshd_sessions:total{job="gitlab-shell",type="ops-gitlab-net"}[1m])
      )
  - record: gitlab_component_errors:rate
    labels:
      component: gitlab_sshd
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          rate(gitlab_sli:shell_sshd_sessions:errors_total{job="gitlab-shell",type="ops-gitlab-net"}[1m])
        )
      )
      or
      (
        0 * group by(environment) (
          gitlab_component_ops:rate{component="gitlab_sshd",stage="main",tier="sv",type="ops-gitlab-net"}
        )
      )
  - record: gitlab_component_apdex:success:rate
    labels:
      component: goserver
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        label_replace((
          sum by (environment) (
            rate(grpc_server_handling_seconds_bucket{grpc_method!~"CalculateChecksum|CommitLanguages|CommitStats|CreateFork|CreateRepositoryFromURL|FetchInternalRemote|FetchIntoObjectPool|FetchRemote|FetchSourceBranch|FindCommit|FindRemoteRepository|FindRemoteRootRef|Fsck|GarbageCollect|GetArchive|LastCommitForPath|OptimizeRepository|PackObjectsHookWithSidechannel|PostReceiveHook|PostUploadPackWithSidechannel|PreReceiveHook|RepackFull|RepackIncremental|ReplicateRepository|RepositorySize|SSHUploadPackWithSidechannel|UpdateHook|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="0.5",type="ops-gitlab-net"}[1m])
          )
          +
          sum by (environment) (
            rate(grpc_server_handling_seconds_bucket{grpc_method!~"CalculateChecksum|CommitLanguages|CommitStats|CreateFork|CreateRepositoryFromURL|FetchInternalRemote|FetchIntoObjectPool|FetchRemote|FetchSourceBranch|FindCommit|FindRemoteRepository|FindRemoteRootRef|Fsck|GarbageCollect|GetArchive|LastCommitForPath|OptimizeRepository|PackObjectsHookWithSidechannel|PostReceiveHook|PostUploadPackWithSidechannel|PreReceiveHook|RepackFull|RepackIncremental|ReplicateRepository|RepositorySize|SSHUploadPackWithSidechannel|UpdateHook|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="1",type="ops-gitlab-net"}[1m])
          )
        )
        /
        2
        , "_c", "0", "", "")
        or
        label_replace((
          sum by (environment) (
            rate(grpc_server_handling_seconds_bucket{grpc_method=~"FindCommit|GetArchive|LastCommitForPath|RepositorySize|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="10",type="ops-gitlab-net"}[1m])
          )
          +
          sum by (environment) (
            rate(grpc_server_handling_seconds_bucket{grpc_method=~"FindCommit|GetArchive|LastCommitForPath|RepositorySize|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="30",type="ops-gitlab-net"}[1m])
          )
        )
        /
        2
        , "_c", "1", "", "")
        or
        label_replace((
          sum by (environment) (
            rate(grpc_server_handling_seconds_bucket{grpc_service="gitaly.OperationService",grpc_type="unary",job="gitaly",le="10",type="ops-gitlab-net"}[1m])
          )
          +
          sum by (environment) (
            rate(grpc_server_handling_seconds_bucket{grpc_service="gitaly.OperationService",grpc_type="unary",job="gitaly",le="30",type="ops-gitlab-net"}[1m])
          )
        )
        /
        2
        , "_c", "2", "", "")
      )
  - record: gitlab_component_apdex:weight:score
    labels:
      component: goserver
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        label_replace(sum by (environment) (
          rate(grpc_server_handling_seconds_bucket{grpc_method!~"CalculateChecksum|CommitLanguages|CommitStats|CreateFork|CreateRepositoryFromURL|FetchInternalRemote|FetchIntoObjectPool|FetchRemote|FetchSourceBranch|FindCommit|FindRemoteRepository|FindRemoteRootRef|Fsck|GarbageCollect|GetArchive|LastCommitForPath|OptimizeRepository|PackObjectsHookWithSidechannel|PostReceiveHook|PostUploadPackWithSidechannel|PreReceiveHook|RepackFull|RepackIncremental|ReplicateRepository|RepositorySize|SSHUploadPackWithSidechannel|UpdateHook|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="+Inf",type="ops-gitlab-net"}[1m])
        )
        , "_c", "0", "", "")
        or
        label_replace(sum by (environment) (
          rate(grpc_server_handling_seconds_bucket{grpc_method=~"FindCommit|GetArchive|LastCommitForPath|RepositorySize|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="+Inf",type="ops-gitlab-net"}[1m])
        )
        , "_c", "1", "", "")
        or
        label_replace(sum by (environment) (
          rate(grpc_server_handling_seconds_bucket{grpc_service="gitaly.OperationService",grpc_type="unary",job="gitaly",le="+Inf",type="ops-gitlab-net"}[1m])
        )
        , "_c", "2", "", "")
      )
  - record: gitlab_component_ops:rate
    labels:
      component: goserver
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        rate(gitaly_service_client_requests_total{job="gitaly",type="ops-gitlab-net"}[1m])
      )
  - record: gitlab_component_errors:rate
    labels:
      component: goserver
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          label_replace(rate(gitaly_service_client_requests_total{grpc_code!~"AlreadyExists|Canceled|DeadlineExceeded|FailedPrecondition|InvalidArgument|NotFound|OK|PermissionDenied|ResourceExhausted|Unauthenticated",job="gitaly",type="ops-gitlab-net"}[1m]), "_c", "0", "", "")
          or
          label_replace(rate(gitaly_service_client_requests_total{deadline_type!="limited",grpc_code="DeadlineExceeded",job="gitaly",type="ops-gitlab-net"}[1m]), "_c", "1", "", "")
        )
      )
      or
      (
        0 * group by(environment) (
          gitlab_component_ops:rate{component="goserver",stage="main",tier="sv",type="ops-gitlab-net"}
        )
      )
  - record: gitlab_component_apdex:success:rate
    labels:
      component: puma
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        sli_aggregations:gitlab_sli_rails_request_apdex_success_total_rate1m{job="gitlab-rails",type="ops-gitlab-net"}
      )
  - record: gitlab_component_apdex:weight:score
    labels:
      component: puma
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        sli_aggregations:gitlab_sli_rails_request_apdex_total_rate1m{job="gitlab-rails",type="ops-gitlab-net"}
      )
  - record: gitlab_component_ops:rate
    labels:
      component: puma
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        sli_aggregations:http_requests_total_rate1m{job="gitlab-rails",type="ops-gitlab-net"}
      )
  - record: gitlab_component_errors:rate
    labels:
      component: puma
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          sli_aggregations:http_requests_total_rate1m{job="gitlab-rails",status=~"5..",type="ops-gitlab-net"}
        )
      )
      or
      (
        0 * group by(environment) (
          gitlab_component_ops:rate{component="puma",stage="main",tier="sv",type="ops-gitlab-net"}
        )
      )
  - record: gitlab_component_apdex:success:rate
    labels:
      component: registry_server
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          rate(registry_http_request_duration_seconds_bucket{job="registry",le="2.5",route!~"/v2/{name}/blobs/uploads/{uuid}|/v2/{name}/manifests/{reference}",type="ops-gitlab-net"}[1m])
        )
        +
        sum by (environment) (
          rate(registry_http_request_duration_seconds_bucket{job="registry",le="25",route!~"/v2/{name}/blobs/uploads/{uuid}|/v2/{name}/manifests/{reference}",type="ops-gitlab-net"}[1m])
        )
      )
      /
      2
  - record: gitlab_component_apdex:weight:score
    labels:
      component: registry_server
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        rate(registry_http_request_duration_seconds_bucket{job="registry",le="+Inf",route!~"/v2/{name}/blobs/uploads/{uuid}|/v2/{name}/manifests/{reference}",type="ops-gitlab-net"}[1m])
      )
  - record: gitlab_component_ops:rate
    labels:
      component: registry_server
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        rate(registry_http_requests_total{job="registry",type="ops-gitlab-net"}[1m])
      )
  - record: gitlab_component_errors:rate
    labels:
      component: registry_server
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          rate(registry_http_requests_total{code=~"5..",job="registry",type="ops-gitlab-net"}[1m])
        )
      )
      or
      (
        0 * group by(environment) (
          gitlab_component_ops:rate{component="registry_server",stage="main",tier="sv",type="ops-gitlab-net"}
        )
      )
  - record: gitlab_component_apdex:success:rate
    labels:
      component: shard_default
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        label_replace(sum by (environment) (
          sli_aggregations:sidekiq_jobs_completion_seconds_bucket_rate1m{job="sidekiq",le="10",type="ops-gitlab-net",urgency="high"}
        )
        , "_c", "0", "", "")
        or
        label_replace(sum by (environment) (
          sli_aggregations:sidekiq_jobs_queue_duration_seconds_bucket_rate1m{job="sidekiq",le="10",type="ops-gitlab-net",urgency="high"}
        )
        , "_c", "1", "", "")
        or
        label_replace(sum by (environment) (
          sli_aggregations:sidekiq_jobs_completion_seconds_bucket_rate1m{job="sidekiq",le="300",type="ops-gitlab-net",urgency="low"}
        )
        , "_c", "2", "", "")
        or
        label_replace(sum by (environment) (
          sli_aggregations:sidekiq_jobs_queue_duration_seconds_bucket_rate1m{job="sidekiq",le="60",type="ops-gitlab-net",urgency="low"}
        )
        , "_c", "3", "", "")
        or
        label_replace(sum by (environment) (
          sli_aggregations:sidekiq_jobs_completion_seconds_bucket_rate1m{job="sidekiq",le="300",type="ops-gitlab-net",urgency="throttled"}
        )
        , "_c", "4", "", "")
      )
  - record: gitlab_component_apdex:weight:score
    labels:
      component: shard_default
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        label_replace(sum by (environment) (
          sli_aggregations:sidekiq_jobs_completion_seconds_bucket_rate1m{job="sidekiq",le="+Inf",type="ops-gitlab-net",urgency="high"}
        )
        , "_c", "0", "", "")
        or
        label_replace(sum by (environment) (
          sli_aggregations:sidekiq_jobs_queue_duration_seconds_bucket_rate1m{job="sidekiq",le="+Inf",type="ops-gitlab-net",urgency="high"}
        )
        , "_c", "1", "", "")
        or
        label_replace(sum by (environment) (
          sli_aggregations:sidekiq_jobs_completion_seconds_bucket_rate1m{job="sidekiq",le="+Inf",type="ops-gitlab-net",urgency="low"}
        )
        , "_c", "2", "", "")
        or
        label_replace(sum by (environment) (
          sli_aggregations:sidekiq_jobs_queue_duration_seconds_bucket_rate1m{job="sidekiq",le="+Inf",type="ops-gitlab-net",urgency="low"}
        )
        , "_c", "3", "", "")
        or
        label_replace(sum by (environment) (
          sli_aggregations:sidekiq_jobs_completion_seconds_bucket_rate1m{job="sidekiq",le="+Inf",type="ops-gitlab-net",urgency="throttled"}
        )
        , "_c", "4", "", "")
      )
  - record: gitlab_component_ops:rate
    labels:
      component: shard_default
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        sli_aggregations:sidekiq_jobs_completion_seconds_bucket_rate1m{job="sidekiq",le="+Inf",type="ops-gitlab-net"}
      )
  - record: gitlab_component_errors:rate
    labels:
      component: shard_default
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          sli_aggregations:sidekiq_jobs_failed_total_rate1m{job="sidekiq",type="ops-gitlab-net"}
        )
      )
      or
      (
        0 * group by(environment) (
          gitlab_component_ops:rate{component="shard_default",stage="main",tier="sv",type="ops-gitlab-net"}
        )
      )
  - record: gitlab_component_apdex:success:rate
    labels:
      component: workhorse
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          rate(gitlab_workhorse_http_request_duration_seconds_bucket{job="gitlab-workhorse",le="1",route!="^/([^/]+/){1,}[^/]+/uploads\\z",route!="^/-/health$",route!="^/-/(readiness|liveness)$",route!="^/([^/]+/){1,}[^/]+\\.git/git-receive-pack\\z",route!="^/([^/]+/){1,}[^/]+\\.git/git-upload-pack\\z",route!="^/([^/]+/){1,}[^/]+\\.git/info/refs\\z",route!="^/([^/]+/){1,}[^/]+\\.git/gitlab-lfs/objects/([0-9a-f]{64})/([0-9]+)\\z",type="ops-gitlab-net"}[1m])
        )
        +
        sum by (environment) (
          rate(gitlab_workhorse_http_request_duration_seconds_bucket{job="gitlab-workhorse",le="10",route!="^/([^/]+/){1,}[^/]+/uploads\\z",route!="^/-/health$",route!="^/-/(readiness|liveness)$",route!="^/([^/]+/){1,}[^/]+\\.git/git-receive-pack\\z",route!="^/([^/]+/){1,}[^/]+\\.git/git-upload-pack\\z",route!="^/([^/]+/){1,}[^/]+\\.git/info/refs\\z",route!="^/([^/]+/){1,}[^/]+\\.git/gitlab-lfs/objects/([0-9a-f]{64})/([0-9]+)\\z",type="ops-gitlab-net"}[1m])
        )
      )
      /
      2
  - record: gitlab_component_apdex:weight:score
    labels:
      component: workhorse
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        rate(gitlab_workhorse_http_request_duration_seconds_bucket{job="gitlab-workhorse",le="+Inf",route!="^/([^/]+/){1,}[^/]+/uploads\\z",route!="^/-/health$",route!="^/-/(readiness|liveness)$",route!="^/([^/]+/){1,}[^/]+\\.git/git-receive-pack\\z",route!="^/([^/]+/){1,}[^/]+\\.git/git-upload-pack\\z",route!="^/([^/]+/){1,}[^/]+\\.git/info/refs\\z",route!="^/([^/]+/){1,}[^/]+\\.git/gitlab-lfs/objects/([0-9a-f]{64})/([0-9]+)\\z",type="ops-gitlab-net"}[1m])
      )
  - record: gitlab_component_ops:rate
    labels:
      component: workhorse
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        rate(gitlab_workhorse_http_requests_total{job="gitlab-workhorse",type="ops-gitlab-net"}[1m])
      )
  - record: gitlab_component_errors:rate
    labels:
      component: workhorse
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          rate(gitlab_workhorse_http_requests_total{code=~"^5.*",job="gitlab-workhorse",route!="^/-/health$",route!="^/-/(readiness|liveness)$",type="ops-gitlab-net"}[1m])
        )
      )
      or
      (
        0 * group by(environment) (
          gitlab_component_ops:rate{component="workhorse",stage="main",tier="sv",type="ops-gitlab-net"}
        )
      )
- name: 'Component-Level SLIs: ops-gitlab-net - 5m burn-rate'
  interval: 1m
  rules:
  - record: sli_aggregations:sidekiq_jobs_completion_seconds_bucket_rate5m
    expr: |
      sum by (environment,feature_category,job,le,queue,shard,stage,tier,type,urgency,worker) (
        rate(sidekiq_jobs_completion_seconds_bucket[5m])
      )
  - record: sli_aggregations:sidekiq_jobs_queue_duration_seconds_bucket_rate5m
    expr: |
      sum by (environment,feature_category,job,le,queue,shard,stage,tier,type,urgency,worker) (
        rate(sidekiq_jobs_queue_duration_seconds_bucket[5m])
      )
  - record: sli_aggregations:sidekiq_jobs_failed_total_rate5m
    expr: |
      sum by (environment,feature_category,job,queue,shard,stage,tier,type,urgency,worker) (
        rate(sidekiq_jobs_failed_total[5m])
      )
  - record: gitlab_component_ops:rate_5m
    labels:
      component: email_receiver
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        rate(sidekiq_jobs_completion_seconds_count{job="sidekiq",type="ops-gitlab-net",worker=~"EmailReceiverWorker|ServiceDeskEmailReceiverWorker"}[5m])
      )
  - record: gitlab_component_errors:rate_5m
    labels:
      component: email_receiver
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          rate(gitlab_transaction_event_email_receiver_error_total{error!="Gitlab::Email::AutoGeneratedEmailError",job="sidekiq",type="ops-gitlab-net"}[5m])
        )
      )
      or
      (
        0 * group by(environment) (
          gitlab_component_ops:rate_5m{component="email_receiver",stage="main",tier="sv",type="ops-gitlab-net"}
        )
      )
  - record: gitlab_component_apdex:success:rate_5m
    labels:
      component: gitlab_sshd
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          rate(gitlab_shell_sshd_session_established_duration_seconds_bucket{job="gitlab-shell",le="1",type="ops-gitlab-net"}[5m])
        )
        +
        sum by (environment) (
          rate(gitlab_shell_sshd_session_established_duration_seconds_bucket{job="gitlab-shell",le="5",type="ops-gitlab-net"}[5m])
        )
      )
      /
      2
  - record: gitlab_component_apdex:weight:score_5m
    labels:
      component: gitlab_sshd
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        rate(gitlab_shell_sshd_session_established_duration_seconds_bucket{job="gitlab-shell",le="+Inf",type="ops-gitlab-net"}[5m])
      )
  - record: gitlab_component_ops:rate_5m
    labels:
      component: gitlab_sshd
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        rate(gitlab_sli:shell_sshd_sessions:total{job="gitlab-shell",type="ops-gitlab-net"}[5m])
      )
  - record: gitlab_component_errors:rate_5m
    labels:
      component: gitlab_sshd
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          rate(gitlab_sli:shell_sshd_sessions:errors_total{job="gitlab-shell",type="ops-gitlab-net"}[5m])
        )
      )
      or
      (
        0 * group by(environment) (
          gitlab_component_ops:rate_5m{component="gitlab_sshd",stage="main",tier="sv",type="ops-gitlab-net"}
        )
      )
  - record: gitlab_component_apdex:success:rate_5m
    labels:
      component: goserver
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        label_replace((
          sum by (environment) (
            rate(grpc_server_handling_seconds_bucket{grpc_method!~"CalculateChecksum|CommitLanguages|CommitStats|CreateFork|CreateRepositoryFromURL|FetchInternalRemote|FetchIntoObjectPool|FetchRemote|FetchSourceBranch|FindCommit|FindRemoteRepository|FindRemoteRootRef|Fsck|GarbageCollect|GetArchive|LastCommitForPath|OptimizeRepository|PackObjectsHookWithSidechannel|PostReceiveHook|PostUploadPackWithSidechannel|PreReceiveHook|RepackFull|RepackIncremental|ReplicateRepository|RepositorySize|SSHUploadPackWithSidechannel|UpdateHook|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="0.5",type="ops-gitlab-net"}[5m])
          )
          +
          sum by (environment) (
            rate(grpc_server_handling_seconds_bucket{grpc_method!~"CalculateChecksum|CommitLanguages|CommitStats|CreateFork|CreateRepositoryFromURL|FetchInternalRemote|FetchIntoObjectPool|FetchRemote|FetchSourceBranch|FindCommit|FindRemoteRepository|FindRemoteRootRef|Fsck|GarbageCollect|GetArchive|LastCommitForPath|OptimizeRepository|PackObjectsHookWithSidechannel|PostReceiveHook|PostUploadPackWithSidechannel|PreReceiveHook|RepackFull|RepackIncremental|ReplicateRepository|RepositorySize|SSHUploadPackWithSidechannel|UpdateHook|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="1",type="ops-gitlab-net"}[5m])
          )
        )
        /
        2
        , "_c", "0", "", "")
        or
        label_replace((
          sum by (environment) (
            rate(grpc_server_handling_seconds_bucket{grpc_method=~"FindCommit|GetArchive|LastCommitForPath|RepositorySize|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="10",type="ops-gitlab-net"}[5m])
          )
          +
          sum by (environment) (
            rate(grpc_server_handling_seconds_bucket{grpc_method=~"FindCommit|GetArchive|LastCommitForPath|RepositorySize|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="30",type="ops-gitlab-net"}[5m])
          )
        )
        /
        2
        , "_c", "1", "", "")
        or
        label_replace((
          sum by (environment) (
            rate(grpc_server_handling_seconds_bucket{grpc_service="gitaly.OperationService",grpc_type="unary",job="gitaly",le="10",type="ops-gitlab-net"}[5m])
          )
          +
          sum by (environment) (
            rate(grpc_server_handling_seconds_bucket{grpc_service="gitaly.OperationService",grpc_type="unary",job="gitaly",le="30",type="ops-gitlab-net"}[5m])
          )
        )
        /
        2
        , "_c", "2", "", "")
      )
  - record: gitlab_component_apdex:weight:score_5m
    labels:
      component: goserver
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        label_replace(sum by (environment) (
          rate(grpc_server_handling_seconds_bucket{grpc_method!~"CalculateChecksum|CommitLanguages|CommitStats|CreateFork|CreateRepositoryFromURL|FetchInternalRemote|FetchIntoObjectPool|FetchRemote|FetchSourceBranch|FindCommit|FindRemoteRepository|FindRemoteRootRef|Fsck|GarbageCollect|GetArchive|LastCommitForPath|OptimizeRepository|PackObjectsHookWithSidechannel|PostReceiveHook|PostUploadPackWithSidechannel|PreReceiveHook|RepackFull|RepackIncremental|ReplicateRepository|RepositorySize|SSHUploadPackWithSidechannel|UpdateHook|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="+Inf",type="ops-gitlab-net"}[5m])
        )
        , "_c", "0", "", "")
        or
        label_replace(sum by (environment) (
          rate(grpc_server_handling_seconds_bucket{grpc_method=~"FindCommit|GetArchive|LastCommitForPath|RepositorySize|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="+Inf",type="ops-gitlab-net"}[5m])
        )
        , "_c", "1", "", "")
        or
        label_replace(sum by (environment) (
          rate(grpc_server_handling_seconds_bucket{grpc_service="gitaly.OperationService",grpc_type="unary",job="gitaly",le="+Inf",type="ops-gitlab-net"}[5m])
        )
        , "_c", "2", "", "")
      )
  - record: gitlab_component_ops:rate_5m
    labels:
      component: goserver
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        rate(gitaly_service_client_requests_total{job="gitaly",type="ops-gitlab-net"}[5m])
      )
  - record: gitlab_component_errors:rate_5m
    labels:
      component: goserver
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          label_replace(rate(gitaly_service_client_requests_total{grpc_code!~"AlreadyExists|Canceled|DeadlineExceeded|FailedPrecondition|InvalidArgument|NotFound|OK|PermissionDenied|ResourceExhausted|Unauthenticated",job="gitaly",type="ops-gitlab-net"}[5m]), "_c", "0", "", "")
          or
          label_replace(rate(gitaly_service_client_requests_total{deadline_type!="limited",grpc_code="DeadlineExceeded",job="gitaly",type="ops-gitlab-net"}[5m]), "_c", "1", "", "")
        )
      )
      or
      (
        0 * group by(environment) (
          gitlab_component_ops:rate_5m{component="goserver",stage="main",tier="sv",type="ops-gitlab-net"}
        )
      )
  - record: gitlab_component_apdex:success:rate_5m
    labels:
      component: puma
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        sli_aggregations:gitlab_sli_rails_request_apdex_success_total_rate5m{job="gitlab-rails",type="ops-gitlab-net"}
      )
  - record: gitlab_component_apdex:weight:score_5m
    labels:
      component: puma
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        sli_aggregations:gitlab_sli_rails_request_apdex_total_rate5m{job="gitlab-rails",type="ops-gitlab-net"}
      )
  - record: gitlab_component_ops:rate_5m
    labels:
      component: puma
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        sli_aggregations:http_requests_total_rate5m{job="gitlab-rails",type="ops-gitlab-net"}
      )
  - record: gitlab_component_errors:rate_5m
    labels:
      component: puma
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          sli_aggregations:http_requests_total_rate5m{job="gitlab-rails",status=~"5..",type="ops-gitlab-net"}
        )
      )
      or
      (
        0 * group by(environment) (
          gitlab_component_ops:rate_5m{component="puma",stage="main",tier="sv",type="ops-gitlab-net"}
        )
      )
  - record: gitlab_component_apdex:success:rate_5m
    labels:
      component: registry_server
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          rate(registry_http_request_duration_seconds_bucket{job="registry",le="2.5",route!~"/v2/{name}/blobs/uploads/{uuid}|/v2/{name}/manifests/{reference}",type="ops-gitlab-net"}[5m])
        )
        +
        sum by (environment) (
          rate(registry_http_request_duration_seconds_bucket{job="registry",le="25",route!~"/v2/{name}/blobs/uploads/{uuid}|/v2/{name}/manifests/{reference}",type="ops-gitlab-net"}[5m])
        )
      )
      /
      2
  - record: gitlab_component_apdex:weight:score_5m
    labels:
      component: registry_server
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        rate(registry_http_request_duration_seconds_bucket{job="registry",le="+Inf",route!~"/v2/{name}/blobs/uploads/{uuid}|/v2/{name}/manifests/{reference}",type="ops-gitlab-net"}[5m])
      )
  - record: gitlab_component_ops:rate_5m
    labels:
      component: registry_server
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        rate(registry_http_requests_total{job="registry",type="ops-gitlab-net"}[5m])
      )
  - record: gitlab_component_errors:rate_5m
    labels:
      component: registry_server
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          rate(registry_http_requests_total{code=~"5..",job="registry",type="ops-gitlab-net"}[5m])
        )
      )
      or
      (
        0 * group by(environment) (
          gitlab_component_ops:rate_5m{component="registry_server",stage="main",tier="sv",type="ops-gitlab-net"}
        )
      )
  - record: gitlab_component_apdex:success:rate_5m
    labels:
      component: shard_default
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        label_replace(sum by (environment) (
          sli_aggregations:sidekiq_jobs_completion_seconds_bucket_rate5m{job="sidekiq",le="10",type="ops-gitlab-net",urgency="high"}
        )
        , "_c", "0", "", "")
        or
        label_replace(sum by (environment) (
          sli_aggregations:sidekiq_jobs_queue_duration_seconds_bucket_rate5m{job="sidekiq",le="10",type="ops-gitlab-net",urgency="high"}
        )
        , "_c", "1", "", "")
        or
        label_replace(sum by (environment) (
          sli_aggregations:sidekiq_jobs_completion_seconds_bucket_rate5m{job="sidekiq",le="300",type="ops-gitlab-net",urgency="low"}
        )
        , "_c", "2", "", "")
        or
        label_replace(sum by (environment) (
          sli_aggregations:sidekiq_jobs_queue_duration_seconds_bucket_rate5m{job="sidekiq",le="60",type="ops-gitlab-net",urgency="low"}
        )
        , "_c", "3", "", "")
        or
        label_replace(sum by (environment) (
          sli_aggregations:sidekiq_jobs_completion_seconds_bucket_rate5m{job="sidekiq",le="300",type="ops-gitlab-net",urgency="throttled"}
        )
        , "_c", "4", "", "")
      )
  - record: gitlab_component_apdex:weight:score_5m
    labels:
      component: shard_default
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        label_replace(sum by (environment) (
          sli_aggregations:sidekiq_jobs_completion_seconds_bucket_rate5m{job="sidekiq",le="+Inf",type="ops-gitlab-net",urgency="high"}
        )
        , "_c", "0", "", "")
        or
        label_replace(sum by (environment) (
          sli_aggregations:sidekiq_jobs_queue_duration_seconds_bucket_rate5m{job="sidekiq",le="+Inf",type="ops-gitlab-net",urgency="high"}
        )
        , "_c", "1", "", "")
        or
        label_replace(sum by (environment) (
          sli_aggregations:sidekiq_jobs_completion_seconds_bucket_rate5m{job="sidekiq",le="+Inf",type="ops-gitlab-net",urgency="low"}
        )
        , "_c", "2", "", "")
        or
        label_replace(sum by (environment) (
          sli_aggregations:sidekiq_jobs_queue_duration_seconds_bucket_rate5m{job="sidekiq",le="+Inf",type="ops-gitlab-net",urgency="low"}
        )
        , "_c", "3", "", "")
        or
        label_replace(sum by (environment) (
          sli_aggregations:sidekiq_jobs_completion_seconds_bucket_rate5m{job="sidekiq",le="+Inf",type="ops-gitlab-net",urgency="throttled"}
        )
        , "_c", "4", "", "")
      )
  - record: gitlab_component_ops:rate_5m
    labels:
      component: shard_default
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        sli_aggregations:sidekiq_jobs_completion_seconds_bucket_rate5m{job="sidekiq",le="+Inf",type="ops-gitlab-net"}
      )
  - record: gitlab_component_errors:rate_5m
    labels:
      component: shard_default
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          sli_aggregations:sidekiq_jobs_failed_total_rate5m{job="sidekiq",type="ops-gitlab-net"}
        )
      )
      or
      (
        0 * group by(environment) (
          gitlab_component_ops:rate_5m{component="shard_default",stage="main",tier="sv",type="ops-gitlab-net"}
        )
      )
  - record: gitlab_component_apdex:success:rate_5m
    labels:
      component: workhorse
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          rate(gitlab_workhorse_http_request_duration_seconds_bucket{job="gitlab-workhorse",le="1",route!="^/([^/]+/){1,}[^/]+/uploads\\z",route!="^/-/health$",route!="^/-/(readiness|liveness)$",route!="^/([^/]+/){1,}[^/]+\\.git/git-receive-pack\\z",route!="^/([^/]+/){1,}[^/]+\\.git/git-upload-pack\\z",route!="^/([^/]+/){1,}[^/]+\\.git/info/refs\\z",route!="^/([^/]+/){1,}[^/]+\\.git/gitlab-lfs/objects/([0-9a-f]{64})/([0-9]+)\\z",type="ops-gitlab-net"}[5m])
        )
        +
        sum by (environment) (
          rate(gitlab_workhorse_http_request_duration_seconds_bucket{job="gitlab-workhorse",le="10",route!="^/([^/]+/){1,}[^/]+/uploads\\z",route!="^/-/health$",route!="^/-/(readiness|liveness)$",route!="^/([^/]+/){1,}[^/]+\\.git/git-receive-pack\\z",route!="^/([^/]+/){1,}[^/]+\\.git/git-upload-pack\\z",route!="^/([^/]+/){1,}[^/]+\\.git/info/refs\\z",route!="^/([^/]+/){1,}[^/]+\\.git/gitlab-lfs/objects/([0-9a-f]{64})/([0-9]+)\\z",type="ops-gitlab-net"}[5m])
        )
      )
      /
      2
  - record: gitlab_component_apdex:weight:score_5m
    labels:
      component: workhorse
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        rate(gitlab_workhorse_http_request_duration_seconds_bucket{job="gitlab-workhorse",le="+Inf",route!="^/([^/]+/){1,}[^/]+/uploads\\z",route!="^/-/health$",route!="^/-/(readiness|liveness)$",route!="^/([^/]+/){1,}[^/]+\\.git/git-receive-pack\\z",route!="^/([^/]+/){1,}[^/]+\\.git/git-upload-pack\\z",route!="^/([^/]+/){1,}[^/]+\\.git/info/refs\\z",route!="^/([^/]+/){1,}[^/]+\\.git/gitlab-lfs/objects/([0-9a-f]{64})/([0-9]+)\\z",type="ops-gitlab-net"}[5m])
      )
  - record: gitlab_component_ops:rate_5m
    labels:
      component: workhorse
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        rate(gitlab_workhorse_http_requests_total{job="gitlab-workhorse",type="ops-gitlab-net"}[5m])
      )
  - record: gitlab_component_errors:rate_5m
    labels:
      component: workhorse
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          rate(gitlab_workhorse_http_requests_total{code=~"^5.*",job="gitlab-workhorse",route!="^/-/health$",route!="^/-/(readiness|liveness)$",type="ops-gitlab-net"}[5m])
        )
      )
      or
      (
        0 * group by(environment) (
          gitlab_component_ops:rate_5m{component="workhorse",stage="main",tier="sv",type="ops-gitlab-net"}
        )
      )
- name: 'Component-Level SLIs: ops-gitlab-net - 30m burn-rate'
  interval: 2m
  rules:
  - record: sli_aggregations:sidekiq_jobs_completion_seconds_bucket_rate30m
    expr: |
      sum by (environment,feature_category,job,le,queue,shard,stage,tier,type,urgency,worker) (
        rate(sidekiq_jobs_completion_seconds_bucket[30m])
      )
  - record: sli_aggregations:sidekiq_jobs_queue_duration_seconds_bucket_rate30m
    expr: |
      sum by (environment,feature_category,job,le,queue,shard,stage,tier,type,urgency,worker) (
        rate(sidekiq_jobs_queue_duration_seconds_bucket[30m])
      )
  - record: sli_aggregations:sidekiq_jobs_failed_total_rate30m
    expr: |
      sum by (environment,feature_category,job,queue,shard,stage,tier,type,urgency,worker) (
        rate(sidekiq_jobs_failed_total[30m])
      )
  - record: gitlab_component_ops:rate_30m
    labels:
      component: email_receiver
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        rate(sidekiq_jobs_completion_seconds_count{job="sidekiq",type="ops-gitlab-net",worker=~"EmailReceiverWorker|ServiceDeskEmailReceiverWorker"}[30m])
      )
  - record: gitlab_component_errors:rate_30m
    labels:
      component: email_receiver
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          rate(gitlab_transaction_event_email_receiver_error_total{error!="Gitlab::Email::AutoGeneratedEmailError",job="sidekiq",type="ops-gitlab-net"}[30m])
        )
      )
      or
      (
        0 * group by(environment) (
          gitlab_component_ops:rate_30m{component="email_receiver",stage="main",tier="sv",type="ops-gitlab-net"}
        )
      )
  - record: gitlab_component_apdex:success:rate_30m
    labels:
      component: gitlab_sshd
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          rate(gitlab_shell_sshd_session_established_duration_seconds_bucket{job="gitlab-shell",le="1",type="ops-gitlab-net"}[30m])
        )
        +
        sum by (environment) (
          rate(gitlab_shell_sshd_session_established_duration_seconds_bucket{job="gitlab-shell",le="5",type="ops-gitlab-net"}[30m])
        )
      )
      /
      2
  - record: gitlab_component_apdex:weight:score_30m
    labels:
      component: gitlab_sshd
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        rate(gitlab_shell_sshd_session_established_duration_seconds_bucket{job="gitlab-shell",le="+Inf",type="ops-gitlab-net"}[30m])
      )
  - record: gitlab_component_ops:rate_30m
    labels:
      component: gitlab_sshd
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        rate(gitlab_sli:shell_sshd_sessions:total{job="gitlab-shell",type="ops-gitlab-net"}[30m])
      )
  - record: gitlab_component_errors:rate_30m
    labels:
      component: gitlab_sshd
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          rate(gitlab_sli:shell_sshd_sessions:errors_total{job="gitlab-shell",type="ops-gitlab-net"}[30m])
        )
      )
      or
      (
        0 * group by(environment) (
          gitlab_component_ops:rate_30m{component="gitlab_sshd",stage="main",tier="sv",type="ops-gitlab-net"}
        )
      )
  - record: gitlab_component_apdex:success:rate_30m
    labels:
      component: goserver
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        label_replace((
          sum by (environment) (
            rate(grpc_server_handling_seconds_bucket{grpc_method!~"CalculateChecksum|CommitLanguages|CommitStats|CreateFork|CreateRepositoryFromURL|FetchInternalRemote|FetchIntoObjectPool|FetchRemote|FetchSourceBranch|FindCommit|FindRemoteRepository|FindRemoteRootRef|Fsck|GarbageCollect|GetArchive|LastCommitForPath|OptimizeRepository|PackObjectsHookWithSidechannel|PostReceiveHook|PostUploadPackWithSidechannel|PreReceiveHook|RepackFull|RepackIncremental|ReplicateRepository|RepositorySize|SSHUploadPackWithSidechannel|UpdateHook|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="0.5",type="ops-gitlab-net"}[30m])
          )
          +
          sum by (environment) (
            rate(grpc_server_handling_seconds_bucket{grpc_method!~"CalculateChecksum|CommitLanguages|CommitStats|CreateFork|CreateRepositoryFromURL|FetchInternalRemote|FetchIntoObjectPool|FetchRemote|FetchSourceBranch|FindCommit|FindRemoteRepository|FindRemoteRootRef|Fsck|GarbageCollect|GetArchive|LastCommitForPath|OptimizeRepository|PackObjectsHookWithSidechannel|PostReceiveHook|PostUploadPackWithSidechannel|PreReceiveHook|RepackFull|RepackIncremental|ReplicateRepository|RepositorySize|SSHUploadPackWithSidechannel|UpdateHook|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="1",type="ops-gitlab-net"}[30m])
          )
        )
        /
        2
        , "_c", "0", "", "")
        or
        label_replace((
          sum by (environment) (
            rate(grpc_server_handling_seconds_bucket{grpc_method=~"FindCommit|GetArchive|LastCommitForPath|RepositorySize|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="10",type="ops-gitlab-net"}[30m])
          )
          +
          sum by (environment) (
            rate(grpc_server_handling_seconds_bucket{grpc_method=~"FindCommit|GetArchive|LastCommitForPath|RepositorySize|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="30",type="ops-gitlab-net"}[30m])
          )
        )
        /
        2
        , "_c", "1", "", "")
        or
        label_replace((
          sum by (environment) (
            rate(grpc_server_handling_seconds_bucket{grpc_service="gitaly.OperationService",grpc_type="unary",job="gitaly",le="10",type="ops-gitlab-net"}[30m])
          )
          +
          sum by (environment) (
            rate(grpc_server_handling_seconds_bucket{grpc_service="gitaly.OperationService",grpc_type="unary",job="gitaly",le="30",type="ops-gitlab-net"}[30m])
          )
        )
        /
        2
        , "_c", "2", "", "")
      )
  - record: gitlab_component_apdex:weight:score_30m
    labels:
      component: goserver
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        label_replace(sum by (environment) (
          rate(grpc_server_handling_seconds_bucket{grpc_method!~"CalculateChecksum|CommitLanguages|CommitStats|CreateFork|CreateRepositoryFromURL|FetchInternalRemote|FetchIntoObjectPool|FetchRemote|FetchSourceBranch|FindCommit|FindRemoteRepository|FindRemoteRootRef|Fsck|GarbageCollect|GetArchive|LastCommitForPath|OptimizeRepository|PackObjectsHookWithSidechannel|PostReceiveHook|PostUploadPackWithSidechannel|PreReceiveHook|RepackFull|RepackIncremental|ReplicateRepository|RepositorySize|SSHUploadPackWithSidechannel|UpdateHook|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="+Inf",type="ops-gitlab-net"}[30m])
        )
        , "_c", "0", "", "")
        or
        label_replace(sum by (environment) (
          rate(grpc_server_handling_seconds_bucket{grpc_method=~"FindCommit|GetArchive|LastCommitForPath|RepositorySize|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="+Inf",type="ops-gitlab-net"}[30m])
        )
        , "_c", "1", "", "")
        or
        label_replace(sum by (environment) (
          rate(grpc_server_handling_seconds_bucket{grpc_service="gitaly.OperationService",grpc_type="unary",job="gitaly",le="+Inf",type="ops-gitlab-net"}[30m])
        )
        , "_c", "2", "", "")
      )
  - record: gitlab_component_ops:rate_30m
    labels:
      component: goserver
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        rate(gitaly_service_client_requests_total{job="gitaly",type="ops-gitlab-net"}[30m])
      )
  - record: gitlab_component_errors:rate_30m
    labels:
      component: goserver
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          label_replace(rate(gitaly_service_client_requests_total{grpc_code!~"AlreadyExists|Canceled|DeadlineExceeded|FailedPrecondition|InvalidArgument|NotFound|OK|PermissionDenied|ResourceExhausted|Unauthenticated",job="gitaly",type="ops-gitlab-net"}[30m]), "_c", "0", "", "")
          or
          label_replace(rate(gitaly_service_client_requests_total{deadline_type!="limited",grpc_code="DeadlineExceeded",job="gitaly",type="ops-gitlab-net"}[30m]), "_c", "1", "", "")
        )
      )
      or
      (
        0 * group by(environment) (
          gitlab_component_ops:rate_30m{component="goserver",stage="main",tier="sv",type="ops-gitlab-net"}
        )
      )
  - record: gitlab_component_apdex:success:rate_30m
    labels:
      component: puma
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        sli_aggregations:gitlab_sli_rails_request_apdex_success_total_rate30m{job="gitlab-rails",type="ops-gitlab-net"}
      )
  - record: gitlab_component_apdex:weight:score_30m
    labels:
      component: puma
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        sli_aggregations:gitlab_sli_rails_request_apdex_total_rate30m{job="gitlab-rails",type="ops-gitlab-net"}
      )
  - record: gitlab_component_ops:rate_30m
    labels:
      component: puma
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        sli_aggregations:http_requests_total_rate30m{job="gitlab-rails",type="ops-gitlab-net"}
      )
  - record: gitlab_component_errors:rate_30m
    labels:
      component: puma
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          sli_aggregations:http_requests_total_rate30m{job="gitlab-rails",status=~"5..",type="ops-gitlab-net"}
        )
      )
      or
      (
        0 * group by(environment) (
          gitlab_component_ops:rate_30m{component="puma",stage="main",tier="sv",type="ops-gitlab-net"}
        )
      )
  - record: gitlab_component_apdex:success:rate_30m
    labels:
      component: registry_server
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          rate(registry_http_request_duration_seconds_bucket{job="registry",le="2.5",route!~"/v2/{name}/blobs/uploads/{uuid}|/v2/{name}/manifests/{reference}",type="ops-gitlab-net"}[30m])
        )
        +
        sum by (environment) (
          rate(registry_http_request_duration_seconds_bucket{job="registry",le="25",route!~"/v2/{name}/blobs/uploads/{uuid}|/v2/{name}/manifests/{reference}",type="ops-gitlab-net"}[30m])
        )
      )
      /
      2
  - record: gitlab_component_apdex:weight:score_30m
    labels:
      component: registry_server
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        rate(registry_http_request_duration_seconds_bucket{job="registry",le="+Inf",route!~"/v2/{name}/blobs/uploads/{uuid}|/v2/{name}/manifests/{reference}",type="ops-gitlab-net"}[30m])
      )
  - record: gitlab_component_ops:rate_30m
    labels:
      component: registry_server
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        rate(registry_http_requests_total{job="registry",type="ops-gitlab-net"}[30m])
      )
  - record: gitlab_component_errors:rate_30m
    labels:
      component: registry_server
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          rate(registry_http_requests_total{code=~"5..",job="registry",type="ops-gitlab-net"}[30m])
        )
      )
      or
      (
        0 * group by(environment) (
          gitlab_component_ops:rate_30m{component="registry_server",stage="main",tier="sv",type="ops-gitlab-net"}
        )
      )
  - record: gitlab_component_apdex:success:rate_30m
    labels:
      component: shard_default
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        label_replace(sum by (environment) (
          sli_aggregations:sidekiq_jobs_completion_seconds_bucket_rate30m{job="sidekiq",le="10",type="ops-gitlab-net",urgency="high"}
        )
        , "_c", "0", "", "")
        or
        label_replace(sum by (environment) (
          sli_aggregations:sidekiq_jobs_queue_duration_seconds_bucket_rate30m{job="sidekiq",le="10",type="ops-gitlab-net",urgency="high"}
        )
        , "_c", "1", "", "")
        or
        label_replace(sum by (environment) (
          sli_aggregations:sidekiq_jobs_completion_seconds_bucket_rate30m{job="sidekiq",le="300",type="ops-gitlab-net",urgency="low"}
        )
        , "_c", "2", "", "")
        or
        label_replace(sum by (environment) (
          sli_aggregations:sidekiq_jobs_queue_duration_seconds_bucket_rate30m{job="sidekiq",le="60",type="ops-gitlab-net",urgency="low"}
        )
        , "_c", "3", "", "")
        or
        label_replace(sum by (environment) (
          sli_aggregations:sidekiq_jobs_completion_seconds_bucket_rate30m{job="sidekiq",le="300",type="ops-gitlab-net",urgency="throttled"}
        )
        , "_c", "4", "", "")
      )
  - record: gitlab_component_apdex:weight:score_30m
    labels:
      component: shard_default
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        label_replace(sum by (environment) (
          sli_aggregations:sidekiq_jobs_completion_seconds_bucket_rate30m{job="sidekiq",le="+Inf",type="ops-gitlab-net",urgency="high"}
        )
        , "_c", "0", "", "")
        or
        label_replace(sum by (environment) (
          sli_aggregations:sidekiq_jobs_queue_duration_seconds_bucket_rate30m{job="sidekiq",le="+Inf",type="ops-gitlab-net",urgency="high"}
        )
        , "_c", "1", "", "")
        or
        label_replace(sum by (environment) (
          sli_aggregations:sidekiq_jobs_completion_seconds_bucket_rate30m{job="sidekiq",le="+Inf",type="ops-gitlab-net",urgency="low"}
        )
        , "_c", "2", "", "")
        or
        label_replace(sum by (environment) (
          sli_aggregations:sidekiq_jobs_queue_duration_seconds_bucket_rate30m{job="sidekiq",le="+Inf",type="ops-gitlab-net",urgency="low"}
        )
        , "_c", "3", "", "")
        or
        label_replace(sum by (environment) (
          sli_aggregations:sidekiq_jobs_completion_seconds_bucket_rate30m{job="sidekiq",le="+Inf",type="ops-gitlab-net",urgency="throttled"}
        )
        , "_c", "4", "", "")
      )
  - record: gitlab_component_ops:rate_30m
    labels:
      component: shard_default
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        sli_aggregations:sidekiq_jobs_completion_seconds_bucket_rate30m{job="sidekiq",le="+Inf",type="ops-gitlab-net"}
      )
  - record: gitlab_component_errors:rate_30m
    labels:
      component: shard_default
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          sli_aggregations:sidekiq_jobs_failed_total_rate30m{job="sidekiq",type="ops-gitlab-net"}
        )
      )
      or
      (
        0 * group by(environment) (
          gitlab_component_ops:rate_30m{component="shard_default",stage="main",tier="sv",type="ops-gitlab-net"}
        )
      )
  - record: gitlab_component_apdex:success:rate_30m
    labels:
      component: workhorse
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          rate(gitlab_workhorse_http_request_duration_seconds_bucket{job="gitlab-workhorse",le="1",route!="^/([^/]+/){1,}[^/]+/uploads\\z",route!="^/-/health$",route!="^/-/(readiness|liveness)$",route!="^/([^/]+/){1,}[^/]+\\.git/git-receive-pack\\z",route!="^/([^/]+/){1,}[^/]+\\.git/git-upload-pack\\z",route!="^/([^/]+/){1,}[^/]+\\.git/info/refs\\z",route!="^/([^/]+/){1,}[^/]+\\.git/gitlab-lfs/objects/([0-9a-f]{64})/([0-9]+)\\z",type="ops-gitlab-net"}[30m])
        )
        +
        sum by (environment) (
          rate(gitlab_workhorse_http_request_duration_seconds_bucket{job="gitlab-workhorse",le="10",route!="^/([^/]+/){1,}[^/]+/uploads\\z",route!="^/-/health$",route!="^/-/(readiness|liveness)$",route!="^/([^/]+/){1,}[^/]+\\.git/git-receive-pack\\z",route!="^/([^/]+/){1,}[^/]+\\.git/git-upload-pack\\z",route!="^/([^/]+/){1,}[^/]+\\.git/info/refs\\z",route!="^/([^/]+/){1,}[^/]+\\.git/gitlab-lfs/objects/([0-9a-f]{64})/([0-9]+)\\z",type="ops-gitlab-net"}[30m])
        )
      )
      /
      2
  - record: gitlab_component_apdex:weight:score_30m
    labels:
      component: workhorse
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        rate(gitlab_workhorse_http_request_duration_seconds_bucket{job="gitlab-workhorse",le="+Inf",route!="^/([^/]+/){1,}[^/]+/uploads\\z",route!="^/-/health$",route!="^/-/(readiness|liveness)$",route!="^/([^/]+/){1,}[^/]+\\.git/git-receive-pack\\z",route!="^/([^/]+/){1,}[^/]+\\.git/git-upload-pack\\z",route!="^/([^/]+/){1,}[^/]+\\.git/info/refs\\z",route!="^/([^/]+/){1,}[^/]+\\.git/gitlab-lfs/objects/([0-9a-f]{64})/([0-9]+)\\z",type="ops-gitlab-net"}[30m])
      )
  - record: gitlab_component_ops:rate_30m
    labels:
      component: workhorse
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        rate(gitlab_workhorse_http_requests_total{job="gitlab-workhorse",type="ops-gitlab-net"}[30m])
      )
  - record: gitlab_component_errors:rate_30m
    labels:
      component: workhorse
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          rate(gitlab_workhorse_http_requests_total{code=~"^5.*",job="gitlab-workhorse",route!="^/-/health$",route!="^/-/(readiness|liveness)$",type="ops-gitlab-net"}[30m])
        )
      )
      or
      (
        0 * group by(environment) (
          gitlab_component_ops:rate_30m{component="workhorse",stage="main",tier="sv",type="ops-gitlab-net"}
        )
      )
- name: 'Component-Level SLIs: ops-gitlab-net - 1h burn-rate'
  interval: 1m
  rules:
  - record: sli_aggregations:sidekiq_jobs_completion_seconds_bucket_rate1h
    expr: |
      sum by (environment,feature_category,job,le,queue,shard,stage,tier,type,urgency,worker) (
        rate(sidekiq_jobs_completion_seconds_bucket[1h])
      )
  - record: sli_aggregations:sidekiq_jobs_queue_duration_seconds_bucket_rate1h
    expr: |
      sum by (environment,feature_category,job,le,queue,shard,stage,tier,type,urgency,worker) (
        rate(sidekiq_jobs_queue_duration_seconds_bucket[1h])
      )
  - record: sli_aggregations:sidekiq_jobs_failed_total_rate1h
    expr: |
      sum by (environment,feature_category,job,queue,shard,stage,tier,type,urgency,worker) (
        rate(sidekiq_jobs_failed_total[1h])
      )
  - record: gitlab_component_ops:rate_1h
    labels:
      component: email_receiver
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        rate(sidekiq_jobs_completion_seconds_count{job="sidekiq",type="ops-gitlab-net",worker=~"EmailReceiverWorker|ServiceDeskEmailReceiverWorker"}[1h])
      )
  - record: gitlab_component_errors:rate_1h
    labels:
      component: email_receiver
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          rate(gitlab_transaction_event_email_receiver_error_total{error!="Gitlab::Email::AutoGeneratedEmailError",job="sidekiq",type="ops-gitlab-net"}[1h])
        )
      )
      or
      (
        0 * group by(environment) (
          gitlab_component_ops:rate_1h{component="email_receiver",stage="main",tier="sv",type="ops-gitlab-net"}
        )
      )
  - record: gitlab_component_apdex:success:rate_1h
    labels:
      component: gitlab_sshd
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          rate(gitlab_shell_sshd_session_established_duration_seconds_bucket{job="gitlab-shell",le="1",type="ops-gitlab-net"}[1h])
        )
        +
        sum by (environment) (
          rate(gitlab_shell_sshd_session_established_duration_seconds_bucket{job="gitlab-shell",le="5",type="ops-gitlab-net"}[1h])
        )
      )
      /
      2
  - record: gitlab_component_apdex:weight:score_1h
    labels:
      component: gitlab_sshd
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        rate(gitlab_shell_sshd_session_established_duration_seconds_bucket{job="gitlab-shell",le="+Inf",type="ops-gitlab-net"}[1h])
      )
  - record: gitlab_component_ops:rate_1h
    labels:
      component: gitlab_sshd
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        rate(gitlab_sli:shell_sshd_sessions:total{job="gitlab-shell",type="ops-gitlab-net"}[1h])
      )
  - record: gitlab_component_errors:rate_1h
    labels:
      component: gitlab_sshd
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          rate(gitlab_sli:shell_sshd_sessions:errors_total{job="gitlab-shell",type="ops-gitlab-net"}[1h])
        )
      )
      or
      (
        0 * group by(environment) (
          gitlab_component_ops:rate_1h{component="gitlab_sshd",stage="main",tier="sv",type="ops-gitlab-net"}
        )
      )
  - record: gitlab_component_apdex:success:rate_1h
    labels:
      component: goserver
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        label_replace((
          sum by (environment) (
            rate(grpc_server_handling_seconds_bucket{grpc_method!~"CalculateChecksum|CommitLanguages|CommitStats|CreateFork|CreateRepositoryFromURL|FetchInternalRemote|FetchIntoObjectPool|FetchRemote|FetchSourceBranch|FindCommit|FindRemoteRepository|FindRemoteRootRef|Fsck|GarbageCollect|GetArchive|LastCommitForPath|OptimizeRepository|PackObjectsHookWithSidechannel|PostReceiveHook|PostUploadPackWithSidechannel|PreReceiveHook|RepackFull|RepackIncremental|ReplicateRepository|RepositorySize|SSHUploadPackWithSidechannel|UpdateHook|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="0.5",type="ops-gitlab-net"}[1h])
          )
          +
          sum by (environment) (
            rate(grpc_server_handling_seconds_bucket{grpc_method!~"CalculateChecksum|CommitLanguages|CommitStats|CreateFork|CreateRepositoryFromURL|FetchInternalRemote|FetchIntoObjectPool|FetchRemote|FetchSourceBranch|FindCommit|FindRemoteRepository|FindRemoteRootRef|Fsck|GarbageCollect|GetArchive|LastCommitForPath|OptimizeRepository|PackObjectsHookWithSidechannel|PostReceiveHook|PostUploadPackWithSidechannel|PreReceiveHook|RepackFull|RepackIncremental|ReplicateRepository|RepositorySize|SSHUploadPackWithSidechannel|UpdateHook|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="1",type="ops-gitlab-net"}[1h])
          )
        )
        /
        2
        , "_c", "0", "", "")
        or
        label_replace((
          sum by (environment) (
            rate(grpc_server_handling_seconds_bucket{grpc_method=~"FindCommit|GetArchive|LastCommitForPath|RepositorySize|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="10",type="ops-gitlab-net"}[1h])
          )
          +
          sum by (environment) (
            rate(grpc_server_handling_seconds_bucket{grpc_method=~"FindCommit|GetArchive|LastCommitForPath|RepositorySize|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="30",type="ops-gitlab-net"}[1h])
          )
        )
        /
        2
        , "_c", "1", "", "")
        or
        label_replace((
          sum by (environment) (
            rate(grpc_server_handling_seconds_bucket{grpc_service="gitaly.OperationService",grpc_type="unary",job="gitaly",le="10",type="ops-gitlab-net"}[1h])
          )
          +
          sum by (environment) (
            rate(grpc_server_handling_seconds_bucket{grpc_service="gitaly.OperationService",grpc_type="unary",job="gitaly",le="30",type="ops-gitlab-net"}[1h])
          )
        )
        /
        2
        , "_c", "2", "", "")
      )
  - record: gitlab_component_apdex:weight:score_1h
    labels:
      component: goserver
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        label_replace(sum by (environment) (
          rate(grpc_server_handling_seconds_bucket{grpc_method!~"CalculateChecksum|CommitLanguages|CommitStats|CreateFork|CreateRepositoryFromURL|FetchInternalRemote|FetchIntoObjectPool|FetchRemote|FetchSourceBranch|FindCommit|FindRemoteRepository|FindRemoteRootRef|Fsck|GarbageCollect|GetArchive|LastCommitForPath|OptimizeRepository|PackObjectsHookWithSidechannel|PostReceiveHook|PostUploadPackWithSidechannel|PreReceiveHook|RepackFull|RepackIncremental|ReplicateRepository|RepositorySize|SSHUploadPackWithSidechannel|UpdateHook|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="+Inf",type="ops-gitlab-net"}[1h])
        )
        , "_c", "0", "", "")
        or
        label_replace(sum by (environment) (
          rate(grpc_server_handling_seconds_bucket{grpc_method=~"FindCommit|GetArchive|LastCommitForPath|RepositorySize|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="+Inf",type="ops-gitlab-net"}[1h])
        )
        , "_c", "1", "", "")
        or
        label_replace(sum by (environment) (
          rate(grpc_server_handling_seconds_bucket{grpc_service="gitaly.OperationService",grpc_type="unary",job="gitaly",le="+Inf",type="ops-gitlab-net"}[1h])
        )
        , "_c", "2", "", "")
      )
  - record: gitlab_component_ops:rate_1h
    labels:
      component: goserver
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        rate(gitaly_service_client_requests_total{job="gitaly",type="ops-gitlab-net"}[1h])
      )
  - record: gitlab_component_errors:rate_1h
    labels:
      component: goserver
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          label_replace(rate(gitaly_service_client_requests_total{grpc_code!~"AlreadyExists|Canceled|DeadlineExceeded|FailedPrecondition|InvalidArgument|NotFound|OK|PermissionDenied|ResourceExhausted|Unauthenticated",job="gitaly",type="ops-gitlab-net"}[1h]), "_c", "0", "", "")
          or
          label_replace(rate(gitaly_service_client_requests_total{deadline_type!="limited",grpc_code="DeadlineExceeded",job="gitaly",type="ops-gitlab-net"}[1h]), "_c", "1", "", "")
        )
      )
      or
      (
        0 * group by(environment) (
          gitlab_component_ops:rate_1h{component="goserver",stage="main",tier="sv",type="ops-gitlab-net"}
        )
      )
  - record: gitlab_component_apdex:success:rate_1h
    labels:
      component: puma
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        sli_aggregations:gitlab_sli_rails_request_apdex_success_total_rate1h{job="gitlab-rails",type="ops-gitlab-net"}
      )
  - record: gitlab_component_apdex:weight:score_1h
    labels:
      component: puma
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        sli_aggregations:gitlab_sli_rails_request_apdex_total_rate1h{job="gitlab-rails",type="ops-gitlab-net"}
      )
  - record: gitlab_component_ops:rate_1h
    labels:
      component: puma
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        sli_aggregations:http_requests_total_rate1h{job="gitlab-rails",type="ops-gitlab-net"}
      )
  - record: gitlab_component_errors:rate_1h
    labels:
      component: puma
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          sli_aggregations:http_requests_total_rate1h{job="gitlab-rails",status=~"5..",type="ops-gitlab-net"}
        )
      )
      or
      (
        0 * group by(environment) (
          gitlab_component_ops:rate_1h{component="puma",stage="main",tier="sv",type="ops-gitlab-net"}
        )
      )
  - record: gitlab_component_apdex:success:rate_1h
    labels:
      component: registry_server
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          rate(registry_http_request_duration_seconds_bucket{job="registry",le="2.5",route!~"/v2/{name}/blobs/uploads/{uuid}|/v2/{name}/manifests/{reference}",type="ops-gitlab-net"}[1h])
        )
        +
        sum by (environment) (
          rate(registry_http_request_duration_seconds_bucket{job="registry",le="25",route!~"/v2/{name}/blobs/uploads/{uuid}|/v2/{name}/manifests/{reference}",type="ops-gitlab-net"}[1h])
        )
      )
      /
      2
  - record: gitlab_component_apdex:weight:score_1h
    labels:
      component: registry_server
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        rate(registry_http_request_duration_seconds_bucket{job="registry",le="+Inf",route!~"/v2/{name}/blobs/uploads/{uuid}|/v2/{name}/manifests/{reference}",type="ops-gitlab-net"}[1h])
      )
  - record: gitlab_component_ops:rate_1h
    labels:
      component: registry_server
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        rate(registry_http_requests_total{job="registry",type="ops-gitlab-net"}[1h])
      )
  - record: gitlab_component_errors:rate_1h
    labels:
      component: registry_server
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          rate(registry_http_requests_total{code=~"5..",job="registry",type="ops-gitlab-net"}[1h])
        )
      )
      or
      (
        0 * group by(environment) (
          gitlab_component_ops:rate_1h{component="registry_server",stage="main",tier="sv",type="ops-gitlab-net"}
        )
      )
  - record: gitlab_component_apdex:success:rate_1h
    labels:
      component: shard_default
      stage: main
      tier: sv
      type: ops-gitlab-net
      upscale_source: "yes"
    expr: |
      sum by (environment) (
        label_replace(sum by (environment) (
          sli_aggregations:sidekiq_jobs_completion_seconds_bucket_rate1h{job="sidekiq",le="10",type="ops-gitlab-net",urgency="high"}
        )
        , "_c", "0", "", "")
        or
        label_replace(sum by (environment) (
          sli_aggregations:sidekiq_jobs_queue_duration_seconds_bucket_rate1h{job="sidekiq",le="10",type="ops-gitlab-net",urgency="high"}
        )
        , "_c", "1", "", "")
        or
        label_replace(sum by (environment) (
          sli_aggregations:sidekiq_jobs_completion_seconds_bucket_rate1h{job="sidekiq",le="300",type="ops-gitlab-net",urgency="low"}
        )
        , "_c", "2", "", "")
        or
        label_replace(sum by (environment) (
          sli_aggregations:sidekiq_jobs_queue_duration_seconds_bucket_rate1h{job="sidekiq",le="60",type="ops-gitlab-net",urgency="low"}
        )
        , "_c", "3", "", "")
        or
        label_replace(sum by (environment) (
          sli_aggregations:sidekiq_jobs_completion_seconds_bucket_rate1h{job="sidekiq",le="300",type="ops-gitlab-net",urgency="throttled"}
        )
        , "_c", "4", "", "")
      )
  - record: gitlab_component_apdex:weight:score_1h
    labels:
      component: shard_default
      stage: main
      tier: sv
      type: ops-gitlab-net
      upscale_source: "yes"
    expr: |
      sum by (environment) (
        label_replace(sum by (environment) (
          sli_aggregations:sidekiq_jobs_completion_seconds_bucket_rate1h{job="sidekiq",le="+Inf",type="ops-gitlab-net",urgency="high"}
        )
        , "_c", "0", "", "")
        or
        label_replace(sum by (environment) (
          sli_aggregations:sidekiq_jobs_queue_duration_seconds_bucket_rate1h{job="sidekiq",le="+Inf",type="ops-gitlab-net",urgency="high"}
        )
        , "_c", "1", "", "")
        or
        label_replace(sum by (environment) (
          sli_aggregations:sidekiq_jobs_completion_seconds_bucket_rate1h{job="sidekiq",le="+Inf",type="ops-gitlab-net",urgency="low"}
        )
        , "_c", "2", "", "")
        or
        label_replace(sum by (environment) (
          sli_aggregations:sidekiq_jobs_queue_duration_seconds_bucket_rate1h{job="sidekiq",le="+Inf",type="ops-gitlab-net",urgency="low"}
        )
        , "_c", "3", "", "")
        or
        label_replace(sum by (environment) (
          sli_aggregations:sidekiq_jobs_completion_seconds_bucket_rate1h{job="sidekiq",le="+Inf",type="ops-gitlab-net",urgency="throttled"}
        )
        , "_c", "4", "", "")
      )
  - record: gitlab_component_ops:rate_1h
    labels:
      component: shard_default
      stage: main
      tier: sv
      type: ops-gitlab-net
      upscale_source: "yes"
    expr: |
      sum by (environment) (
        sli_aggregations:sidekiq_jobs_completion_seconds_bucket_rate1h{job="sidekiq",le="+Inf",type="ops-gitlab-net"}
      )
  - record: gitlab_component_errors:rate_1h
    labels:
      component: shard_default
      stage: main
      tier: sv
      type: ops-gitlab-net
      upscale_source: "yes"
    expr: |
      (
        sum by (environment) (
          sli_aggregations:sidekiq_jobs_failed_total_rate1h{job="sidekiq",type="ops-gitlab-net"}
        )
      )
      or
      (
        0 * group by(environment) (
          gitlab_component_ops:rate_1h{component="shard_default",stage="main",tier="sv",type="ops-gitlab-net",upscale_source="yes"}
        )
      )
  - record: gitlab_component_apdex:success:rate_1h
    labels:
      component: workhorse
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          rate(gitlab_workhorse_http_request_duration_seconds_bucket{job="gitlab-workhorse",le="1",route!="^/([^/]+/){1,}[^/]+/uploads\\z",route!="^/-/health$",route!="^/-/(readiness|liveness)$",route!="^/([^/]+/){1,}[^/]+\\.git/git-receive-pack\\z",route!="^/([^/]+/){1,}[^/]+\\.git/git-upload-pack\\z",route!="^/([^/]+/){1,}[^/]+\\.git/info/refs\\z",route!="^/([^/]+/){1,}[^/]+\\.git/gitlab-lfs/objects/([0-9a-f]{64})/([0-9]+)\\z",type="ops-gitlab-net"}[1h])
        )
        +
        sum by (environment) (
          rate(gitlab_workhorse_http_request_duration_seconds_bucket{job="gitlab-workhorse",le="10",route!="^/([^/]+/){1,}[^/]+/uploads\\z",route!="^/-/health$",route!="^/-/(readiness|liveness)$",route!="^/([^/]+/){1,}[^/]+\\.git/git-receive-pack\\z",route!="^/([^/]+/){1,}[^/]+\\.git/git-upload-pack\\z",route!="^/([^/]+/){1,}[^/]+\\.git/info/refs\\z",route!="^/([^/]+/){1,}[^/]+\\.git/gitlab-lfs/objects/([0-9a-f]{64})/([0-9]+)\\z",type="ops-gitlab-net"}[1h])
        )
      )
      /
      2
  - record: gitlab_component_apdex:weight:score_1h
    labels:
      component: workhorse
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        rate(gitlab_workhorse_http_request_duration_seconds_bucket{job="gitlab-workhorse",le="+Inf",route!="^/([^/]+/){1,}[^/]+/uploads\\z",route!="^/-/health$",route!="^/-/(readiness|liveness)$",route!="^/([^/]+/){1,}[^/]+\\.git/git-receive-pack\\z",route!="^/([^/]+/){1,}[^/]+\\.git/git-upload-pack\\z",route!="^/([^/]+/){1,}[^/]+\\.git/info/refs\\z",route!="^/([^/]+/){1,}[^/]+\\.git/gitlab-lfs/objects/([0-9a-f]{64})/([0-9]+)\\z",type="ops-gitlab-net"}[1h])
      )
  - record: gitlab_component_ops:rate_1h
    labels:
      component: workhorse
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        rate(gitlab_workhorse_http_requests_total{job="gitlab-workhorse",type="ops-gitlab-net"}[1h])
      )
  - record: gitlab_component_errors:rate_1h
    labels:
      component: workhorse
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          rate(gitlab_workhorse_http_requests_total{code=~"^5.*",job="gitlab-workhorse",route!="^/-/health$",route!="^/-/(readiness|liveness)$",type="ops-gitlab-net"}[1h])
        )
      )
      or
      (
        0 * group by(environment) (
          gitlab_component_ops:rate_1h{component="workhorse",stage="main",tier="sv",type="ops-gitlab-net"}
        )
      )
- name: 'Component-Level SLIs: ops-gitlab-net - 6h burn-rate'
  interval: 2m
  rules:
  - record: gitlab_component_ops:rate_6h
    labels:
      component: email_receiver
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        rate(sidekiq_jobs_completion_seconds_count{job="sidekiq",type="ops-gitlab-net",worker=~"EmailReceiverWorker|ServiceDeskEmailReceiverWorker"}[6h])
      )
  - record: gitlab_component_errors:rate_6h
    labels:
      component: email_receiver
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          rate(gitlab_transaction_event_email_receiver_error_total{error!="Gitlab::Email::AutoGeneratedEmailError",job="sidekiq",type="ops-gitlab-net"}[6h])
        )
      )
      or
      (
        0 * group by(environment) (
          gitlab_component_ops:rate_6h{component="email_receiver",stage="main",tier="sv",type="ops-gitlab-net"}
        )
      )
  - record: gitlab_component_apdex:success:rate_6h
    labels:
      component: gitlab_sshd
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          rate(gitlab_shell_sshd_session_established_duration_seconds_bucket{job="gitlab-shell",le="1",type="ops-gitlab-net"}[6h])
        )
        +
        sum by (environment) (
          rate(gitlab_shell_sshd_session_established_duration_seconds_bucket{job="gitlab-shell",le="5",type="ops-gitlab-net"}[6h])
        )
      )
      /
      2
  - record: gitlab_component_apdex:weight:score_6h
    labels:
      component: gitlab_sshd
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        rate(gitlab_shell_sshd_session_established_duration_seconds_bucket{job="gitlab-shell",le="+Inf",type="ops-gitlab-net"}[6h])
      )
  - record: gitlab_component_ops:rate_6h
    labels:
      component: gitlab_sshd
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        rate(gitlab_sli:shell_sshd_sessions:total{job="gitlab-shell",type="ops-gitlab-net"}[6h])
      )
  - record: gitlab_component_errors:rate_6h
    labels:
      component: gitlab_sshd
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          rate(gitlab_sli:shell_sshd_sessions:errors_total{job="gitlab-shell",type="ops-gitlab-net"}[6h])
        )
      )
      or
      (
        0 * group by(environment) (
          gitlab_component_ops:rate_6h{component="gitlab_sshd",stage="main",tier="sv",type="ops-gitlab-net"}
        )
      )
  - record: gitlab_component_apdex:success:rate_6h
    labels:
      component: goserver
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        label_replace((
          sum by (environment) (
            rate(grpc_server_handling_seconds_bucket{grpc_method!~"CalculateChecksum|CommitLanguages|CommitStats|CreateFork|CreateRepositoryFromURL|FetchInternalRemote|FetchIntoObjectPool|FetchRemote|FetchSourceBranch|FindCommit|FindRemoteRepository|FindRemoteRootRef|Fsck|GarbageCollect|GetArchive|LastCommitForPath|OptimizeRepository|PackObjectsHookWithSidechannel|PostReceiveHook|PostUploadPackWithSidechannel|PreReceiveHook|RepackFull|RepackIncremental|ReplicateRepository|RepositorySize|SSHUploadPackWithSidechannel|UpdateHook|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="0.5",type="ops-gitlab-net"}[6h])
          )
          +
          sum by (environment) (
            rate(grpc_server_handling_seconds_bucket{grpc_method!~"CalculateChecksum|CommitLanguages|CommitStats|CreateFork|CreateRepositoryFromURL|FetchInternalRemote|FetchIntoObjectPool|FetchRemote|FetchSourceBranch|FindCommit|FindRemoteRepository|FindRemoteRootRef|Fsck|GarbageCollect|GetArchive|LastCommitForPath|OptimizeRepository|PackObjectsHookWithSidechannel|PostReceiveHook|PostUploadPackWithSidechannel|PreReceiveHook|RepackFull|RepackIncremental|ReplicateRepository|RepositorySize|SSHUploadPackWithSidechannel|UpdateHook|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="1",type="ops-gitlab-net"}[6h])
          )
        )
        /
        2
        , "_c", "0", "", "")
        or
        label_replace((
          sum by (environment) (
            rate(grpc_server_handling_seconds_bucket{grpc_method=~"FindCommit|GetArchive|LastCommitForPath|RepositorySize|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="10",type="ops-gitlab-net"}[6h])
          )
          +
          sum by (environment) (
            rate(grpc_server_handling_seconds_bucket{grpc_method=~"FindCommit|GetArchive|LastCommitForPath|RepositorySize|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="30",type="ops-gitlab-net"}[6h])
          )
        )
        /
        2
        , "_c", "1", "", "")
        or
        label_replace((
          sum by (environment) (
            rate(grpc_server_handling_seconds_bucket{grpc_service="gitaly.OperationService",grpc_type="unary",job="gitaly",le="10",type="ops-gitlab-net"}[6h])
          )
          +
          sum by (environment) (
            rate(grpc_server_handling_seconds_bucket{grpc_service="gitaly.OperationService",grpc_type="unary",job="gitaly",le="30",type="ops-gitlab-net"}[6h])
          )
        )
        /
        2
        , "_c", "2", "", "")
      )
  - record: gitlab_component_apdex:weight:score_6h
    labels:
      component: goserver
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        label_replace(sum by (environment) (
          rate(grpc_server_handling_seconds_bucket{grpc_method!~"CalculateChecksum|CommitLanguages|CommitStats|CreateFork|CreateRepositoryFromURL|FetchInternalRemote|FetchIntoObjectPool|FetchRemote|FetchSourceBranch|FindCommit|FindRemoteRepository|FindRemoteRootRef|Fsck|GarbageCollect|GetArchive|LastCommitForPath|OptimizeRepository|PackObjectsHookWithSidechannel|PostReceiveHook|PostUploadPackWithSidechannel|PreReceiveHook|RepackFull|RepackIncremental|ReplicateRepository|RepositorySize|SSHUploadPackWithSidechannel|UpdateHook|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="+Inf",type="ops-gitlab-net"}[6h])
        )
        , "_c", "0", "", "")
        or
        label_replace(sum by (environment) (
          rate(grpc_server_handling_seconds_bucket{grpc_method=~"FindCommit|GetArchive|LastCommitForPath|RepositorySize|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="+Inf",type="ops-gitlab-net"}[6h])
        )
        , "_c", "1", "", "")
        or
        label_replace(sum by (environment) (
          rate(grpc_server_handling_seconds_bucket{grpc_service="gitaly.OperationService",grpc_type="unary",job="gitaly",le="+Inf",type="ops-gitlab-net"}[6h])
        )
        , "_c", "2", "", "")
      )
  - record: gitlab_component_ops:rate_6h
    labels:
      component: goserver
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        rate(gitaly_service_client_requests_total{job="gitaly",type="ops-gitlab-net"}[6h])
      )
  - record: gitlab_component_errors:rate_6h
    labels:
      component: goserver
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          label_replace(rate(gitaly_service_client_requests_total{grpc_code!~"AlreadyExists|Canceled|DeadlineExceeded|FailedPrecondition|InvalidArgument|NotFound|OK|PermissionDenied|ResourceExhausted|Unauthenticated",job="gitaly",type="ops-gitlab-net"}[6h]), "_c", "0", "", "")
          or
          label_replace(rate(gitaly_service_client_requests_total{deadline_type!="limited",grpc_code="DeadlineExceeded",job="gitaly",type="ops-gitlab-net"}[6h]), "_c", "1", "", "")
        )
      )
      or
      (
        0 * group by(environment) (
          gitlab_component_ops:rate_6h{component="goserver",stage="main",tier="sv",type="ops-gitlab-net"}
        )
      )
  - record: gitlab_component_apdex:success:rate_6h
    labels:
      component: puma
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        sli_aggregations:gitlab_sli_rails_request_apdex_success_total_rate6h{job="gitlab-rails",type="ops-gitlab-net"}
      )
  - record: gitlab_component_apdex:weight:score_6h
    labels:
      component: puma
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        sli_aggregations:gitlab_sli_rails_request_apdex_total_rate6h{job="gitlab-rails",type="ops-gitlab-net"}
      )
  - record: gitlab_component_ops:rate_6h
    labels:
      component: puma
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        sli_aggregations:http_requests_total_rate6h{job="gitlab-rails",type="ops-gitlab-net"}
      )
  - record: gitlab_component_errors:rate_6h
    labels:
      component: puma
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          sli_aggregations:http_requests_total_rate6h{job="gitlab-rails",status=~"5..",type="ops-gitlab-net"}
        )
      )
      or
      (
        0 * group by(environment) (
          gitlab_component_ops:rate_6h{component="puma",stage="main",tier="sv",type="ops-gitlab-net"}
        )
      )
  - record: gitlab_component_apdex:success:rate_6h
    labels:
      component: registry_server
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          rate(registry_http_request_duration_seconds_bucket{job="registry",le="2.5",route!~"/v2/{name}/blobs/uploads/{uuid}|/v2/{name}/manifests/{reference}",type="ops-gitlab-net"}[6h])
        )
        +
        sum by (environment) (
          rate(registry_http_request_duration_seconds_bucket{job="registry",le="25",route!~"/v2/{name}/blobs/uploads/{uuid}|/v2/{name}/manifests/{reference}",type="ops-gitlab-net"}[6h])
        )
      )
      /
      2
  - record: gitlab_component_apdex:weight:score_6h
    labels:
      component: registry_server
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        rate(registry_http_request_duration_seconds_bucket{job="registry",le="+Inf",route!~"/v2/{name}/blobs/uploads/{uuid}|/v2/{name}/manifests/{reference}",type="ops-gitlab-net"}[6h])
      )
  - record: gitlab_component_ops:rate_6h
    labels:
      component: registry_server
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        rate(registry_http_requests_total{job="registry",type="ops-gitlab-net"}[6h])
      )
  - record: gitlab_component_errors:rate_6h
    labels:
      component: registry_server
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          rate(registry_http_requests_total{code=~"5..",job="registry",type="ops-gitlab-net"}[6h])
        )
      )
      or
      (
        0 * group by(environment) (
          gitlab_component_ops:rate_6h{component="registry_server",stage="main",tier="sv",type="ops-gitlab-net"}
        )
      )
  - record: gitlab_component_apdex:success:rate_6h
    labels:
      component: workhorse
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          rate(gitlab_workhorse_http_request_duration_seconds_bucket{job="gitlab-workhorse",le="1",route!="^/([^/]+/){1,}[^/]+/uploads\\z",route!="^/-/health$",route!="^/-/(readiness|liveness)$",route!="^/([^/]+/){1,}[^/]+\\.git/git-receive-pack\\z",route!="^/([^/]+/){1,}[^/]+\\.git/git-upload-pack\\z",route!="^/([^/]+/){1,}[^/]+\\.git/info/refs\\z",route!="^/([^/]+/){1,}[^/]+\\.git/gitlab-lfs/objects/([0-9a-f]{64})/([0-9]+)\\z",type="ops-gitlab-net"}[6h])
        )
        +
        sum by (environment) (
          rate(gitlab_workhorse_http_request_duration_seconds_bucket{job="gitlab-workhorse",le="10",route!="^/([^/]+/){1,}[^/]+/uploads\\z",route!="^/-/health$",route!="^/-/(readiness|liveness)$",route!="^/([^/]+/){1,}[^/]+\\.git/git-receive-pack\\z",route!="^/([^/]+/){1,}[^/]+\\.git/git-upload-pack\\z",route!="^/([^/]+/){1,}[^/]+\\.git/info/refs\\z",route!="^/([^/]+/){1,}[^/]+\\.git/gitlab-lfs/objects/([0-9a-f]{64})/([0-9]+)\\z",type="ops-gitlab-net"}[6h])
        )
      )
      /
      2
  - record: gitlab_component_apdex:weight:score_6h
    labels:
      component: workhorse
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        rate(gitlab_workhorse_http_request_duration_seconds_bucket{job="gitlab-workhorse",le="+Inf",route!="^/([^/]+/){1,}[^/]+/uploads\\z",route!="^/-/health$",route!="^/-/(readiness|liveness)$",route!="^/([^/]+/){1,}[^/]+\\.git/git-receive-pack\\z",route!="^/([^/]+/){1,}[^/]+\\.git/git-upload-pack\\z",route!="^/([^/]+/){1,}[^/]+\\.git/info/refs\\z",route!="^/([^/]+/){1,}[^/]+\\.git/gitlab-lfs/objects/([0-9a-f]{64})/([0-9]+)\\z",type="ops-gitlab-net"}[6h])
      )
  - record: gitlab_component_ops:rate_6h
    labels:
      component: workhorse
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      sum by (environment) (
        rate(gitlab_workhorse_http_requests_total{job="gitlab-workhorse",type="ops-gitlab-net"}[6h])
      )
  - record: gitlab_component_errors:rate_6h
    labels:
      component: workhorse
      stage: main
      tier: sv
      type: ops-gitlab-net
    expr: |
      (
        sum by (environment) (
          rate(gitlab_workhorse_http_requests_total{code=~"^5.*",job="gitlab-workhorse",route!="^/-/health$",route!="^/-/(readiness|liveness)$",type="ops-gitlab-net"}[6h])
        )
      )
      or
      (
        0 * group by(environment) (
          gitlab_component_ops:rate_6h{component="workhorse",stage="main",tier="sv",type="ops-gitlab-net"}
        )
      )
- name: 'Component mapping: ops-gitlab-net'
  interval: 1m
  rules:
  - record: gitlab_component_service:mapping
    labels:
      component: email_receiver
      global_aggregation: "no"
      regional_aggregation: "no"
      service_aggregation: "yes"
      tier: sv
      type: ops-gitlab-net
    expr: "1"
  - record: gitlab_component_service:mapping
    labels:
      component: gitlab_sshd
      global_aggregation: "no"
      regional_aggregation: "no"
      service_aggregation: "yes"
      tier: sv
      type: ops-gitlab-net
    expr: "1"
  - record: gitlab_component_service:mapping
    labels:
      component: goserver
      global_aggregation: "no"
      regional_aggregation: "no"
      service_aggregation: "yes"
      tier: sv
      type: ops-gitlab-net
    expr: "1"
  - record: gitlab_component_service:mapping
    labels:
      component: puma
      global_aggregation: "no"
      regional_aggregation: "no"
      service_aggregation: "yes"
      tier: sv
      type: ops-gitlab-net
    expr: "1"
  - record: gitlab_component_service:mapping
    labels:
      component: registry_server
      global_aggregation: "no"
      regional_aggregation: "no"
      service_aggregation: "yes"
      tier: sv
      type: ops-gitlab-net
    expr: "1"
  - record: gitlab_component_service:mapping
    labels:
      component: shard_default
      global_aggregation: "no"
      regional_aggregation: "no"
      service_aggregation: "yes"
      tier: sv
      type: ops-gitlab-net
    expr: "1"
  - record: gitlab_component_service:mapping
    labels:
      component: workhorse
      global_aggregation: "no"
      regional_aggregation: "no"
      service_aggregation: "yes"
      tier: sv
      type: ops-gitlab-net
    expr: "1"
