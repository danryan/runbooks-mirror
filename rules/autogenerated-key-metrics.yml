# WARNING. DO NOT EDIT THIS FILE BY HAND. USE ./scripts/generate-key-metric-recording-rules.sh TO GENERATE IT
# YOUR CHANGES WILL BE OVERRIDDEN
groups:
- name: Autogenerated Service SLOs
  interval: 5m
  rules:
  - record: slo:min:gitlab_service_apdex:ratio
    labels:
      alert_trigger_duration: long
      tier: runners
      type: ci-runners
    expr: '0.8'
  - record: slo:max:gitlab_service_errors:ratio
    labels:
      alert_trigger_duration: long
      tier: runners
      type: ci-runners
    expr: '0.2'
  - record: slo:min:gitlab_service_apdex:ratio
    labels:
      tier: lb
      type: frontend
    expr: '0.9'
  - record: slo:max:gitlab_service_errors:ratio
    labels:
      tier: lb
      type: frontend
    expr: '0.0005'
  - record: slo:max:gitlab_service_errors:ratio
    labels:
      tier: stor
      type: nfs
    expr: '0.0001'
  - record: slo:min:gitlab_service_apdex:ratio
    labels:
      tier: db
      type: patroni
    expr: '0.95'
  - record: slo:max:gitlab_service_errors:ratio
    labels:
      tier: db
      type: patroni
    expr: '0.005'
  - record: slo:min:gitlab_service_apdex:ratio
    labels:
      tier: stor
      type: praefect
    expr: '0.995'
  - record: slo:max:gitlab_service_errors:ratio
    labels:
      tier: stor
      type: praefect
    expr: '0.001'
- name: Autogenerated Component Recording Rules
  interval: 1m
  rules:
  - record: gitlab_component_ops:rate
    labels:
      component: polling
      tier: runners
      type: ci-runners
    expr: |
      sum by (environment, stage) (
        rate(gitlab_workhorse_builds_register_handler_requests{}[1m])
      )
  - record: gitlab_component_errors:rate
    labels:
      component: polling
      tier: runners
      type: ci-runners
    expr: |
      sum by (environment, stage) (
        rate(gitlab_workhorse_builds_register_handler_requests{status=~"body-parse-error|body-read-error|missing-values|watch-error"}[1m])
      )
  - record: gitlab_component_apdex:ratio
    labels:
      component: shared_runner_queues
      environment: gprd
      stage: main
      tier: runners
      type: ci-runners
    expr: |
      (
        sum by () (
          rate(job_queue_duration_seconds_bucket{shared_runner="true", jobs_running_for_project=~"^(0|1|2|3|4)$", le="60"}[1m])
        )
      )
      /
      (
        sum by () (
          rate(job_queue_duration_seconds_bucket{shared_runner="true", jobs_running_for_project=~"^(0|1|2|3|4)$", le="+Inf"}[1m])
        ) > 0
      )
  - record: gitlab_component_apdex:weight:score
    labels:
      component: shared_runner_queues
      environment: gprd
      stage: main
      tier: runners
      type: ci-runners
    expr: |
      sum by () (
        rate(job_queue_duration_seconds_bucket{shared_runner="true", jobs_running_for_project=~"^(0|1|2|3|4)$", le="+Inf"}[1m])
      )
  - record: gitlab_component_ops:rate
    labels:
      component: shared_runner_queues
      environment: gprd
      stage: main
      tier: runners
      type: ci-runners
    expr: |
      sum by () (
        rate(gitlab_runner_jobs_total{job="shared-runners"}[1m])
      )
  - record: gitlab_component_errors:rate
    labels:
      component: shared_runner_queues
      environment: gprd
      stage: main
      tier: runners
      type: ci-runners
    expr: |
      sum by () (
        rate(gitlab_runner_failed_jobs_total{job="shared-runners", failure_reason="runner_system_failure"}[1m])
      )
  - record: gitlab_component_apdex:ratio
    labels:
      component: cnyHttpServices
      stage: cny
      tier: lb
      type: frontend
    expr: |
      (
        sum by (environment) (
          rate(haproxy_http_response_duration_seconds_bucket{type="frontend", backend_name=~"canary_.*", le="5"}[1m])
        )
      )
      /
      (
        sum by (environment) (
          rate(haproxy_http_response_duration_seconds_bucket{type="frontend", backend_name=~"canary_.*", le="+Inf"}[1m])
        ) > 0
      )
  - record: gitlab_component_apdex:weight:score
    labels:
      component: cnyHttpServices
      stage: cny
      tier: lb
      type: frontend
    expr: |
      sum by (environment) (
        rate(haproxy_http_response_duration_seconds_bucket{type="frontend", backend_name=~"canary_.*", le="+Inf"}[1m])
      )
  - record: gitlab_component_ops:rate
    labels:
      component: cnyHttpServices
      stage: cny
      tier: lb
      type: frontend
    expr: |
      sum by (environment) (
        rate(haproxy_backend_http_responses_total{type="frontend", backend=~"canary_.*"}[1m])
      )
  - record: gitlab_component_errors:rate
    labels:
      component: cnyHttpServices
      stage: cny
      tier: lb
      type: frontend
    expr: |
      sum by (environment) (
        rate(haproxy_backend_response_errors_total{type="frontend", backend=~"canary_.*"}[1m])
      )
  - record: gitlab_component_apdex:ratio
    labels:
      component: mainHttpServices
      stage: main
      tier: lb
      type: frontend
    expr: |
      (
        sum by (environment) (
          rate(haproxy_http_response_duration_seconds_bucket{type="frontend", backend_name!~"canary_.*", backend_name!="api_rate_limit", backend_name!="websockets", le="5"}[1m])
        )
      )
      /
      (
        sum by (environment) (
          rate(haproxy_http_response_duration_seconds_bucket{type="frontend", backend_name!~"canary_.*", backend_name!="api_rate_limit", backend_name!="websockets", le="+Inf"}[1m])
        ) > 0
      )
  - record: gitlab_component_apdex:weight:score
    labels:
      component: mainHttpServices
      stage: main
      tier: lb
      type: frontend
    expr: |
      sum by (environment) (
        rate(haproxy_http_response_duration_seconds_bucket{type="frontend", backend_name!~"canary_.*", backend_name!="api_rate_limit", backend_name!="websockets", le="+Inf"}[1m])
      )
  - record: gitlab_component_ops:rate
    labels:
      component: mainHttpServices
      stage: main
      tier: lb
      type: frontend
    expr: |
      sum by (environment) (
        rate(haproxy_backend_http_responses_total{type="frontend", backend!~"canary_.*"}[1m])
      )
  - record: gitlab_component_errors:rate
    labels:
      component: mainHttpServices
      stage: main
      tier: lb
      type: frontend
    expr: |
      sum by (environment) (
        rate(haproxy_backend_response_errors_total{type="frontend", backend!~"canary_.*"}[1m])
      )
  - record: gitlab_component_apdex:ratio
    labels:
      component: sshServices
      tier: lb
      type: frontend
    expr: |
      (
        sum by (environment, stage) (
          rate(haproxy_ssh_request_duration_seconds_bucket{type="frontend", le="8"}[1m])
        )
      )
      /
      (
        sum by (environment, stage) (
          rate(haproxy_ssh_request_duration_seconds_bucket{type="frontend", le="+Inf"}[1m])
        ) > 0
      )
  - record: gitlab_component_apdex:weight:score
    labels:
      component: sshServices
      tier: lb
      type: frontend
    expr: |
      sum by (environment, stage) (
        rate(haproxy_ssh_request_duration_seconds_bucket{type="frontend", le="+Inf"}[1m])
      )
  - record: gitlab_component_ops:rate
    labels:
      component: sshServices
      tier: lb
      type: frontend
    expr: |
      sum by (environment, stage) (
        rate(haproxy_ssh_requests_total{type="frontend"}[1m])
      )
  - record: gitlab_component_errors:rate
    labels:
      component: sshServices
      tier: lb
      type: frontend
    expr: |
      sum by (environment, stage) (
        rate(haproxy_ssh_requests_terminated_total{type="frontend", cause=~"K|S|s|P|I|D"}[1m])
      )
  - record: gitlab_component_ops:rate
    labels:
      component: grafana
      tier: inf
      type: monitoring
    expr: |
      sum by (environment, stage) (
        rate(http_request_total{job="grafana"}[1m])
      )
  - record: gitlab_component_errors:rate
    labels:
      component: grafana
      tier: inf
      type: monitoring
    expr: |
      sum by (environment, stage) (
        rate(http_request_total{job="grafana", statuscode=~"^5.*"}[1m])
      )
  - record: gitlab_component_apdex:ratio
    labels:
      component: prometheus
      tier: inf
      type: monitoring
    expr: |
      (
        sum by (environment, stage) (
          rate(prometheus_http_request_duration_seconds_bucket{job="prometheus", type="monitoring", le="0.2"}[1m])
        )
        +
        sum by (environment, stage) (
          rate(prometheus_http_request_duration_seconds_bucket{job="prometheus", type="monitoring", le="0.4"}[1m])
        )
      )
      /
      2
      /
      (
        sum by (environment, stage) (
          rate(prometheus_http_request_duration_seconds_bucket{job="prometheus", type="monitoring", le="+Inf"}[1m])
        ) > 0
      )
  - record: gitlab_component_apdex:weight:score
    labels:
      component: prometheus
      tier: inf
      type: monitoring
    expr: |
      sum by (environment, stage) (
        rate(prometheus_http_request_duration_seconds_bucket{job="prometheus", type="monitoring", le="+Inf"}[1m])
      )
  - record: gitlab_component_ops:rate
    labels:
      component: prometheus
      tier: inf
      type: monitoring
    expr: |
      sum by (environment, stage) (
        rate(prometheus_http_requests_total{job="prometheus", type="monitoring"}[1m])
      )
  - record: gitlab_component_errors:rate
    labels:
      component: prometheus
      tier: inf
      type: monitoring
    expr: |
      sum by (environment, stage) (
        rate(prometheus_http_requests_total{job="prometheus", type="monitoring", code=~"^5.*"}[1m])
      )
  - record: gitlab_component_apdex:ratio
    labels:
      component: thanos_query
      tier: inf
      type: monitoring
    expr: |
      (
        sum by (environment, stage) (
          rate(http_request_duration_seconds_bucket{job="thanos", type="monitoring", le="1"}[1m])
        )
        +
        sum by (environment, stage) (
          rate(http_request_duration_seconds_bucket{job="thanos", type="monitoring", le="5"}[1m])
        )
      )
      /
      2
      /
      (
        sum by (environment, stage) (
          rate(http_request_duration_seconds_bucket{job="thanos", type="monitoring", le="+Inf"}[1m])
        ) > 0
      )
  - record: gitlab_component_apdex:weight:score
    labels:
      component: thanos_query
      tier: inf
      type: monitoring
    expr: |
      sum by (environment, stage) (
        rate(http_request_duration_seconds_bucket{job="thanos", type="monitoring", le="+Inf"}[1m])
      )
  - record: gitlab_component_ops:rate
    labels:
      component: thanos_query
      tier: inf
      type: monitoring
    expr: |
      sum by (environment, stage) (
        rate(http_requests_total{job="thanos", type="monitoring"}[1m])
      )
  - record: gitlab_component_errors:rate
    labels:
      component: thanos_query
      tier: inf
      type: monitoring
    expr: |
      sum by (environment, stage) (
        rate(http_requests_total{job="thanos", type="monitoring", code=~"^5.*"}[1m])
      )
  - record: gitlab_component_apdex:ratio
    labels:
      component: thanos_store
      tier: inf
      type: monitoring
    expr: |
      (
        sum by (environment, stage) (
          rate(grpc_server_handling_seconds_bucket{job="thanos", type="monitoring", grpc_service="thanos.Store", le="0.4"}[1m])
        )
        +
        sum by (environment, stage) (
          rate(grpc_server_handling_seconds_bucket{job="thanos", type="monitoring", grpc_service="thanos.Store", le="0.8"}[1m])
        )
      )
      /
      2
      /
      (
        sum by (environment, stage) (
          rate(grpc_server_handling_seconds_bucket{job="thanos", type="monitoring", grpc_service="thanos.Store", le="+Inf"}[1m])
        ) > 0
      )
  - record: gitlab_component_apdex:weight:score
    labels:
      component: thanos_store
      tier: inf
      type: monitoring
    expr: |
      sum by (environment, stage) (
        rate(grpc_server_handling_seconds_bucket{job="thanos", type="monitoring", grpc_service="thanos.Store", le="+Inf"}[1m])
      )
  - record: gitlab_component_ops:rate
    labels:
      component: thanos_store
      tier: inf
      type: monitoring
    expr: |
      sum by (environment, stage) (
        rate(grpc_server_handled_total{job="thanos", type="monitoring", grpc_service="thanos.Store"}[1m])
      )
  - record: gitlab_component_errors:rate
    labels:
      component: thanos_store
      tier: inf
      type: monitoring
    expr: |
      sum by (environment, stage) (
        rate(grpc_server_handled_total{job="thanos", type="monitoring", grpc_service="thanos.Store", grpc_code!="OK"}[1m])
      )
  - record: gitlab_component_ops:rate
    labels:
      component: nfs_service
      tier: stor
      type: nfs
    expr: |
      sum by (environment, stage) (
        rate(node_nfsd_server_rpcs_total{type="nfs"}[1m])
      )
  - record: gitlab_component_errors:rate
    labels:
      component: nfs_service
      tier: stor
      type: nfs
    expr: |
      sum by (environment, stage) (
        rate(node_nfsd_rpc_errors_total{type="nfs"}[1m])
      )
  - record: gitlab_component_ops:rate
    labels:
      component: pgbouncer
      tier: db
      type: patroni
    expr: |
      sum by (environment, stage) (
        rate(pgbouncer_stats_sql_transactions_pooled_total{type="patroni", tier="db"}[1m])
      )
      +
      sum by (environment, stage) (
        rate(pgbouncer_stats_queries_pooled_total{type="patroni", tier="db"}[1m])
      )
  - record: gitlab_component_apdex:ratio
    labels:
      component: rails_sql
      stage: main
      tier: db
      type: patroni
    expr: |
      (
        sum by (environment) (
          rate(gitlab_sql_duration_seconds_bucket{le="0.05"}[1m])
        )
        +
        sum by (environment) (
          rate(gitlab_sql_duration_seconds_bucket{le="0.1"}[1m])
        )
      )
      /
      2
      /
      (
        sum by (environment) (
          rate(gitlab_sql_duration_seconds_bucket{le="+Inf"}[1m])
        ) > 0
      )
  - record: gitlab_component_apdex:weight:score
    labels:
      component: rails_sql
      stage: main
      tier: db
      type: patroni
    expr: |
      sum by (environment) (
        rate(gitlab_sql_duration_seconds_bucket{le="+Inf"}[1m])
      )
  - record: gitlab_component_ops:rate
    labels:
      component: service
      tier: db
      type: patroni
    expr: |
      sum by (environment, stage) (
        rate(pg_stat_database_xact_commit{type="patroni", tier="db"}[1m])
      )
      +
      sum by (environment, stage) (
        rate(pg_stat_database_xact_rollback{type="patroni", tier="db"}[1m])
      )
  - record: gitlab_component_errors:rate
    labels:
      component: service
      tier: db
      type: patroni
    expr: |
      sum by (environment, stage) (
        rate(pg_stat_database_xact_rollback{type="patroni", tier="db"}[1m])
      )
  - record: gitlab_component_ops:rate
    labels:
      component: service
      tier: db
      type: pgbouncer
    expr: |
      sum by (environment, stage) (
        rate(pgbouncer_stats_sql_transactions_pooled_total{type="pgbouncer", tier="db"}[1m])
      )
      +
      sum by (environment, stage) (
        rate(pgbouncer_stats_queries_pooled_total{type="pgbouncer", tier="db"}[1m])
      )
  - record: gitlab_component_apdex:ratio
    labels:
      component: proxy
      tier: stor
      type: praefect
    expr: |
      (
        sum by (environment, stage) (
          rate(grpc_server_handling_seconds_bucket{job="praefect", grpc_type="unary", grpc_method!~"GarbageCollect|Fsck|RepackFull|RepackIncremental|CommitLanguages|CreateRepositoryFromURL|UserRebase|UserSquash|CreateFork|UserUpdateBranch|FindRemoteRepository|UserCherryPick|FetchRemote|UserRevert|FindRemoteRootRef", le="0.5"}[1m])
        )
        +
        sum by (environment, stage) (
          rate(grpc_server_handling_seconds_bucket{job="praefect", grpc_type="unary", grpc_method!~"GarbageCollect|Fsck|RepackFull|RepackIncremental|CommitLanguages|CreateRepositoryFromURL|UserRebase|UserSquash|CreateFork|UserUpdateBranch|FindRemoteRepository|UserCherryPick|FetchRemote|UserRevert|FindRemoteRootRef", le="1"}[1m])
        )
      )
      /
      2
      /
      (
        sum by (environment, stage) (
          rate(grpc_server_handling_seconds_bucket{job="praefect", grpc_type="unary", grpc_method!~"GarbageCollect|Fsck|RepackFull|RepackIncremental|CommitLanguages|CreateRepositoryFromURL|UserRebase|UserSquash|CreateFork|UserUpdateBranch|FindRemoteRepository|UserCherryPick|FetchRemote|UserRevert|FindRemoteRootRef", le="+Inf"}[1m])
        ) > 0
      )
  - record: gitlab_component_apdex:weight:score
    labels:
      component: proxy
      tier: stor
      type: praefect
    expr: |
      sum by (environment, stage) (
        rate(grpc_server_handling_seconds_bucket{job="praefect", grpc_type="unary", grpc_method!~"GarbageCollect|Fsck|RepackFull|RepackIncremental|CommitLanguages|CreateRepositoryFromURL|UserRebase|UserSquash|CreateFork|UserUpdateBranch|FindRemoteRepository|UserCherryPick|FetchRemote|UserRevert|FindRemoteRootRef", le="+Inf"}[1m])
      )
  - record: gitlab_component_ops:rate
    labels:
      component: proxy
      tier: stor
      type: praefect
    expr: |
      sum by (environment, stage) (
        rate(grpc_server_handled_total{job="praefect"}[1m])
      )
  - record: gitlab_component_errors:rate
    labels:
      component: proxy
      tier: stor
      type: praefect
    expr: |
      sum by (environment, stage) (
        rate(grpc_server_handled_total{job="praefect", grpc_code!~"^(OK|NotFound|Unauthenticated|AlreadyExists|FailedPrecondition)$"}[1m])
      )
