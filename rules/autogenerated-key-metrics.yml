# WARNING. DO NOT EDIT THIS FILE BY HAND. USE ./scripts/generate-key-metric-recording-rules.sh TO GENERATE IT
# YOUR CHANGES WILL BE OVERRIDDEN
groups:
- name: Autogenerated Service SLOs
  interval: 5m
  rules:
  - record: slo:min:gitlab_service_apdex:ratio
    labels:
      alert_trigger_duration: long
      tier: runners
      type: ci-runners
    expr: '0.8'
  - record: slo:max:gitlab_service_errors:ratio
    labels:
      alert_trigger_duration: long
      tier: runners
      type: ci-runners
    expr: '0.2'
  - record: slo:max:gitlab_service_errors:ratio
    labels:
      tier: stor
      type: nfs
    expr: '0.0001'
  - record: slo:min:gitlab_service_apdex:ratio
    labels:
      tier: stor
      type: praefect
    expr: '0.995'
  - record: slo:max:gitlab_service_errors:ratio
    labels:
      tier: stor
      type: praefect
    expr: '0.001'
- name: Autogenerated Component Recording Rules
  interval: 1m
  rules:
  - record: gitlab_component_ops:rate
    labels:
      component: polling
      tier: runners
      type: ci-runners
    expr: |
      sum by (environment, stage) (
        rate(gitlab_workhorse_builds_register_handler_requests{}[1m])
      )
  - record: gitlab_component_errors:rate
    labels:
      component: polling
      tier: runners
      type: ci-runners
    expr: |
      sum by (environment, stage) (
        rate(gitlab_workhorse_builds_register_handler_requests{status=~"body-parse-error|body-read-error|missing-values|watch-error"}[1m])
      )
  - record: gitlab_component_apdex:ratio
    labels:
      component: shared_runner_queues
      environment: gprd
      stage: main
      tier: runners
      type: ci-runners
    expr: |
      (
        sum by () (
          rate(job_queue_duration_seconds_bucket{shared_runner="true", jobs_running_for_project=~"^(0|1|2|3|4)$", le="60"}[1m])
        )
      )
      /
      (
        sum by () (
          rate(job_queue_duration_seconds_bucket{shared_runner="true", jobs_running_for_project=~"^(0|1|2|3|4)$", le="+Inf"}[1m])
        ) > 0
      )
  - record: gitlab_component_apdex:weight:score
    labels:
      component: shared_runner_queues
      environment: gprd
      stage: main
      tier: runners
      type: ci-runners
    expr: |
      sum by () (
        rate(job_queue_duration_seconds_bucket{shared_runner="true", jobs_running_for_project=~"^(0|1|2|3|4)$", le="+Inf"}[1m])
      )
  - record: gitlab_component_ops:rate
    labels:
      component: shared_runner_queues
      environment: gprd
      stage: main
      tier: runners
      type: ci-runners
    expr: |
      sum by () (
        rate(gitlab_runner_jobs_total{job="shared-runners"}[1m])
      )
  - record: gitlab_component_errors:rate
    labels:
      component: shared_runner_queues
      environment: gprd
      stage: main
      tier: runners
      type: ci-runners
    expr: |
      sum by () (
        rate(gitlab_runner_failed_jobs_total{job="shared-runners", failure_reason="runner_system_failure"}[1m])
      )
  - record: gitlab_component_ops:rate
    labels:
      component: nfs_service
      tier: stor
      type: nfs
    expr: |
      sum by (environment, stage) (
        rate(node_nfsd_server_rpcs_total{type="nfs"}[1m])
      )
  - record: gitlab_component_errors:rate
    labels:
      component: nfs_service
      tier: stor
      type: nfs
    expr: |
      sum by (environment, stage) (
        rate(node_nfsd_rpc_errors_total{type="nfs"}[1m])
      )
  - record: gitlab_component_apdex:ratio
    labels:
      component: proxy
      tier: stor
      type: praefect
    expr: |
      (
        sum by (environment, stage) (
          rate(grpc_server_handling_seconds_bucket{job="praefect", grpc_type="unary", grpc_method!~"GarbageCollect|Fsck|RepackFull|RepackIncremental|CommitLanguages|CreateRepositoryFromURL|UserRebase|UserSquash|CreateFork|UserUpdateBranch|FindRemoteRepository|UserCherryPick|FetchRemote|UserRevert|FindRemoteRootRef", le="0.5"}[1m])
        )
        +
        sum by (environment, stage) (
          rate(grpc_server_handling_seconds_bucket{job="praefect", grpc_type="unary", grpc_method!~"GarbageCollect|Fsck|RepackFull|RepackIncremental|CommitLanguages|CreateRepositoryFromURL|UserRebase|UserSquash|CreateFork|UserUpdateBranch|FindRemoteRepository|UserCherryPick|FetchRemote|UserRevert|FindRemoteRootRef", le="1"}[1m])
        )
      )
      /
      2
      /
      (
        sum by (environment, stage) (
          rate(grpc_server_handling_seconds_bucket{job="praefect", grpc_type="unary", grpc_method!~"GarbageCollect|Fsck|RepackFull|RepackIncremental|CommitLanguages|CreateRepositoryFromURL|UserRebase|UserSquash|CreateFork|UserUpdateBranch|FindRemoteRepository|UserCherryPick|FetchRemote|UserRevert|FindRemoteRootRef", le="+Inf"}[1m])
        ) > 0
      )
  - record: gitlab_component_apdex:weight:score
    labels:
      component: proxy
      tier: stor
      type: praefect
    expr: |
      sum by (environment, stage) (
        rate(grpc_server_handling_seconds_bucket{job="praefect", grpc_type="unary", grpc_method!~"GarbageCollect|Fsck|RepackFull|RepackIncremental|CommitLanguages|CreateRepositoryFromURL|UserRebase|UserSquash|CreateFork|UserUpdateBranch|FindRemoteRepository|UserCherryPick|FetchRemote|UserRevert|FindRemoteRootRef", le="+Inf"}[1m])
      )
  - record: gitlab_component_ops:rate
    labels:
      component: proxy
      tier: stor
      type: praefect
    expr: |
      sum by (environment, stage) (
        rate(grpc_server_handled_total{job="praefect"}[1m])
      )
  - record: gitlab_component_errors:rate
    labels:
      component: proxy
      tier: stor
      type: praefect
    expr: |
      sum by (environment, stage) (
        rate(grpc_server_handled_total{job="praefect", grpc_code!~"^(OK|NotFound|Unauthenticated|AlreadyExists|FailedPrecondition)$"}[1m])
      )
