# WARNING. DO NOT EDIT THIS FILE BY HAND. USE ./rules-jsonnet/saturation.jsonnet TO GENERATE IT
# YOUR CHANGES WILL BE OVERRIDDEN
groups:
- name: Saturation Rules (autogenerated)
  interval: 1m
  rules:
  - record: gitlab_component_saturation:ratio
    labels:
      component: active_db_connections
    expr: |
      max by(environment, tier, type, stage) (
        clamp_min(
          clamp_max(
            sum without (state) (
              pg_stat_activity_count{datname="gitlabhq_production", state!="idle", environment!="", type!=""}
            )
            / on (environment, tier, type, stage, fqdn)
            pg_settings_max_connections{environment!="", type!=""}
            ,
            1)
        ,
        0)
      )
  - record: gitlab_component_saturation:ratio
    labels:
      component: cgroup_memory
    expr: |
      max by(environment, tier, type, stage) (
        clamp_min(
          clamp_max(
            (
              container_memory_usage_bytes{id="/system.slice/gitlab-runsvdir.service", environment!="", type!=""} -
              container_memory_cache{id="/system.slice/gitlab-runsvdir.service", environment!="", type!=""} -
              container_memory_swap{id="/system.slice/gitlab-runsvdir.service", environment!="", type!=""}
            )
            /
            container_spec_memory_limit_bytes{id="/system.slice/gitlab-runsvdir.service", environment!="", type!=""}
            ,
            1)
        ,
        0)
      )
  - record: gitlab_component_saturation:ratio
    labels:
      component: cpu
    expr: |
      max by(environment, tier, type, stage) (
        clamp_min(
          clamp_max(
            1 - avg without(mode, cpu) (
              rate(node_cpu_seconds_total{mode="idle", type!~"console-node|deploy-node", environment!="", type!=""}[1m])
            )
            ,
            1)
        ,
        0)
      )
  - record: gitlab_component_saturation:ratio
    labels:
      component: disk_space
    expr: |
      max by(environment, tier, type, stage) (
        clamp_min(
          clamp_max(
            (
              1 - instance:node_filesystem_avail:ratio{fstype=~"ext.|xfs", environment!="", type!=""}
            )
            ,
            1)
        ,
        0)
      )
  - record: gitlab_component_saturation:ratio
    labels:
      component: disk_sustained_read_iops
    expr: |
      max by(environment, tier, type, stage) (
        clamp_min(
          clamp_max(
            rate(node_disk_reads_completed_total{environment!="", type!=""}[1m])
            /
            node_disk_max_read_iops{environment!="", type!=""}
            ,
            1)
        ,
        0)
      )
  - record: gitlab_component_saturation:ratio
    labels:
      component: disk_sustained_read_throughput
    expr: |
      max by(environment, tier, type, stage) (
        clamp_min(
          clamp_max(
            rate(node_disk_read_bytes_total{environment!="", type!=""}[1m])
            /
            node_disk_max_read_bytes_seconds{environment!="", type!=""}
            ,
            1)
        ,
        0)
      )
  - record: gitlab_component_saturation:ratio
    labels:
      component: disk_sustained_write_iops
    expr: |
      max by(environment, tier, type, stage) (
        clamp_min(
          clamp_max(
            rate(node_disk_writes_completed_total{environment!="", type!=""}[1m])
            /
            node_disk_max_write_iops{environment!="", type!=""}
            ,
            1)
        ,
        0)
      )
  - record: gitlab_component_saturation:ratio
    labels:
      component: disk_sustained_write_throughput
    expr: |
      max by(environment, tier, type, stage) (
        clamp_min(
          clamp_max(
            rate(node_disk_written_bytes_total{environment!="", type!=""}[1m])
            /
            node_disk_max_write_bytes_seconds{environment!="", type!=""}
            ,
            1)
        ,
        0)
      )
  - record: gitlab_component_saturation:ratio
    labels:
      component: elastic_cpu
    expr: |
      max by(environment, tier, type, stage) (
        clamp_min(
          clamp_max(
            avg by (environment, tier, type, stage) (
              avg_over_time(elasticsearch_os_cpu_percent{environment!="", type!=""}[1m]) / 100
            )
            ,
            1)
        ,
        0)
      )
  - record: gitlab_component_saturation:ratio
    labels:
      component: elastic_disk_space
    expr: |
      max by(environment, tier, type, stage) (
        clamp_min(
          clamp_max(
            sum by (environment, tier, type, stage) (
              (elasticsearch_filesystem_data_size_bytes{environment!="", type!=""} - elasticsearch_filesystem_data_free_bytes{environment!="", type!=""})
            )
            /
            sum by (environment, tier, type, stage) (
              elasticsearch_filesystem_data_size_bytes{environment!="", type!=""}
            )
            ,
            1)
        ,
        0)
      )
  - record: gitlab_component_saturation:ratio
    labels:
      component: elastic_jvm_heap_memory
    expr: |
      max by(environment, tier, type, stage) (
        clamp_min(
          clamp_max(
            elasticsearch_jvm_memory_used_bytes{area="heap", environment!="", type!=""}
            /
            elasticsearch_jvm_memory_max_bytes{area="heap", environment!="", type!=""}
            ,
            1)
        ,
        0)
      )
  - record: gitlab_component_saturation:ratio
    labels:
      component: elastic_single_node_cpu
    expr: |
      max by(environment, tier, type, stage) (
        clamp_min(
          clamp_max(
            avg_over_time(elasticsearch_os_cpu_percent{environment!="", type!=""}[1m]) / 100
            ,
            1)
        ,
        0)
      )
  - record: gitlab_component_saturation:ratio
    labels:
      component: elastic_single_node_disk_space
    expr: |
      max by(environment, tier, type, stage) (
        clamp_min(
          clamp_max(
            (
              (
                elasticsearch_filesystem_data_size_bytes{environment!="", type!=""}
                -
                elasticsearch_filesystem_data_free_bytes{environment!="", type!=""}
              )
              /
              elasticsearch_filesystem_data_size_bytes{environment!="", type!=""}
            )
            ,
            1)
        ,
        0)
      )
  - record: gitlab_component_saturation:ratio
    labels:
      component: elastic_thread_pools
    expr: |
      max by(environment, tier, type, stage) (
        clamp_min(
          clamp_max(
            (
              elasticsearch_thread_pool_active_count
              /
              (elasticsearch_thread_pool_threads_count > 0)
            )
            ,
            1)
        ,
        0)
      )
  - record: gitlab_component_saturation:ratio
    labels:
      component: go_memory
    expr: |
      max by(environment, tier, type, stage) (
        clamp_min(
          clamp_max(
            sum by (environment, tier, type, stage, fqdn) (
              go_memstats_alloc_bytes{type=~"web|git|api|gitaly|web-pages|monitoring|praefect", environment!="", type!=""}
            )
            /
            sum by (environment, tier, type, stage, fqdn) (
              node_memory_MemTotal_bytes{type=~"web|git|api|gitaly|web-pages|monitoring|praefect", environment!="", type!=""}
            )
            ,
            1)
        ,
        0)
      )
  - record: gitlab_component_saturation:ratio
    labels:
      component: memory
    expr: |
      max by(environment, tier, type, stage) (
        clamp_min(
          clamp_max(
            instance:node_memory_utilization:ratio{type!="monitoring", environment!="", type!=""}
            ,
            1)
        ,
        0)
      )
  - record: gitlab_component_saturation:ratio
    labels:
      component: open_fds
    expr: |
      max by(environment, tier, type, stage) (
        clamp_min(
          clamp_max(
            (
              process_open_fds{environment!="", type!=""}
              /
              process_max_fds{environment!="", type!=""}
            )
            or
            (
              ruby_file_descriptors{environment!="", type!=""}
              /
              ruby_process_max_fds{environment!="", type!=""}
            )
            ,
            1)
        ,
        0)
      )
  - record: gitlab_component_saturation:ratio
    labels:
      component: pgbouncer_async_pool
    expr: |
      max by(environment, tier, type, stage) (
        clamp_min(
          clamp_max(
            (
              pgbouncer_pools_server_active_connections{user="gitlab", database="gitlabhq_production_sidekiq", environment!="", type!=""} +
              pgbouncer_pools_server_testing_connections{user="gitlab", database="gitlabhq_production_sidekiq", environment!="", type!=""} +
              pgbouncer_pools_server_used_connections{user="gitlab", database="gitlabhq_production_sidekiq", environment!="", type!=""} +
              pgbouncer_pools_server_login_connections{user="gitlab", database="gitlabhq_production_sidekiq", environment!="", type!=""}
            )
            / on(environment, tier, type, stage, fqdn, instance) group_left()
            sum by (environment, tier, type, stage, fqdn, instance) (
              pgbouncer_databases_pool_size{name="gitlabhq_production_sidekiq", environment!="", type!=""}
            )
            ,
            1)
        ,
        0)
      )
  - record: gitlab_component_saturation:ratio
    labels:
      component: pgbouncer_single_core
    expr: |
      max by(environment, tier, type, stage) (
        clamp_min(
          clamp_max(
            sum without(cpu, mode) (
              rate(
                namedprocess_namegroup_cpu_seconds_total{groupname=~"pgbouncer.*", environment!="", type!=""}[1m]
              )
            )
            ,
            1)
        ,
        0)
      )
  - record: gitlab_component_saturation:ratio
    labels:
      component: pgbouncer_sync_pool
    expr: |
      max by(environment, tier, type, stage) (
        clamp_min(
          clamp_max(
            (
              pgbouncer_pools_server_active_connections{user="gitlab", database="gitlabhq_production", environment!="", type!=""} +
              pgbouncer_pools_server_testing_connections{user="gitlab", database="gitlabhq_production", environment!="", type!=""} +
              pgbouncer_pools_server_used_connections{user="gitlab", database="gitlabhq_production", environment!="", type!=""} +
              pgbouncer_pools_server_login_connections{user="gitlab", database="gitlabhq_production", environment!="", type!=""}
            )
            / on(environment, tier, type, stage, fqdn, instance) group_left()
            sum by (environment, tier, type, stage, fqdn, instance) (
              pgbouncer_databases_pool_size{name="gitlabhq_production", environment!="", type!=""}
            )
            ,
            1)
        ,
        0)
      )
  - record: gitlab_component_saturation:ratio
    labels:
      component: private_runners
      stage: main
      tier: runners
      type: ci-runners
    expr: |
      max by(environment) (
        clamp_min(
          clamp_max(
            label_replace(
              sum without(executor_stage, exported_stage, state) (max_over_time(gitlab_runner_jobs{job="private-runners"}[1m]))
              /
              gitlab_runner_limit{job="private-runners"} > 0,
              "environment", "gprd", "environment", ""
            )
            ,
            1)
        ,
        0)
      )
  - record: gitlab_component_saturation:ratio
    labels:
      component: redis_clients
    expr: |
      max by(environment, tier, type, stage) (
        clamp_min(
          clamp_max(
            max_over_time(redis_connected_clients{environment!="", type!=""}[1m])
            /
            redis_config_maxclients{environment!="", type!=""}
            ,
            1)
        ,
        0)
      )
  - record: gitlab_component_saturation:ratio
    labels:
      component: redis_memory
    expr: |
      max by(environment, tier, type, stage) (
        clamp_min(
          clamp_max(
            max by (environment, tier, type, stage, fqdn) (
              label_replace(redis_memory_used_rss_bytes{environment!="", type!=""}, "memtype", "rss","","")
              or
              label_replace(redis_memory_used_bytes{environment!="", type!=""}, "memtype", "used","","")
            )
            /
            avg by (environment, tier, type, stage, fqdn) (
              node_memory_MemTotal_bytes{environment!="", type!=""}
            )
            ,
            1)
        ,
        0)
      )
  - record: gitlab_component_saturation:ratio
    labels:
      component: shared_runners
      stage: main
      tier: runners
      type: ci-runners
    expr: |
      max by(environment) (
        clamp_min(
          clamp_max(
            label_replace(
              sum without(executor_stage, exported_stage, state) (max_over_time(gitlab_runner_jobs{job="shared-runners"}[1m]))
              /
              gitlab_runner_limit{job="shared-runners"} > 0,
              "environment", "gprd", "environment", ""
            )
            ,
            1)
        ,
        0)
      )
  - record: gitlab_component_saturation:ratio
    labels:
      component: shared_runners_gitlab
    expr: |
      max by(environment, tier, type, stage) (
        clamp_min(
          clamp_max(
            label_replace(
              sum without(executor_stage, exported_stage, state) (max_over_time(gitlab_runner_jobs{job="shared-runners-gitlab-org"}[1m]))
              /
              gitlab_runner_limit{job="shared-runners-gitlab-org"} > 0,
              "environment", "gprd", "environment", ""
            )
            ,
            1)
        ,
        0)
      )
  - record: gitlab_component_saturation:ratio
    labels:
      component: sidekiq_workers
    expr: |
      max by(environment, tier, type, stage) (
        clamp_min(
          clamp_max(
            sum by (environment, tier, type, stage, fqdn, instance, pod) (sidekiq_running_jobs{shard!~"export|elasticsearch|memory-bound", environment!="", type!=""})
            /
            sum by (environment, tier, type, stage, fqdn, instance, pod) (sidekiq_concurrency{shard!~"export|elasticsearch|memory-bound", environment!="", type!=""})
            ,
            1)
        ,
        0)
      )
  - record: gitlab_component_saturation:ratio
    labels:
      component: single_node_cpu
    expr: |
      max by(environment, tier, type, stage) (
        clamp_min(
          clamp_max(
            max without(cpu) (
              avg without(mode) (1 - rate(node_cpu_seconds_total{mode="idle", type!~"console-node|deploy-node", environment!="", type!=""}[1m]))
            )
            ,
            1)
        ,
        0)
      )
  - record: gitlab_component_saturation:ratio
    labels:
      component: single_node_puma_workers
    expr: |
      max by(environment, tier, type, stage) (
        clamp_min(
          clamp_max(
            sum by(environment, tier, type, stage, fqdn) (avg_over_time(puma_active_connections{environment!="", type!=""}[1m]))
            /
            sum by(environment, tier, type, stage, fqdn) (puma_max_threads{pid="puma_master", environment!="", type!=""})
            ,
            1)
        ,
        0)
      )
  - record: gitlab_component_saturation:ratio
    labels:
      component: single_threaded_cpu
    expr: |
      max by(environment, tier, type, stage) (
        clamp_min(
          clamp_max(
            instance:redis_cpu_usage:rate1m{environment!="", type!=""}
            ,
            1)
        ,
        0)
      )
- name: GitLab Component Saturation Max SLOs
  interval: 5m
  rules:
  - record: slo:max:soft:gitlab_component_saturation:ratio
    labels:
      component: active_db_connections
    expr: '0.8'
  - record: slo:max:hard:gitlab_component_saturation:ratio
    labels:
      component: active_db_connections
    expr: '0.9'
  - record: slo:max:soft:gitlab_component_saturation:ratio
    labels:
      component: cgroup_memory
    expr: '0.8'
  - record: slo:max:hard:gitlab_component_saturation:ratio
    labels:
      component: cgroup_memory
    expr: '0.9'
  - record: slo:max:soft:gitlab_component_saturation:ratio
    labels:
      component: cpu
    expr: '0.8'
  - record: slo:max:hard:gitlab_component_saturation:ratio
    labels:
      component: cpu
    expr: '0.9'
  - record: slo:max:soft:gitlab_component_saturation:ratio
    labels:
      component: disk_space
    expr: '0.85'
  - record: slo:max:hard:gitlab_component_saturation:ratio
    labels:
      component: disk_space
    expr: '0.9'
  - record: slo:max:soft:gitlab_component_saturation:ratio
    labels:
      component: disk_sustained_read_iops
    expr: '0.8'
  - record: slo:max:hard:gitlab_component_saturation:ratio
    labels:
      component: disk_sustained_read_iops
    expr: '0.9'
  - record: slo:max:soft:gitlab_component_saturation:ratio
    labels:
      component: disk_sustained_read_throughput
    expr: '0.7'
  - record: slo:max:hard:gitlab_component_saturation:ratio
    labels:
      component: disk_sustained_read_throughput
    expr: '0.8'
  - record: slo:max:soft:gitlab_component_saturation:ratio
    labels:
      component: disk_sustained_write_iops
    expr: '0.8'
  - record: slo:max:hard:gitlab_component_saturation:ratio
    labels:
      component: disk_sustained_write_iops
    expr: '0.9'
  - record: slo:max:soft:gitlab_component_saturation:ratio
    labels:
      component: disk_sustained_write_throughput
    expr: '0.7'
  - record: slo:max:hard:gitlab_component_saturation:ratio
    labels:
      component: disk_sustained_write_throughput
    expr: '0.8'
  - record: slo:max:soft:gitlab_component_saturation:ratio
    labels:
      component: elastic_cpu
    expr: '0.8'
  - record: slo:max:hard:gitlab_component_saturation:ratio
    labels:
      component: elastic_cpu
    expr: '0.9'
  - record: slo:max:soft:gitlab_component_saturation:ratio
    labels:
      component: elastic_disk_space
    expr: '0.8'
  - record: slo:max:hard:gitlab_component_saturation:ratio
    labels:
      component: elastic_disk_space
    expr: '0.9'
  - record: slo:max:soft:gitlab_component_saturation:ratio
    labels:
      component: elastic_jvm_heap_memory
    expr: '0.8'
  - record: slo:max:hard:gitlab_component_saturation:ratio
    labels:
      component: elastic_jvm_heap_memory
    expr: '0.9'
  - record: slo:max:soft:gitlab_component_saturation:ratio
    labels:
      component: elastic_single_node_cpu
    expr: '0.8'
  - record: slo:max:hard:gitlab_component_saturation:ratio
    labels:
      component: elastic_single_node_cpu
    expr: '0.9'
  - record: slo:max:soft:gitlab_component_saturation:ratio
    labels:
      component: elastic_single_node_disk_space
    expr: '0.8'
  - record: slo:max:hard:gitlab_component_saturation:ratio
    labels:
      component: elastic_single_node_disk_space
    expr: '0.9'
  - record: slo:max:soft:gitlab_component_saturation:ratio
    labels:
      component: elastic_thread_pools
    expr: '0.8'
  - record: slo:max:hard:gitlab_component_saturation:ratio
    labels:
      component: elastic_thread_pools
    expr: '0.9'
  - record: slo:max:soft:gitlab_component_saturation:ratio
    labels:
      component: go_memory
    expr: '0.9'
  - record: slo:max:hard:gitlab_component_saturation:ratio
    labels:
      component: go_memory
    expr: '0.98'
  - record: slo:max:soft:gitlab_component_saturation:ratio
    labels:
      component: memory
    expr: '0.9'
  - record: slo:max:hard:gitlab_component_saturation:ratio
    labels:
      component: memory
    expr: '0.98'
  - record: slo:max:soft:gitlab_component_saturation:ratio
    labels:
      component: open_fds
    expr: '0.8'
  - record: slo:max:hard:gitlab_component_saturation:ratio
    labels:
      component: open_fds
    expr: '0.9'
  - record: slo:max:soft:gitlab_component_saturation:ratio
    labels:
      component: pgbouncer_async_pool
    expr: '0.9'
  - record: slo:max:hard:gitlab_component_saturation:ratio
    labels:
      component: pgbouncer_async_pool
    expr: '0.98'
  - record: slo:max:soft:gitlab_component_saturation:ratio
    labels:
      component: pgbouncer_single_core
    expr: '0.8'
  - record: slo:max:hard:gitlab_component_saturation:ratio
    labels:
      component: pgbouncer_single_core
    expr: '0.9'
  - record: slo:max:soft:gitlab_component_saturation:ratio
    labels:
      component: pgbouncer_sync_pool
    expr: '0.85'
  - record: slo:max:hard:gitlab_component_saturation:ratio
    labels:
      component: pgbouncer_sync_pool
    expr: '0.95'
  - record: slo:max:soft:gitlab_component_saturation:ratio
    labels:
      component: private_runners
    expr: '0.85'
  - record: slo:max:hard:gitlab_component_saturation:ratio
    labels:
      component: private_runners
    expr: '0.95'
  - record: slo:max:soft:gitlab_component_saturation:ratio
    labels:
      component: redis_clients
    expr: '0.8'
  - record: slo:max:hard:gitlab_component_saturation:ratio
    labels:
      component: redis_clients
    expr: '0.9'
  - record: slo:max:soft:gitlab_component_saturation:ratio
    labels:
      component: redis_memory
    expr: '0.65'
  - record: slo:max:hard:gitlab_component_saturation:ratio
    labels:
      component: redis_memory
    expr: '0.75'
  - record: slo:max:soft:gitlab_component_saturation:ratio
    labels:
      component: shared_runners
    expr: '0.9'
  - record: slo:max:hard:gitlab_component_saturation:ratio
    labels:
      component: shared_runners
    expr: '0.95'
  - record: slo:max:soft:gitlab_component_saturation:ratio
    labels:
      component: shared_runners_gitlab
    expr: '0.9'
  - record: slo:max:hard:gitlab_component_saturation:ratio
    labels:
      component: shared_runners_gitlab
    expr: '0.95'
  - record: slo:max:soft:gitlab_component_saturation:ratio
    labels:
      alert_trigger_duration: long
      component: sidekiq_workers
    expr: '0.9'
  - record: slo:max:hard:gitlab_component_saturation:ratio
    labels:
      alert_trigger_duration: long
      component: sidekiq_workers
    expr: '0.95'
  - record: slo:max:soft:gitlab_component_saturation:ratio
    labels:
      component: single_node_cpu
    expr: '0.9'
  - record: slo:max:hard:gitlab_component_saturation:ratio
    labels:
      component: single_node_cpu
    expr: '0.95'
  - record: slo:max:soft:gitlab_component_saturation:ratio
    labels:
      component: single_node_puma_workers
    expr: '0.85'
  - record: slo:max:hard:gitlab_component_saturation:ratio
    labels:
      component: single_node_puma_workers
    expr: '0.9'
  - record: slo:max:soft:gitlab_component_saturation:ratio
    labels:
      component: single_threaded_cpu
    expr: '0.7'
  - record: slo:max:hard:gitlab_component_saturation:ratio
    labels:
      component: single_threaded_cpu
    expr: '0.9'
