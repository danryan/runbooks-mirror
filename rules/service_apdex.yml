groups:
- name: GitLab Component Apdex Scores
  interval: 1m
  rules:
  # Sidekiq jobs
  # See https://gitlab.com/gitlab-com/gl-infra/infrastructure/issues/6670 for details
  # We deliberately ignore the `import` queue for now

  # Sidekiq pullmirror Queue
  - record: gitlab_component_apdex:ratio
    labels:
      component: 'pullmirror'
    expr: >
      sum(rate(sidekiq_jobs_completion_seconds_bucket{le="60", priority="pullmirror"}[1m])) by (environment, tier, type, stage)
      /
      sum(rate(sidekiq_jobs_completion_seconds_bucket{le="+Inf", priority="pullmirror"}[1m])) by (environment, tier, type, stage)

  - record: gitlab_component_apdex:weight:score
    labels:
      component: 'pullmirror'
    expr: >
      sum(rate(sidekiq_jobs_completion_seconds_bucket{le="+Inf", priority="pullmirror"}[1m])) by (environment, tier, type, stage)

  # Sidekiq besteffort Queue
  - record: gitlab_component_apdex:ratio
    labels:
      component: 'besteffort'
    expr: >
      sum(rate(sidekiq_jobs_completion_seconds_bucket{le="60", priority="besteffort", queue!~"project_export|git_garbage_collect|repository_update_remote_mirror"}[1m])) by (environment, tier, type, stage)
      /
      sum(rate(sidekiq_jobs_completion_seconds_bucket{le="+Inf", priority="besteffort", queue!~"project_export|git_garbage_collect|repository_update_remote_mirror"}[1m])) by (environment, tier, type, stage)

  - record: gitlab_component_apdex:weight:score
    labels:
      component: 'besteffort'
    expr: >
      sum(rate(sidekiq_jobs_completion_seconds_bucket{le="+Inf", priority="besteffort", queue!~"project_export|git_garbage_collect|repository_update_remote_mirror"}[1m])) by (environment, tier, type, stage)

  # Sidekiq Pages Queue
  - record: gitlab_component_apdex:ratio
    labels:
      component: 'pages'
    expr: >
      sum(rate(sidekiq_jobs_completion_seconds_bucket{le="60", priority="pages"}[1m])) by (environment, tier, type, stage)
      /
      sum(rate(sidekiq_jobs_completion_seconds_bucket{le="+Inf", priority="pages"}[1m])) by (environment, tier, type, stage)

  - record: gitlab_component_apdex:weight:score
    labels:
      component: 'pages'
    expr: >
      sum(rate(sidekiq_jobs_completion_seconds_bucket{le="+Inf", priority="pages"}[1m])) by (environment, tier, type, stage)

  # Sidekiq Realtime Queue
  - record: gitlab_component_apdex:ratio
    labels:
      component: 'realtime'
    expr: >
      (
        sum(rate(sidekiq_jobs_completion_seconds_bucket{le="5", priority="realtime"}[1m])) by (environment, tier, type, stage)
        +
        sum(rate(sidekiq_jobs_completion_seconds_bucket{le="10", priority="realtime"}[1m])) by (environment, tier, type, stage)
      )
      / 2
      /
      sum(rate(sidekiq_jobs_completion_seconds_bucket{le="+Inf", priority="realtime"}[1m])) by (environment, tier, type, stage)

  - record: gitlab_component_apdex:weight:score
    labels:
      component: 'realtime'
    expr: >
      sum(rate(sidekiq_jobs_completion_seconds_bucket{le="+Inf", priority="realtime"}[1m])) by (environment, tier, type, stage)

  # Sidekiq ASAP Queue
  - record: gitlab_component_apdex:ratio
    labels:
      component: 'asap'
    expr: >
      (
        sum(rate(sidekiq_jobs_completion_seconds_bucket{le="5", priority="asap"}[1m])) by (environment, tier, type, stage)
        +
        sum(rate(sidekiq_jobs_completion_seconds_bucket{le="10", priority="asap"}[1m])) by (environment, tier, type, stage)
      )
      / 2
      /
      sum(rate(sidekiq_jobs_completion_seconds_bucket{le="+Inf", priority="asap"}[1m])) by (environment, tier, type, stage)

  - record: gitlab_component_apdex:weight:score
    labels:
      component: 'asap'
    expr: >
      sum(rate(sidekiq_jobs_completion_seconds_bucket{le="+Inf", priority="asap"}[1m])) by (environment, tier, type, stage)

  # Sidekiq Pipeline Queue
  - record: gitlab_component_apdex:ratio
    labels:
      component: 'pipeline'
    expr: >
      (
        sum(rate(sidekiq_jobs_completion_seconds_bucket{le="1", priority="pipeline"}[1m])) by (environment, tier, type, stage)
        +
        sum(rate(sidekiq_jobs_completion_seconds_bucket{le="2.5", priority="pipeline"}[1m])) by (environment, tier, type, stage)
      )
      / 2
      /
      sum(rate(sidekiq_jobs_completion_seconds_bucket{le="+Inf", priority="pipeline"}[1m])) by (environment, tier, type, stage)

  - record: gitlab_component_apdex:weight:score
    labels:
      component: 'pipeline'
    expr: >
      sum(rate(sidekiq_jobs_completion_seconds_bucket{le="+Inf", priority="pipeline"}[1m])) by (environment, tier, type, stage)

  ######################
  # Aggregation Stage
  ######################

  # Aggregate over all components within a service using a weighted average
  # Why use the avg_over_time[1h] value for the weight? This is because
  # if a component suddenly stops working, its RPS will drop to zero and
  # therefore its weight will also drop to zero, meaning that it won't affect
  # the apdex. Using a 1h average is an attempt at resolving this, although
  # 1hr may not be enough.
  - record: gitlab_service_apdex:ratio
    expr: >
      sum by (environment, tier, type, stage) ((gitlab_component_apdex:ratio >= 0) * (avg_over_time(gitlab_component_apdex:weight:score[1h]) >= 0))
      /
      sum by (environment, tier, type, stage) (avg_over_time(gitlab_component_apdex:weight:score[1h]) >= 0)

  # Node-level aggregation
  - record: gitlab_service_node_apdex:ratio
    expr: >
      sum by (environment, tier, type, stage, shard, fqdn) ((gitlab_component_node_apdex:ratio >= 0) * (avg_over_time(gitlab_component_node_apdex:weight:score[1h]) >= 0))
      /
      sum by (environment, tier, type, stage, shard, fqdn) (avg_over_time(gitlab_component_node_apdex:weight:score[1h]) >= 0)

- name: GitLab Component Apdex Score Stats
  interval: 5m
  rules:
  # Average values for each component, over a week
  - record: gitlab_component_apdex:ratio:avg_over_time_1w
    expr: >
      avg_over_time(gitlab_component_apdex:ratio[1w])
  # Stddev for each component, over a week
  - record: gitlab_component_apdex:ratio:stddev_over_time_1w
    expr: >
      stddev_over_time(gitlab_component_apdex:ratio[1w])

- name: GitLab Service Apdex Score Stats
  interval: 5m
  rules:
  # Average values for each service, over a week
  - record: gitlab_service_apdex:ratio:avg_over_time_1w
    expr: >
      avg_over_time(gitlab_service_apdex:ratio[1w])
  # Stddev for each service, over a week
  - record: gitlab_service_apdex:ratio:stddev_over_time_1w
    expr: >
      stddev_over_time(gitlab_service_apdex:ratio[1w])

