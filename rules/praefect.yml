groups:
- name: Praefect misc alerts
  rules:
  - alert: PraefectPerformedAFailover
    expr: sum(changes(gitaly_praefect_primaries[1m])) by (virtual_storage) > 0
    for: 1m
    labels:
      team: gitaly
      pager: pagerduty
      severity: s1
      alert_type: cause
    annotations:
      description: Praefect has performed a failover for {{ $labels.virtual_storage }} virtual storage.
        Follow the runbook to check for any data loss.
      runbook: docs/praefect/praefect-failover.md
      title: Praefect performed a failover for {{ $labels.virtual_storage }} virtual storage
  - alert: ReadOnlyRepositories
    expr: max without (fqdn, instance) (gitaly_praefect_read_only_repositories) > 0
    for: 1m
    labels:
      team: gitaly
      pager: pagerduty
      severity: s1
      alert_type: symptom
    annotations:
      title: Some repositories are in read-only mode.
      description: Some repositories are in read-only mode in {{ $labels.virtual_storage }} virtual storage as
        the primary does not have the latest changes. Praefect might have failed over to an outdated secondary.
      runbook: docs/praefect/praefect-failover.md