# WARNING. DO NOT EDIT THIS FILE BY HAND. USE ./thanos-rules-jsonnet/service-component-alerts.jsonnet TO GENERATE IT
# YOUR CHANGES WILL BE OVERRIDDEN
groups:
- name: 'Service Component Alerts: patroni'
  interval: 1m
  partial_response_strategy: warn
  rules:
  - alert: PatroniServiceRailsSqlApdexSLOViolation
    for: 2m
    annotations:
      title: The rails_sql SLI of the patroni service (`{{ $labels.stage }}` stage) has an apdex violating
        SLO
      description: |
        Represents all SQL transactions issued through ActiveRecord from the Rails monolith. Durations can be impacted by various conditions other than Patroni, including client pool saturation, pgbouncer saturation, Ruby thread contention and network conditions.

        Currently the apdex value is {{ $value | humanizePercentage }}.
      grafana_dashboard_id: patroni-main/patroni-overview
      grafana_dashboard_link: >-
        https://dashboards.gitlab.net/d/patroni-main/patroni-overview?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}
      grafana_min_zoom_hours: '6'
      grafana_panel_id: '49960'
      grafana_variables: environment,stage
      promql_template_1: >-
        gitlab_component_apdex:ratio_1h{environment="$environment", type="$type", stage="$stage", component="$component"}
      runbook: docs/{{ $labels.type }}/README.md
    labels:
      alert_type: symptom
      feature_category: not_owned
      pager: pagerduty
      product_stage: not_owned
      product_stage_group: not_owned
      rules_domain: general
      severity: s2
      slo_alert: 'yes'
      user_impacting: 'yes'
    expr: |
      (
        (
          gitlab_component_apdex:ratio_1h{component="rails_sql",monitor="global",type="patroni"}
          < (1 - 14.4 * 0.005000)
        )
        and
        (
          gitlab_component_apdex:ratio_5m{component="rails_sql",monitor="global",type="patroni"}
          < (1 - 14.4 * 0.005000)
        )
        or
        (
          gitlab_component_apdex:ratio_6h{component="rails_sql",monitor="global",type="patroni"}
          < (1 - 6 * 0.005000)
        )
        and
        (
          gitlab_component_apdex:ratio_30m{component="rails_sql",monitor="global",type="patroni"}
          < (1 - 6 * 0.005000)
        )
      )
      and on(env,environment,tier,type,stage,component)
      (
        sum by(env,environment,tier,type,stage,component) (gitlab_component_ops:rate_1h{component="rails_sql",monitor="global",type="patroni"}) >= 1
      )
  - alert: PatroniServiceServiceErrorSLOViolation
    for: 2m
    annotations:
      title: The service SLI of the patroni service (`{{ $labels.stage }}` stage) has an error rate violating
        SLO
      description: |
        Represents all SQL transactions issued to primary and secondary instances, in aggregate. Errors represent transaction rollbacks.

        Currently the error-rate is {{ $value | humanizePercentage }}.
      grafana_dashboard_id: patroni-main/patroni-overview
      grafana_dashboard_link: >-
        https://dashboards.gitlab.net/d/patroni-main/patroni-overview?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}
      grafana_min_zoom_hours: '6'
      grafana_panel_id: '3272'
      grafana_variables: environment,stage
      link1_title: Definition
      link1_url: >-
        https://gitlab.com/gitlab-com/runbooks/blob/master/docs/uncategorized/definition-service-error-rate.md
      promql_template_1: >-
        gitlab_component_errors:ratio_5m{environment="$environment", type="$type", stage="$stage", component="$component"}
      runbook: docs/{{ $labels.type }}/README.md
    labels:
      alert_type: symptom
      feature_category: not_owned
      pager: pagerduty
      product_stage: not_owned
      product_stage_group: not_owned
      rules_domain: general
      severity: s2
      slo_alert: 'yes'
      user_impacting: 'yes'
    expr: |
      (
        (
          gitlab_component_errors:ratio_1h{component="service",monitor="global",type="patroni"}
          > (14.4 * 0.000500)
        )
        and
        (
          gitlab_component_errors:ratio_5m{component="service",monitor="global",type="patroni"}
          > (14.4 * 0.000500)
        )
        or
        (
          gitlab_component_errors:ratio_6h{component="service",monitor="global",type="patroni"}
          > (6 * 0.000500)
        )
        and
        (
          gitlab_component_errors:ratio_30m{component="service",monitor="global",type="patroni"}
          > (6 * 0.000500)
        )
      )
      and on(env,environment,tier,type,stage,component)
      (
        sum by(env,environment,tier,type,stage,component) (gitlab_component_ops:rate_1h{component="service",monitor="global",type="patroni"}) >= 1
      )
