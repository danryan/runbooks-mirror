# All of these are experimental apdex recordings to get better information for https://gitlab.com/gitlab-com/gl-infra/scalability/-/issues/2445.

groups:
- name: Gitaly Apdex calculation from raw metrics
  interval: 1m
  partial_response_strategy: abort
  rules:
  - record: raw_metrics_apdex_calculation
    # This is a raw metrics calculation for Gitaly based on its very complex metrics calculations.
    labels:
      type: gitaly
      rate: 1h
    expr: |
     ( sum by (env,environment,stage) (
        label_replace((
          sum by (env,environment,stage) (
            rate(grpc_server_handling_seconds_bucket{grpc_method!~"CalculateChecksum|CommitLanguages|CommitStats|CreateFork|CreateRepositoryFromURL|FetchInternalRemote|FetchIntoObjectPool|FetchRemote|FetchSourceBranch|FindCommit|FindRemoteRepository|FindRemoteRootRef|Fsck|GarbageCollect|GetArchive|LastCommitForPath|OptimizeRepository|PackObjectsHookWithSidechannel|PostReceiveHook|PostUploadPackWithSidechannel|PreReceiveHook|RepackFull|RepackIncremental|ReplicateRepository|RepositorySize|SSHUploadPackWithSidechannel|UpdateHook|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="0.5",type="gitaly"}[1h])
          )
          +
          sum by (env,environment,stage) (
            rate(grpc_server_handling_seconds_bucket{grpc_method!~"CalculateChecksum|CommitLanguages|CommitStats|CreateFork|CreateRepositoryFromURL|FetchInternalRemote|FetchIntoObjectPool|FetchRemote|FetchSourceBranch|FindCommit|FindRemoteRepository|FindRemoteRootRef|Fsck|GarbageCollect|GetArchive|LastCommitForPath|OptimizeRepository|PackObjectsHookWithSidechannel|PostReceiveHook|PostUploadPackWithSidechannel|PreReceiveHook|RepackFull|RepackIncremental|ReplicateRepository|RepositorySize|SSHUploadPackWithSidechannel|UpdateHook|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="1",type="gitaly"}[1h])
          )
        )
        /
        2
        , "_c", "0", "", "")
        or
        label_replace((
          sum by (env,environment,stage) (
            rate(grpc_server_handling_seconds_bucket{grpc_method=~"FindCommit|GetArchive|LastCommitForPath|RepositorySize|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="10",type="gitaly"}[1h])
          )
          +
          sum by (env,environment,stage) (
            rate(grpc_server_handling_seconds_bucket{grpc_method=~"FindCommit|GetArchive|LastCommitForPath|RepositorySize|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="30",type="gitaly"}[1h])
          )
        )
        /
        2
        , "_c", "1", "", "")
        or
        label_replace((
          sum by (env,environment,stage) (
            rate(grpc_server_handling_seconds_bucket{grpc_service="gitaly.OperationService",grpc_type="unary",job="gitaly",le="10",type="gitaly"}[1h])
          )
          +
          sum by (env,environment,stage) (
            rate(grpc_server_handling_seconds_bucket{grpc_service="gitaly.OperationService",grpc_type="unary",job="gitaly",le="30",type="gitaly"}[1h])
          )
        )
        /
        2
        , "_c", "2", "", "")
      ) /
      sum by (env,environment,stage) (
        label_replace(sum by (env,environment,stage) (
          rate(grpc_server_handling_seconds_bucket{grpc_method!~"CalculateChecksum|CommitLanguages|CommitStats|CreateFork|CreateRepositoryFromURL|FetchInternalRemote|FetchIntoObjectPool|FetchRemote|FetchSourceBranch|FindCommit|FindRemoteRepository|FindRemoteRootRef|Fsck|GarbageCollect|GetArchive|LastCommitForPath|OptimizeRepository|PackObjectsHookWithSidechannel|PostReceiveHook|PostUploadPackWithSidechannel|PreReceiveHook|RepackFull|RepackIncremental|ReplicateRepository|RepositorySize|SSHUploadPackWithSidechannel|UpdateHook|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="+Inf",type="gitaly"}[1h])
        )
        , "_c", "0", "", "")
        or
        label_replace(sum by (env,environment,stage) (
          rate(grpc_server_handling_seconds_bucket{grpc_method=~"FindCommit|GetArchive|LastCommitForPath|RepositorySize|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="+Inf",type="gitaly"}[1h])
        )
        , "_c", "1", "", "")
        or
        label_replace(sum by (env,environment,stage) (
          rate(grpc_server_handling_seconds_bucket{grpc_service="gitaly.OperationService",grpc_type="unary",job="gitaly",le="+Inf",type="gitaly"}[1h])
        )
        , "_c", "2", "", "")
      ))
- name: Gitaly Apdex calculation from raw metrics with 1m offset
  interval: 1m
  partial_response_strategy: abort
  rules:
  - record: raw_metrics_apdex_calculation
    # This is a raw metrics calculation for Gitaly based on its very complex metrics calculations with a 1 minute offset.
    labels:
      type: gitaly
      rate: 1h_offset_1m
    expr: |
     ( sum by (env,environment,stage) (
        label_replace((
          sum by (env,environment,stage) (
            rate(grpc_server_handling_seconds_bucket{grpc_method!~"CalculateChecksum|CommitLanguages|CommitStats|CreateFork|CreateRepositoryFromURL|FetchInternalRemote|FetchIntoObjectPool|FetchRemote|FetchSourceBranch|FindCommit|FindRemoteRepository|FindRemoteRootRef|Fsck|GarbageCollect|GetArchive|LastCommitForPath|OptimizeRepository|PackObjectsHookWithSidechannel|PostReceiveHook|PostUploadPackWithSidechannel|PreReceiveHook|RepackFull|RepackIncremental|ReplicateRepository|RepositorySize|SSHUploadPackWithSidechannel|UpdateHook|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="0.5",type="gitaly"}[1h] offset 1m)
          )
          +
          sum by (env,environment,stage) (
            rate(grpc_server_handling_seconds_bucket{grpc_method!~"CalculateChecksum|CommitLanguages|CommitStats|CreateFork|CreateRepositoryFromURL|FetchInternalRemote|FetchIntoObjectPool|FetchRemote|FetchSourceBranch|FindCommit|FindRemoteRepository|FindRemoteRootRef|Fsck|GarbageCollect|GetArchive|LastCommitForPath|OptimizeRepository|PackObjectsHookWithSidechannel|PostReceiveHook|PostUploadPackWithSidechannel|PreReceiveHook|RepackFull|RepackIncremental|ReplicateRepository|RepositorySize|SSHUploadPackWithSidechannel|UpdateHook|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="1",type="gitaly"}[1h] offset 1m)
          )
        )
        /
        2
        , "_c", "0", "", "")
        or
        label_replace((
          sum by (env,environment,stage) (
            rate(grpc_server_handling_seconds_bucket{grpc_method=~"FindCommit|GetArchive|LastCommitForPath|RepositorySize|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="10",type="gitaly"}[1h] offset 1m)
          )
          +
          sum by (env,environment,stage) (
            rate(grpc_server_handling_seconds_bucket{grpc_method=~"FindCommit|GetArchive|LastCommitForPath|RepositorySize|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="30",type="gitaly"}[1h] offset 1m)
          )
        )
        /
        2
        , "_c", "1", "", "")
        or
        label_replace((
          sum by (env,environment,stage) (
            rate(grpc_server_handling_seconds_bucket{grpc_service="gitaly.OperationService",grpc_type="unary",job="gitaly",le="10",type="gitaly"}[1h] offset 1m)
          )
          +
          sum by (env,environment,stage) (
            rate(grpc_server_handling_seconds_bucket{grpc_service="gitaly.OperationService",grpc_type="unary",job="gitaly",le="30",type="gitaly"}[1h] offset 1m)
          )
        )
        /
        2
        , "_c", "2", "", "")
      ) /
      sum by (env,environment,stage) (
        label_replace(sum by (env,environment,stage) (
          rate(grpc_server_handling_seconds_bucket{grpc_method!~"CalculateChecksum|CommitLanguages|CommitStats|CreateFork|CreateRepositoryFromURL|FetchInternalRemote|FetchIntoObjectPool|FetchRemote|FetchSourceBranch|FindCommit|FindRemoteRepository|FindRemoteRootRef|Fsck|GarbageCollect|GetArchive|LastCommitForPath|OptimizeRepository|PackObjectsHookWithSidechannel|PostReceiveHook|PostUploadPackWithSidechannel|PreReceiveHook|RepackFull|RepackIncremental|ReplicateRepository|RepositorySize|SSHUploadPackWithSidechannel|UpdateHook|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="+Inf",type="gitaly"}[1h] offset 1m)
        )
        , "_c", "0", "", "")
        or
        label_replace(sum by (env,environment,stage) (
          rate(grpc_server_handling_seconds_bucket{grpc_method=~"FindCommit|GetArchive|LastCommitForPath|RepositorySize|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="+Inf",type="gitaly"}[1h] offset 1m)
        )
        , "_c", "1", "", "")
        or
        label_replace(sum by (env,environment,stage) (
          rate(grpc_server_handling_seconds_bucket{grpc_service="gitaly.OperationService",grpc_type="unary",job="gitaly",le="+Inf",type="gitaly"}[1h] offset 1m)
        )
        , "_c", "2", "", "")
      ))
- name: Gitaly Apdex calculation from raw metrics with 30s offset
  interval: 1m
  partial_response_strategy: abort
  rules:
  - record: raw_metrics_apdex_calculation
    # This is a raw metrics calculation for Gitaly based on its very complex metrics calculations with a 30 second offset.
    labels:
      type: gitaly
      rate: 1h_offset_30s
    expr: |
     ( sum by (env,environment,stage) (
        label_replace((
          sum by (env,environment,stage) (
            rate(grpc_server_handling_seconds_bucket{grpc_method!~"CalculateChecksum|CommitLanguages|CommitStats|CreateFork|CreateRepositoryFromURL|FetchInternalRemote|FetchIntoObjectPool|FetchRemote|FetchSourceBranch|FindCommit|FindRemoteRepository|FindRemoteRootRef|Fsck|GarbageCollect|GetArchive|LastCommitForPath|OptimizeRepository|PackObjectsHookWithSidechannel|PostReceiveHook|PostUploadPackWithSidechannel|PreReceiveHook|RepackFull|RepackIncremental|ReplicateRepository|RepositorySize|SSHUploadPackWithSidechannel|UpdateHook|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="0.5",type="gitaly"}[1h] offset 30s)
          )
          +
          sum by (env,environment,stage) (
            rate(grpc_server_handling_seconds_bucket{grpc_method!~"CalculateChecksum|CommitLanguages|CommitStats|CreateFork|CreateRepositoryFromURL|FetchInternalRemote|FetchIntoObjectPool|FetchRemote|FetchSourceBranch|FindCommit|FindRemoteRepository|FindRemoteRootRef|Fsck|GarbageCollect|GetArchive|LastCommitForPath|OptimizeRepository|PackObjectsHookWithSidechannel|PostReceiveHook|PostUploadPackWithSidechannel|PreReceiveHook|RepackFull|RepackIncremental|ReplicateRepository|RepositorySize|SSHUploadPackWithSidechannel|UpdateHook|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="1",type="gitaly"}[1h] offset 30s)
          )
        )
        /
        2
        , "_c", "0", "", "")
        or
        label_replace((
          sum by (env,environment,stage) (
            rate(grpc_server_handling_seconds_bucket{grpc_method=~"FindCommit|GetArchive|LastCommitForPath|RepositorySize|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="10",type="gitaly"}[1h] offset 30s)
          )
          +
          sum by (env,environment,stage) (
            rate(grpc_server_handling_seconds_bucket{grpc_method=~"FindCommit|GetArchive|LastCommitForPath|RepositorySize|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="30",type="gitaly"}[1h] offset 30s)
          )
        )
        /
        2
        , "_c", "1", "", "")
        or
        label_replace((
          sum by (env,environment,stage) (
            rate(grpc_server_handling_seconds_bucket{grpc_service="gitaly.OperationService",grpc_type="unary",job="gitaly",le="10",type="gitaly"}[1h] offset 30s)
          )
          +
          sum by (env,environment,stage) (
            rate(grpc_server_handling_seconds_bucket{grpc_service="gitaly.OperationService",grpc_type="unary",job="gitaly",le="30",type="gitaly"}[1h] offset 30s)
          )
        )
        /
        2
        , "_c", "2", "", "")
      ) /
      sum by (env,environment,stage) (
        label_replace(sum by (env,environment,stage) (
          rate(grpc_server_handling_seconds_bucket{grpc_method!~"CalculateChecksum|CommitLanguages|CommitStats|CreateFork|CreateRepositoryFromURL|FetchInternalRemote|FetchIntoObjectPool|FetchRemote|FetchSourceBranch|FindCommit|FindRemoteRepository|FindRemoteRootRef|Fsck|GarbageCollect|GetArchive|LastCommitForPath|OptimizeRepository|PackObjectsHookWithSidechannel|PostReceiveHook|PostUploadPackWithSidechannel|PreReceiveHook|RepackFull|RepackIncremental|ReplicateRepository|RepositorySize|SSHUploadPackWithSidechannel|UpdateHook|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="+Inf",type="gitaly"}[1h] offset 30s)
        )
        , "_c", "0", "", "")
        or
        label_replace(sum by (env,environment,stage) (
          rate(grpc_server_handling_seconds_bucket{grpc_method=~"FindCommit|GetArchive|LastCommitForPath|RepositorySize|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="+Inf",type="gitaly"}[1h] offset 30s)
        )
        , "_c", "1", "", "")
        or
        label_replace(sum by (env,environment,stage) (
          rate(grpc_server_handling_seconds_bucket{grpc_service="gitaly.OperationService",grpc_type="unary",job="gitaly",le="+Inf",type="gitaly"}[1h] offset 30s)
        )
        , "_c", "2", "", "")
      ))
- name: Gitaly Apdex calculation from raw metrics with 5s offset
  interval: 1m
  partial_response_strategy: abort
  rules:
  - record: raw_metrics_apdex_calculation
    # This is a raw metrics calculation for Gitaly based on its very complex metrics calculations with a 5 second offset
    labels:
      type: gitaly
      rate: 1h_offset_5s
    expr: |
     ( sum by (env,environment,stage) (
        label_replace((
          sum by (env,environment,stage) (
            rate(grpc_server_handling_seconds_bucket{grpc_method!~"CalculateChecksum|CommitLanguages|CommitStats|CreateFork|CreateRepositoryFromURL|FetchInternalRemote|FetchIntoObjectPool|FetchRemote|FetchSourceBranch|FindCommit|FindRemoteRepository|FindRemoteRootRef|Fsck|GarbageCollect|GetArchive|LastCommitForPath|OptimizeRepository|PackObjectsHookWithSidechannel|PostReceiveHook|PostUploadPackWithSidechannel|PreReceiveHook|RepackFull|RepackIncremental|ReplicateRepository|RepositorySize|SSHUploadPackWithSidechannel|UpdateHook|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="0.5",type="gitaly"}[1h] offset 5s)
          )
          +
          sum by (env,environment,stage) (
            rate(grpc_server_handling_seconds_bucket{grpc_method!~"CalculateChecksum|CommitLanguages|CommitStats|CreateFork|CreateRepositoryFromURL|FetchInternalRemote|FetchIntoObjectPool|FetchRemote|FetchSourceBranch|FindCommit|FindRemoteRepository|FindRemoteRootRef|Fsck|GarbageCollect|GetArchive|LastCommitForPath|OptimizeRepository|PackObjectsHookWithSidechannel|PostReceiveHook|PostUploadPackWithSidechannel|PreReceiveHook|RepackFull|RepackIncremental|ReplicateRepository|RepositorySize|SSHUploadPackWithSidechannel|UpdateHook|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="1",type="gitaly"}[1h] offset 5s)
          )
        )
        /
        2
        , "_c", "0", "", "")
        or
        label_replace((
          sum by (env,environment,stage) (
            rate(grpc_server_handling_seconds_bucket{grpc_method=~"FindCommit|GetArchive|LastCommitForPath|RepositorySize|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="10",type="gitaly"}[1h] offset 5s)
          )
          +
          sum by (env,environment,stage) (
            rate(grpc_server_handling_seconds_bucket{grpc_method=~"FindCommit|GetArchive|LastCommitForPath|RepositorySize|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="30",type="gitaly"}[1h] offset 5s)
          )
        )
        /
        2
        , "_c", "1", "", "")
        or
        label_replace((
          sum by (env,environment,stage) (
            rate(grpc_server_handling_seconds_bucket{grpc_service="gitaly.OperationService",grpc_type="unary",job="gitaly",le="10",type="gitaly"}[1h] offset 5s)
          )
          +
          sum by (env,environment,stage) (
            rate(grpc_server_handling_seconds_bucket{grpc_service="gitaly.OperationService",grpc_type="unary",job="gitaly",le="30",type="gitaly"}[1h] offset 5s)
          )
        )
        /
        2
        , "_c", "2", "", "")
      ) /
      sum by (env,environment,stage) (
        label_replace(sum by (env,environment,stage) (
          rate(grpc_server_handling_seconds_bucket{grpc_method!~"CalculateChecksum|CommitLanguages|CommitStats|CreateFork|CreateRepositoryFromURL|FetchInternalRemote|FetchIntoObjectPool|FetchRemote|FetchSourceBranch|FindCommit|FindRemoteRepository|FindRemoteRootRef|Fsck|GarbageCollect|GetArchive|LastCommitForPath|OptimizeRepository|PackObjectsHookWithSidechannel|PostReceiveHook|PostUploadPackWithSidechannel|PreReceiveHook|RepackFull|RepackIncremental|ReplicateRepository|RepositorySize|SSHUploadPackWithSidechannel|UpdateHook|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="+Inf",type="gitaly"}[1h] offset 5s)
        )
        , "_c", "0", "", "")
        or
        label_replace(sum by (env,environment,stage) (
          rate(grpc_server_handling_seconds_bucket{grpc_method=~"FindCommit|GetArchive|LastCommitForPath|RepositorySize|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="+Inf",type="gitaly"}[1h] offset 5s)
        )
        , "_c", "1", "", "")
        or
        label_replace(sum by (env,environment,stage) (
          rate(grpc_server_handling_seconds_bucket{grpc_service="gitaly.OperationService",grpc_type="unary",job="gitaly",le="+Inf",type="gitaly"}[1h] offset 5s)
        )
        , "_c", "2", "", "")
      ))
- name: Gitaly Apdex calculation from raw metrics with 15 minute offset
  interval: 1m
  partial_response_strategy: abort
  rules:
  - record: raw_metrics_apdex_calculation
    # This is a raw metrics calculation for Gitaly based on its very complex metrics calculations with a 15 minute offset.
    labels:
      type: gitaly
      rate: 1h_offset_15m
    expr: |
     ( sum by (env,environment,stage) (
        label_replace((
          sum by (env,environment,stage) (
            rate(grpc_server_handling_seconds_bucket{grpc_method!~"CalculateChecksum|CommitLanguages|CommitStats|CreateFork|CreateRepositoryFromURL|FetchInternalRemote|FetchIntoObjectPool|FetchRemote|FetchSourceBranch|FindCommit|FindRemoteRepository|FindRemoteRootRef|Fsck|GarbageCollect|GetArchive|LastCommitForPath|OptimizeRepository|PackObjectsHookWithSidechannel|PostReceiveHook|PostUploadPackWithSidechannel|PreReceiveHook|RepackFull|RepackIncremental|ReplicateRepository|RepositorySize|SSHUploadPackWithSidechannel|UpdateHook|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="0.5",type="gitaly"}[1h] offset 15m)
          )
          +
          sum by (env,environment,stage) (
            rate(grpc_server_handling_seconds_bucket{grpc_method!~"CalculateChecksum|CommitLanguages|CommitStats|CreateFork|CreateRepositoryFromURL|FetchInternalRemote|FetchIntoObjectPool|FetchRemote|FetchSourceBranch|FindCommit|FindRemoteRepository|FindRemoteRootRef|Fsck|GarbageCollect|GetArchive|LastCommitForPath|OptimizeRepository|PackObjectsHookWithSidechannel|PostReceiveHook|PostUploadPackWithSidechannel|PreReceiveHook|RepackFull|RepackIncremental|ReplicateRepository|RepositorySize|SSHUploadPackWithSidechannel|UpdateHook|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="1",type="gitaly"}[1h] offset 15m)
          )
        )
        /
        2
        , "_c", "0", "", "")
        or
        label_replace((
          sum by (env,environment,stage) (
            rate(grpc_server_handling_seconds_bucket{grpc_method=~"FindCommit|GetArchive|LastCommitForPath|RepositorySize|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="10",type="gitaly"}[1h] offset 15m)
          )
          +
          sum by (env,environment,stage) (
            rate(grpc_server_handling_seconds_bucket{grpc_method=~"FindCommit|GetArchive|LastCommitForPath|RepositorySize|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="30",type="gitaly"}[1h] offset 15m)
          )
        )
        /
        2
        , "_c", "1", "", "")
        or
        label_replace((
          sum by (env,environment,stage) (
            rate(grpc_server_handling_seconds_bucket{grpc_service="gitaly.OperationService",grpc_type="unary",job="gitaly",le="10",type="gitaly"}[1h] offset 15m)
          )
          +
          sum by (env,environment,stage) (
            rate(grpc_server_handling_seconds_bucket{grpc_service="gitaly.OperationService",grpc_type="unary",job="gitaly",le="30",type="gitaly"}[1h] offset 15m)
          )
        )
        /
        2
        , "_c", "2", "", "")
      ) /
      sum by (env,environment,stage) (
        label_replace(sum by (env,environment,stage) (
          rate(grpc_server_handling_seconds_bucket{grpc_method!~"CalculateChecksum|CommitLanguages|CommitStats|CreateFork|CreateRepositoryFromURL|FetchInternalRemote|FetchIntoObjectPool|FetchRemote|FetchSourceBranch|FindCommit|FindRemoteRepository|FindRemoteRootRef|Fsck|GarbageCollect|GetArchive|LastCommitForPath|OptimizeRepository|PackObjectsHookWithSidechannel|PostReceiveHook|PostUploadPackWithSidechannel|PreReceiveHook|RepackFull|RepackIncremental|ReplicateRepository|RepositorySize|SSHUploadPackWithSidechannel|UpdateHook|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="+Inf",type="gitaly"}[1h] offset 15m)
        )
        , "_c", "0", "", "")
        or
        label_replace(sum by (env,environment,stage) (
          rate(grpc_server_handling_seconds_bucket{grpc_method=~"FindCommit|GetArchive|LastCommitForPath|RepositorySize|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="+Inf",type="gitaly"}[1h] offset 15m)
        )
        , "_c", "1", "", "")
        or
        label_replace(sum by (env,environment,stage) (
          rate(grpc_server_handling_seconds_bucket{grpc_service="gitaly.OperationService",grpc_type="unary",job="gitaly",le="+Inf",type="gitaly"}[1h] offset 15m)
        )
        , "_c", "2", "", "")
      ))
- name: Gitaly Apdex calculation with offset numerator and denominator
  interval: 1m
  partial_response_strategy: abort
  rules:
  - record: offset_apdex_numerator
    # This is a raw metrics calculation for Gitaly based on its very complex metrics calculations.
    labels:
      type: gitaly
      rate: 1h_offset_1m
    expr: |
      sum by (env,environment,stage) (
        label_replace((
          sum by (env,environment,stage) (
            rate(grpc_server_handling_seconds_bucket{grpc_method!~"CalculateChecksum|CommitLanguages|CommitStats|CreateFork|CreateRepositoryFromURL|FetchInternalRemote|FetchIntoObjectPool|FetchRemote|FetchSourceBranch|FindCommit|FindRemoteRepository|FindRemoteRootRef|Fsck|GarbageCollect|GetArchive|LastCommitForPath|OptimizeRepository|PackObjectsHookWithSidechannel|PostReceiveHook|PostUploadPackWithSidechannel|PreReceiveHook|RepackFull|RepackIncremental|ReplicateRepository|RepositorySize|SSHUploadPackWithSidechannel|UpdateHook|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="0.5",type="gitaly"}[1h] offset 1m)
          )
          +
          sum by (env,environment,stage) (
            rate(grpc_server_handling_seconds_bucket{grpc_method!~"CalculateChecksum|CommitLanguages|CommitStats|CreateFork|CreateRepositoryFromURL|FetchInternalRemote|FetchIntoObjectPool|FetchRemote|FetchSourceBranch|FindCommit|FindRemoteRepository|FindRemoteRootRef|Fsck|GarbageCollect|GetArchive|LastCommitForPath|OptimizeRepository|PackObjectsHookWithSidechannel|PostReceiveHook|PostUploadPackWithSidechannel|PreReceiveHook|RepackFull|RepackIncremental|ReplicateRepository|RepositorySize|SSHUploadPackWithSidechannel|UpdateHook|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="1",type="gitaly"}[1h] offset 1m)
          )
        )
        /
        2
        , "_c", "0", "", "")
        or
        label_replace((
          sum by (env,environment,stage) (
            rate(grpc_server_handling_seconds_bucket{grpc_method=~"FindCommit|GetArchive|LastCommitForPath|RepositorySize|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="10",type="gitaly"}[1h] offset 1m)
          )
          +
          sum by (env,environment,stage) (
            rate(grpc_server_handling_seconds_bucket{grpc_method=~"FindCommit|GetArchive|LastCommitForPath|RepositorySize|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="30",type="gitaly"}[1h] offset 1m)
          )
        )
        /
        2
        , "_c", "1", "", "")
        or
        label_replace((
          sum by (env,environment,stage) (
            rate(grpc_server_handling_seconds_bucket{grpc_service="gitaly.OperationService",grpc_type="unary",job="gitaly",le="10",type="gitaly"}[1h] offset 1m)
          )
          +
          sum by (env,environment,stage) (
            rate(grpc_server_handling_seconds_bucket{grpc_service="gitaly.OperationService",grpc_type="unary",job="gitaly",le="30",type="gitaly"}[1h] offset 1m)
          )
        )
        /
        2
        , "_c", "2", "", "")
      )
  - record: offset_apdex_denominator
    # This is a raw metrics calculation for Gitaly based on its very complex metrics calculations.
    labels:
      type: gitaly
      rate: 1h_offset_1m
    expr: |
      sum by (env,environment,stage) (
        label_replace(sum by (env,environment,stage) (
          rate(grpc_server_handling_seconds_bucket{grpc_method!~"CalculateChecksum|CommitLanguages|CommitStats|CreateFork|CreateRepositoryFromURL|FetchInternalRemote|FetchIntoObjectPool|FetchRemote|FetchSourceBranch|FindCommit|FindRemoteRepository|FindRemoteRootRef|Fsck|GarbageCollect|GetArchive|LastCommitForPath|OptimizeRepository|PackObjectsHookWithSidechannel|PostReceiveHook|PostUploadPackWithSidechannel|PreReceiveHook|RepackFull|RepackIncremental|ReplicateRepository|RepositorySize|SSHUploadPackWithSidechannel|UpdateHook|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="+Inf",type="gitaly"}[1h] offset 1m)
        )
        , "_c", "0", "", "")
        or
        label_replace(sum by (env,environment,stage) (
          rate(grpc_server_handling_seconds_bucket{grpc_method=~"FindCommit|GetArchive|LastCommitForPath|RepositorySize|WriteRef",grpc_service!="gitaly.OperationService",grpc_type="unary",job="gitaly",le="+Inf",type="gitaly"}[1h] offset 1m)
        )
        , "_c", "1", "", "")
        or
        label_replace(sum by (env,environment,stage) (
          rate(grpc_server_handling_seconds_bucket{grpc_service="gitaly.OperationService",grpc_type="unary",job="gitaly",le="+Inf",type="gitaly"}[1h] offset 1m)
        )
        , "_c", "2", "", "")
      )
  - record: offset_apdex_calculation
    labels:
      type: gitaly
      rate: 1h_offset_1m
    expr: |
      offset_apdex_numerator{type="gitaly", rate="1h_offset_1m"}
      /
      offset_apdex_denominator{type="gitaly", rate="1h_offset_1m"}
  - record: offset_apdex_calculation
    labels:
      type: gitaly
      rate: 1h_double_offset_1m
    expr: |
      offset_apdex_numerator{type="gitaly", rate="1h_offset_1m"} offset 1m
      /
      offset_apdex_denominator{type="gitaly", rate="1h_offset_1m"} offset 1m

- name: web raw metrics apdex calculation
  interval: 1m
  partial_response_strategy: abort
  rules:
  - record: raw_metrics_apdex_calculation
    # This is a raw metrics calculation for Gitaly based on its very complex metrics calculations.
    labels:
      type: web
      rate: 1h_offset_1m
    expr: |
      sum by (env, environment, stage)
         (sum by (endpoint_id,environment,job,search_level,search_scope,search_type,shard,stage,tier,type) (
            rate(gitlab_sli_rails_request_apdex_success_total{environment="gprd", type="web"}[1h] offset 1m)
        )
       )
       /
       sum by (env, environment, stage) (sum by (endpoint_id,environment,feature_category,job,request_urgency,shard,stage,tier,type) (
        rate(gitlab_sli_rails_request_total{environment="gprd", type="web"}[1h] offset 1m)))
- name: web Apdex calculation with offset numerator and denominator
  interval: 1m
  partial_response_strategy: abort
  rules:
  - record: offset_apdex_numerator
    # This is a raw metrics calculation for web based on its very complex metrics calculations.
    labels:
      type: web
      rate: 1h_offset_1m
    expr: |
      sum by (env, environment, stage)
         (sum by (endpoint_id,environment,job,search_level,search_scope,search_type,shard,stage,tier,type) (
            rate(gitlab_sli_rails_request_apdex_success_total{environment="gprd", type="web"}[1h] offset 1m)))
  - record: offset_apdex_denominator
    # This is a raw metrics calculation for web based on its very complex metrics calculations.
    labels:
      type: web
      rate: 1h_offset_1m
    expr: |
      sum by (env, environment, stage) (sum by (endpoint_id,environment,feature_category,job,request_urgency,shard,stage,tier,type) (
        rate(gitlab_sli_rails_request_total{environment="gprd", type="web"}[1h] offset 1m)))
  - record: offset_apdex_calculation
    labels:
      type: web
      rate: 1h_offset_1m
    expr: |
      offset_apdex_numerator{type="web", rate="1h_offset_1m"}
      /
      offset_apdex_denominator{type="web", rate="1h_offset_1m"}
  - record: offset_apdex_calculation
    labels:
      type: web
      rate: 1h_double_offset_1m
    expr: |
      offset_apdex_numerator{type="web", rate="1h_offset_1m"} offset 1m
      /
      offset_apdex_denominator{type="web", rate="1h_offset_1m"} offset 1m
- name: redis ratelimiting raw metrics apdex calculation
  interval: 1m
  partial_response_strategy: abort
  rules:
  - record: raw_metrics_apdex_calculation
    # Copied from the prometheus recording rule "gitlab_component_apdex:success:rate_1h" defined in rules/autogenerated-key-metrics-redis-cluster-ratelimiting.yml.
    # Additional label filters were added to limit the experiment's scope and overhead:
    #   env="gprd"
    labels:
      type: redis-ratelimiting
      rate: 1h
    expr: |
      sum by (env,environment,tier,type,stage) (
        (
          (
            sum by (environment) (
              rate(gitlab_redis_client_requests_duration_seconds_bucket{le="0.5",storage="rate_limiting",env="gprd",monitor!="global",stage="main"}[1h])
            )
            +
            sum by (environment) (
              rate(gitlab_redis_client_requests_duration_seconds_bucket{le="0.75",storage="rate_limiting",env="gprd",monitor!="global",stage="main"}[1h])
            )
          )
          /
          2
        ) >= 0
      )
      /
      sum by (env,environment,tier,type,stage) (
        (
          sum by (environment) (
            rate(gitlab_redis_client_requests_duration_seconds_bucket{le="+Inf",storage="rate_limiting",env="gprd",monitor!="global",stage="main"}[1h])
          )
          >= 0
        )
      )
