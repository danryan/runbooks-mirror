# All of these are experimental apdex recordings to get better information for https://gitlab.com/gitlab-com/gl-infra/scalability/-/issues/2478.

groups:
- name: experimental web Apdex calculation with offset numerator and denominator in same transaction
  interval: 1m
  partial_response_strategy: abort
  rules:
  - record: offset_apdex_numerator_and_denominator
    # This is a raw metrics calculation for Gitaly based on its very complex metrics calculations.
    labels:
      type: web
      rate: 1h_offset_30s
    expr: |
      label_replace(
        sum by (env, environment, stage)
          (sum by (endpoint_id,environment,job,search_level,search_scope,search_type,shard,stage,tier,type) (
            rate(gitlab_sli_rails_request_apdex_success_total{environment="gprd", type="web"}[1h] offset 30s))),
        'ratio_part', 'numerator', '', '')
      or
      label_replace(
        sum by (env, environment, stage) (sum by (endpoint_id,environment,feature_category,job,request_urgency,shard,stage,tier,type) (
        rate(gitlab_sli_rails_request_total{environment="gprd", type="web"}[1h] offset 30s))),
        'ratio_part', 'denominator', '', '')
  - record: offset_apdex_calculation
    labels:
      type: web
      rate: 1h_double_offset_30s_with_transactionally_consistent_inputs
    expr: |
      sum without (ratio_part) (offset_apdex_numerator_and_denominator{type="web", rate="1h_offset_30s", ratio_part="numerator"} offset 30s)
      /
      sum without (ratio_part) (offset_apdex_numerator_and_denominator{type="web", rate="1h_offset_30s", ratio_part="denominator"} offset 30s)

- name: experimental web intermediate recording rules with offset
  interval: 1m
  partial_response_strategy: abort
  rules:
  - record: offset_experiment:gitlab_service_apdex:ratio_1h
    labels:
      experiment: "thanos_only_offset"
    expr: |
      sum by (env,environment,tier,type,stage,component) (
        (gitlab_component_apdex:success:rate_1h{env="gprd",monitor!="global", type="web", component="rails_request"} offset 30s >= 0)
      )
      /
      sum by (env,environment,tier,type,stage,component) (
        (gitlab_component_apdex:weight:score_1h{env="gprd",monitor!="global", type="web", component="rails_request"} offset 30s >= 0)
      )
  - record: offset_experiment:gitlab_component_apdex:ratio_1h
    labels:
      experiment: "thanos_and_prometheus_offset"
    expr: |
      sum by (env,environment,tier,type,stage,component) (
        (offset_experiment:gitlab_component_apdex:success:rate_1h{env="gprd",monitor!="global", type="web", component="rails_request"} offset 30s >= 0)
      )
      /
      sum by (env,environment,tier,type,stage,component) (
        (offset_experiment:gitlab_component_apdex:weight:score_1h{env="gprd",monitor!="global", type="web", component="rails_request"} offset 30s >= 0)
      )

  - record: offset_experiment:gitlab_component_apdex:ratio_1h
    labels:
      experiment: "prometheus_only_offset"
    expr: |
      sum by (env,environment,tier,type,stage,component) (
        (offset_experiment:gitlab_component_apdex:success:rate_1h{env="gprd",monitor!="global", type="web", component="rails_request"} >= 0)
      )
      /
      sum by (env,environment,tier,type,stage,component) (
        (offset_experiment:gitlab_component_apdex:weight:score_1h{env="gprd",monitor!="global", type="web", component="rails_request"} >= 0)
      )
