# WARNING. DO NOT EDIT THIS FILE BY HAND. USE ./thanos-rules-jsonnet/sla-rules.jsonnet TO GENERATE IT
# YOUR CHANGES WILL BE OVERRIDDEN
groups:
- name: SLA weight calculations
  interval: 1m
  partial_response_strategy: warn
  rules:
  - record: sla:gitlab:ratio
    labels:
      sla_type: internal.v2
    expr: |
      sum by (environment, env, stage) (
        min without(slo) (avg_over_time(slo_observation_status{type="api", monitor="global"}[5m])) * 5
        or
        min without(slo) (avg_over_time(slo_observation_status{type="ci-runners", monitor="global"}[5m])) * 3
        or
        min without(slo) (avg_over_time(slo_observation_status{type="git", monitor="global"}[5m])) * 5
        or
        min without(slo) (avg_over_time(slo_observation_status{type="registry", monitor="global"}[5m])) * 1
        or
        min without(slo) (avg_over_time(slo_observation_status{type="sidekiq", monitor="global"}[5m])) * 2
        or
        min without(slo) (avg_over_time(slo_observation_status{type="web", monitor="global"}[5m])) * 5
      )
      /
      sum by (environment, env, stage) (
        max without(slo) (clamp_max(clamp_min(slo_observation_status{type="api", monitor="global"}, 1), 1)) * 5
        or
        max without(slo) (clamp_max(clamp_min(slo_observation_status{type="ci-runners", monitor="global"}, 1), 1)) * 3
        or
        max without(slo) (clamp_max(clamp_min(slo_observation_status{type="git", monitor="global"}, 1), 1)) * 5
        or
        max without(slo) (clamp_max(clamp_min(slo_observation_status{type="registry", monitor="global"}, 1), 1)) * 1
        or
        max without(slo) (clamp_max(clamp_min(slo_observation_status{type="sidekiq", monitor="global"}, 1), 1)) * 2
        or
        max without(slo) (clamp_max(clamp_min(slo_observation_status{type="web", monitor="global"}, 1), 1)) * 5
      )
  - record: sla:gitlab:ratio
    labels:
      sla_type: external.v1
    expr: |
      sum by (environment, env) (
        avg by (environment, env, type) (gitlab_service_external_availability:ratio_5m{type="api", monitor!="global"}) * 5
        or
        avg by (environment, env, type) (gitlab_service_external_availability:ratio_5m{type="ci-runners", monitor!="global"}) * 3
        or
        avg by (environment, env, type) (gitlab_service_external_availability:ratio_5m{type="git", monitor!="global"}) * 5
        or
        avg by (environment, env, type) (gitlab_service_external_availability:ratio_5m{type="registry", monitor!="global"}) * 1
        or
        avg by (environment, env, type) (gitlab_service_external_availability:ratio_5m{type="sidekiq", monitor!="global"}) * 2
        or
        avg by (environment, env, type) (gitlab_service_external_availability:ratio_5m{type="web", monitor!="global"}) * 5
      )
      /
      sum by (environment, env) (
        max by (environment, env, type) (clamp_max(clamp_min(gitlab_service_external_availability:ratio_5m{type="api", monitor!="global"}, 1), 1)) * 5
        or
        max by (environment, env, type) (clamp_max(clamp_min(gitlab_service_external_availability:ratio_5m{type="ci-runners", monitor!="global"}, 1), 1)) * 3
        or
        max by (environment, env, type) (clamp_max(clamp_min(gitlab_service_external_availability:ratio_5m{type="git", monitor!="global"}, 1), 1)) * 5
        or
        max by (environment, env, type) (clamp_max(clamp_min(gitlab_service_external_availability:ratio_5m{type="registry", monitor!="global"}, 1), 1)) * 1
        or
        max by (environment, env, type) (clamp_max(clamp_min(gitlab_service_external_availability:ratio_5m{type="sidekiq", monitor!="global"}, 1), 1)) * 2
        or
        max by (environment, env, type) (clamp_max(clamp_min(gitlab_service_external_availability:ratio_5m{type="web", monitor!="global"}, 1), 1)) * 5
      )
