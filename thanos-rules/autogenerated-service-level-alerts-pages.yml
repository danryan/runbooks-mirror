# WARNING. DO NOT EDIT THIS FILE BY HAND. USE ./thanos-rules-jsonnet/service-component-alerts.jsonnet TO GENERATE IT
# YOUR CHANGES WILL BE OVERRIDDEN
groups:
- name: 'Service Component Alerts: pages'
  interval: 1m
  partial_response_strategy: warn
  rules:
  - alert: PagesServiceLoadbalancerErrorSLOViolation
    for: 2m
    annotations:
      title: >-
        The loadbalancer SLI of the pages service (`{{ $labels.stage }}` stage) has an error rate violating
        SLO
      description: |
        This SLI models requests passing through the loadbalancer in front of the pages service. 5xx requests for unencrypted HTTP traffic, and connection errors (not 5xx requests) for HTTPS traffic are considered to be errors. The loadbalancer is unable to determine the status code of HTTPS traffic as it passes through the loadbalancer encrypted.

        Currently the error-rate is {{ $value | humanizePercentage }}.
      grafana_dashboard_id: pages-main/pages-overview
      grafana_dashboard_link: >-
        https://dashboards.gitlab.net/d/pages-main/pages-overview?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}
      grafana_min_zoom_hours: '6'
      grafana_panel_id: '51400'
      grafana_variables: environment,stage
      link1_title: Definition
      link1_url: >-
        https://gitlab.com/gitlab-com/runbooks/blob/master/docs/uncategorized/definition-service-error-rate.md
      promql_template_1: >-
        gitlab_component_errors:ratio_5m{environment="$environment", type="$type", stage="$stage", component="$component"}
      runbook: docs/{{ $labels.type }}/README.md
    labels:
      alert_type: symptom
      feature_category: pages
      pager: pagerduty
      product_stage: release
      product_stage_group: release
      rules_domain: general
      severity: s2
      slo_alert: 'yes'
    expr: |
      (
        (
          gitlab_component_errors:ratio_1h{component="loadbalancer",monitor="global",type="pages"}
          > (14.4 * 0.000100)
        )
        and
        (
          gitlab_component_errors:ratio_5m{component="loadbalancer",monitor="global",type="pages"}
          > (14.4 * 0.000100)
        )
        or
        (
          gitlab_component_errors:ratio_6h{component="loadbalancer",monitor="global",type="pages"}
          > (6 * 0.000100)
        )
        and
        (
          gitlab_component_errors:ratio_30m{component="loadbalancer",monitor="global",type="pages"}
          > (6 * 0.000100)
        )
      )
      and on(env,environment,tier,type,stage,component)
      (
        sum by(env,environment,tier,type,stage,component) (gitlab_component_ops:rate_1h{component="loadbalancer",monitor="global",type="pages"}) >= 1
      )
