# WARNING. DO NOT EDIT THIS FILE BY HAND. USE ./mimir-rules-jsonnet/service-anomaly-detection.jsonnet TO GENERATE IT
# YOUR CHANGES WILL BE OVERRIDDEN
groups:
- name: 'topology-service ops rate weekly statistics: {"type": "topology-service"}'
  interval: 5m
  rules:
  - record: gitlab_service_ops:rate:avg_over_time_1w
    expr: |
      avg_over_time(gitlab_service_ops:rate_5m{monitor="global",type="topology-service"}[1w])
      unless on(tier, type)
      gitlab_service:mapping:disable_ops_rate_prediction{monitor="global",type="topology-service"}
  - record: gitlab_service_ops:rate:stddev_over_time_1w
    expr: |
      stddev_over_time(gitlab_service_ops:rate_5m{monitor="global",type="topology-service"}[1w])
      unless on(tier, type)
      gitlab_service:mapping:disable_ops_rate_prediction{monitor="global",type="topology-service"}
- name: 'topology-service ops rate weekly prediction values: {"type": "topology-service"}'
  interval: 5m
  rules:
  - record: gitlab_service_ops:rate:prediction
    expr: |
      quantile(0.5,
        label_replace(
          gitlab_service_ops:rate_1h{monitor="global",type="topology-service"} offset 10050m # 1 week - 30mins
          + delta(gitlab_service_ops:rate:avg_over_time_1w{monitor="global",type="topology-service"}[1w])
          , "p", "1w", "", "")
        or
        label_replace(
          gitlab_service_ops:rate_1h{monitor="global",type="topology-service"} offset 20130m # 2 weeks - 30mins
          + delta(gitlab_service_ops:rate:avg_over_time_1w{monitor="global",type="topology-service"}[2w])
          , "p", "2w", "", "")
        or
        label_replace(
          gitlab_service_ops:rate_1h{monitor="global",type="topology-service"} offset 30210m # 3 weeks - 30mins
          + delta(gitlab_service_ops:rate:avg_over_time_1w{monitor="global",type="topology-service"}[3w])
          , "p", "3w", "", "")
      )
      without (p)
- name: 'topology-service apdex success rate weekly statistics: {"type": "topology-service"}'
  interval: 5m
  rules:
  - record: gitlab_service_apdex:success:rate:avg_over_time_1w
    expr: |
      avg_over_time(gitlab_service_apdex:success:rate_5m{monitor="global",type="topology-service"}[1w])
      unless on(tier, type)
      gitlab_service:mapping:disable_apdex_success_rate_prediction{monitor="global",type="topology-service"}
  - record: gitlab_service_apdex:success:rate:stddev_over_time_1w
    expr: |
      stddev_over_time(gitlab_service_apdex:success:rate_5m{monitor="global",type="topology-service"}[1w])
      unless on(tier, type)
      gitlab_service:mapping:disable_apdex_success_rate_prediction{monitor="global",type="topology-service"}
- name: 'topology-service apdex success rate weekly prediction values: {"type": "topology-service"}'
  interval: 5m
  rules:
  - record: gitlab_service_apdex:success:rate:prediction
    expr: |
      quantile(0.5,
        label_replace(
          gitlab_service_apdex:success:rate_1h{monitor="global",type="topology-service"} offset 10050m # 1 week - 30mins
          + delta(gitlab_service_apdex:success:rate:avg_over_time_1w{monitor="global",type="topology-service"}[1w])
          , "p", "1w", "", "")
        or
        label_replace(
          gitlab_service_apdex:success:rate_1h{monitor="global",type="topology-service"} offset 20130m # 2 weeks - 30mins
          + delta(gitlab_service_apdex:success:rate:avg_over_time_1w{monitor="global",type="topology-service"}[2w])
          , "p", "2w", "", "")
        or
        label_replace(
          gitlab_service_apdex:success:rate_1h{monitor="global",type="topology-service"} offset 30210m # 3 weeks - 30mins
          + delta(gitlab_service_apdex:success:rate:avg_over_time_1w{monitor="global",type="topology-service"}[3w])
          , "p", "3w", "", "")
      )
      without (p)
