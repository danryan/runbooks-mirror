groups:
- name: gcp-snapshots.rules
  rules:
  - record: gcp_scheduled_snapshot:occurrence
    expr: |
      clamp_max(stackdriver_gce_disk_logging_googleapis_com_user_scheduled_snapshots + 1, 1)
  - alert: GCPScheduledSnapshotsDelayed
    expr: |
      max(
        increase(gcp_scheduled_snapshot:occurrence{env="gprd"}[12h])
      ) by (disk_name, environment) == 0
        and on (disk_name, environment)
      present_over_time(stackdriver_gce_disk_logging_googleapis_com_user_scheduled_snapshots{env="gprd"}[7d]) == 1
    for: 4h
    labels:
      severity: s4
      alert_type: cause
    annotations:
      grafana_datasource_id: mimir-gitlab-gprd
      description: Recent GCP scheduled snapshot are missing for {{ $labels.disk_name }}. Please follow the runbook to review the problem.
      runbook: docs/disaster-recovery/alerts/GCPScheduledSnapshots.md
      title: GCP scheduled snapshots are delayed
  - alert: GCPScheduledSnapshotsFailed
    expr: |
      count by (env)(stackdriver_gce_disk_logging_googleapis_com_user_scheduled_snapshots_errors{env="gprd"}) >= 1
    for: 1m
    labels:
      pager: pagerduty
      severity: s1
      alert_type: cause
    annotations:
      grafana_datasource_id: mimir-gitlab-gprd
      description: GCP scheduled snapshots are reporting failures for {{ $labels.env }}. Please follow the runbook to review the problem.
      runbook: docs/disaster-recovery/alerts/GCPScheduledSnapshots.md
      title: GCP scheduled snapshots are failing
