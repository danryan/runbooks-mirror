image: registry.gitlab.com/gitlab-com/runbooks:2.2.0

stages:
  - test
  - deploy

test:
  script:
    - scripts/validate-service-mappings
    - find . -name \*.y*ml | xargs yaml-lint
    - /prometheus/promtool check rules rules/*.yml
    # Prometheus config checks are stricter than rules checks, so use a fake config to check this too
    - /prometheus/promtool check config scripts/prometheus.yml
    - scripts/validate_kibana_urls
    - scripts/validate-alerts

deploy_elastic_watcher_updates:
  stage: deploy
  image: alpine:latest
  before_script:
  - apk add --no-cache curl bash
  script:
  - elastic-watcher/update-alerts.sh
  only:
    refs:
      - master
    variables:
      - $ES_URL

dryrun_pingdom_checks:
  image: golang:1.11
  script:
    - cd pingdom
    - go run pingdom.go --dry-run
  except:
    refs:
      - master

deploy_pingdom_checks:
  image: golang:1.11
  script:
    - cd pingdom
    - go run pingdom.go
  only:
    refs:
      - master
    variables:
      - $PINGDOM_APPKEY
