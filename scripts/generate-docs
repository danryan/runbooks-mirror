#!/usr/bin/env ruby

require 'yaml'
require 'erb'
require 'ostruct'

START_MARKER="<!-- MARKER: do not edit this section directly. Edit services/service-mappings.yml then run scripts/generate-docs -->"
STOP_MARKER="<!-- END_MARKER -->"
def generate_header(service, team, tier)
  template = <<~EOF
    #{START_MARKER}
    #  <%= service["name"].capitalize %> Service

    * **Responsible Team**: [<%= team["name"] %>](<%= team["url"] %>)
    * **Slack Channel**: [\#<%= team["slack_channel"] %>](https://gitlab.slack.com/archives/production/<%= team["slack_channel"] %>)
    <% if service["sentry_slug"] -%>
    * **Sentry**: https://sentry.gitlap.com/<%= service["sentry_slug"] %>
    <% end -%>
    <% if service["grafana_folder"] -%>
    * **Grafana Folder**: https://dashboards.gitlab.net/dashboards/f/<%= service["grafana_folder"] %>
    <% end -%>
    <% if service["elk"] -%>
    * **ELK**: [`<%= service["elk"]["index"] %>`](<%= service["elk"]["permalink"] %>)
    <% end -%>
    #{STOP_MARKER}
  EOF

  ERB.new(template, 0, "<>-").result(OpenStruct.new({ team: team, service: service, tier: tier }).instance_eval { binding })
end

def generate_docs()
  service_mapping_yaml = YAML.load_file(File.join(__dir__, "..", "services", "service-mappings.yml"))
  services = service_mapping_yaml["services"]

  team_map = service_mapping_yaml["teams"].inject({}) { |map, team| map[team["name"]] = team; map }
  tier_map = service_mapping_yaml["tiers"].inject({}) { |map, tier| map[tier["name"]] = tier; map }
  service_map = service_mapping_yaml["services"].inject({}) { |map, service| map[service["name"]] = service; map }

  services.each do |service|
    service_name = service["name"]
    team = team_map[service["team"]]
    tier = tier_map[service["tier"]]

    troubleshooting_doc =  File.join(__dir__, "..", "troubleshooting", "service-#{service_name}.md")
    details = generate_header(service, team, tier)
    if File.exist?(troubleshooting_doc)
    else
      File.write(troubleshooting_doc, details)
    end
  end

  Dir.glob(File.join(__dir__, "..", "troubleshooting", "service-*.md")).each do |file|
    referred_service_name = File.basename(file, ".md").sub("service-","")
    if !service_map[referred_service_name]
      File.delete(file)
    end
  end
end

begin
  generate_docs()
rescue StandardError => e
  STDERR.puts "error: #{e.message}"
  exit 1
end
